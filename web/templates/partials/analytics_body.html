{{ define "analytics_body" }}
{{ $gtm := .Analytics.GTMContainerID }}
{{ $ga := .Analytics.GA4MeasurementID }}
{{ $segment := .Analytics.SegmentWriteKey }}
{{ $debug := .Analytics.Debug }}
{{ if $gtm }}
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ $gtm }}" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
{{ end }}
<script>
(function(){
  var VERSION = 'v1';
  var STORAGE_KEY = 'hanko:consent:' + VERSION;
  var COOKIE_NAME = 'hanko_consent';
  var DEFAULT_STATE = { analytics: false, marketing: false, functional: true };
  var global = window;
  var consent = global.hankoConsent = global.hankoConsent || {};
  var existing = Array.isArray(consent._listeners) ? consent._listeners : [];
  var listeners = existing;
  var state = Object.assign({}, DEFAULT_STATE);
  var choiceRecorded = false;

  function parse(raw){
    if (!raw) { return null; }
    try { return JSON.parse(raw); } catch(_) { return null; }
  }

  function readLocal(){
    try {
      if (global.localStorage) {
        return global.localStorage.getItem(STORAGE_KEY);
      }
    } catch(_) {}
    return null;
  }

  function readCookie(){
    try {
      var pattern = new RegExp('(?:^|;\\s*)' + COOKIE_NAME.replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&') + '=([^;]*)');
      var match = document.cookie.match(pattern);
      return match ? decodeURIComponent(match[1]) : null;
    } catch(_) {}
    return null;
  }

  (function hydrateFromStorage(){
    var stored = parse(readLocal()) || parse(readCookie());
    if (stored) {
      if (typeof stored.analytics === 'boolean') {
        state.analytics = stored.analytics;
        choiceRecorded = true;
      }
      if (typeof stored.marketing === 'boolean') {
        state.marketing = stored.marketing;
      }
    }
  })();

  function stateCopy(){
    return {
      analytics: !!state.analytics,
      marketing: !!state.marketing,
      functional: true
    };
  }

  function persist(){
    var payload = {
      analytics: !!state.analytics,
      marketing: !!state.marketing,
      functional: true,
      version: VERSION,
      ts: Date.now()
    };
    var raw = JSON.stringify(payload);
    try {
      if (global.localStorage) {
        global.localStorage.setItem(STORAGE_KEY, raw);
      }
    } catch(_) {}
    try {
      var expires = new Date(Date.now() + 31536e6); // 1 year
      var cookie = COOKIE_NAME + '=' + encodeURIComponent(raw) + '; path=/; expires=' + expires.toUTCString() + '; SameSite=Lax';
      if (location.protocol === 'https:') { cookie += '; Secure'; }
      document.cookie = cookie;
    } catch(_) {}
  }

  function notify(category){
    listeners.slice().forEach(function(fn){
      try { fn(category, state[category], stateCopy()); } catch(_) {}
    });
  }

  function setMany(values){
    if (!values || typeof values !== 'object') { return; }
    var touched = false;
    Object.keys(values).forEach(function(key){
      if (!Object.prototype.hasOwnProperty.call(state, key)) { return; }
      touched = true;
      var next = !!values[key];
      if (key === 'analytics') {
        choiceRecorded = true;
      }
      if (state[key] !== next) {
        state[key] = next;
        notify(key);
      }
    });
    if (touched) {
      persist();
    }
  }

  function set(category, value){
    if (!category) { return; }
    var payload = {};
    payload[category] = value;
    setMany(payload);
  }

  function allowed(category){
    if (category === 'functional') { return true; }
    if (Object.prototype.hasOwnProperty.call(state, category)) {
      return !!state[category];
    }
    return false;
  }

  function onChange(fn){
    if (typeof fn === 'function') {
      listeners.push(fn);
    }
  }

  consent._listeners = listeners;
  consent.allowed = allowed;
  consent.get = function(key){ return stateCopy()[key]; };
  consent.state = stateCopy;
  consent.set = set;
  consent.setMany = setMany;
  consent.batchSet = setMany;
  consent.onChange = onChange;
  consent.ready = function(){ return true; };
  consent.hasChoice = function(){ return choiceRecorded; };
  consent.version = VERSION;

  document.dispatchEvent(new CustomEvent('hanko:consent-ready', { detail: { state: stateCopy(), choice: choiceRecorded } }));
})();
</script>
<script>
(function(){
  var GA_ID = {{ if $ga }}'{{ $ga }}'{{ else }}''{{ end }};
  var GTM_ID = {{ if $gtm }}'{{ $gtm }}'{{ else }}''{{ end }};
  var SEGMENT_KEY = {{ if $segment }}'{{ $segment }}'{{ else }}''{{ end }};
  var DEBUG = {{ if $debug }}true{{ else }}false{{ end }};
  var global = window;
  var loaded = { gtag: false, gtm: false, segment: false };

  function log(){
    if (DEBUG && global.console && typeof global.console.log === 'function') {
      try { global.console.log.apply(global.console, arguments); } catch(_) {}
    }
  }

  function loadScript(src, attrs){
    if (!src) { return; }
    var doc = global.document;
    if (doc.querySelector('script[data-hanko-src=\"' + src + '\"]')) { return; }
    var s = doc.createElement('script');
    s.async = true;
    s.src = src;
    s.setAttribute('data-hanko-src', src);
    if (attrs) {
      Object.keys(attrs).forEach(function(k){ s.setAttribute(k, attrs[k]); });
    }
    var first = doc.getElementsByTagName('script')[0];
    if (first && first.parentNode) {
      first.parentNode.insertBefore(s, first);
    } else {
      (doc.head || doc.documentElement).appendChild(s);
    }
  }

  function loadGA(){
    if (!GA_ID || loaded.gtag) { return; }
    global.dataLayer = global.dataLayer || [];
    global.gtag = global.gtag || function(){ global.dataLayer.push(arguments); };
    loadScript('https://www.googletagmanager.com/gtag/js?id=' + GA_ID);
    global.gtag('js', new Date());
    global.gtag('config', GA_ID, { send_page_view: false });
    loaded.gtag = true;
    log('[analytics] loaded gtag', GA_ID);
  }

  function loadGTM(){
    if (!GTM_ID || loaded.gtm) { return; }
    (function(w,d,s,l,i){
      w[l]=w[l]||[];
      w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0];
      var j=d.createElement(s);
      var dl=l!='dataLayer'?'&l='+l:'';
      j.async=true;
      j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
      j.setAttribute('data-hanko-src','gtm:'+i);
      f.parentNode.insertBefore(j,f);
    })(global, global.document, 'script', 'dataLayer', GTM_ID);
    loaded.gtm = true;
    log('[analytics] loaded gtm', GTM_ID);
  }

  function loadSegment(){
    if (!SEGMENT_KEY || loaded.segment) { return; }
    !function(){var analytics=global.analytics=global.analytics||[];if(!analytics.initialize)if(analytics.invoked)global.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}},analytics.methods.forEach(function(e){analytics[e]=analytics.factory(e)}),analytics.load=function(e){var t=global.document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-hanko-src","segment:"+e);t.src="https://cdn.segment.com/analytics.js/v1/"+e+"/analytics.min.js";var n=global.document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n)},analytics.SNIPPET_VERSION="4.15.3";analytics.load(SEGMENT_KEY)}}();
    loaded.segment = true;
    log('[analytics] loaded segment', SEGMENT_KEY);
  }

  function hydrate(){
    if (!global.hankoConsent || !global.hankoConsent.allowed('analytics')) {
      log('[analytics] consent not granted; skip loaders');
      return;
    }
    loadGA();
    loadGTM();
    loadSegment();
  }

  function ensureReady(cb){
    if (global.hankoConsent && global.hankoConsent.ready && global.hankoConsent.ready()) {
      cb();
    } else {
      document.addEventListener('hanko:consent-ready', function(){ cb(); }, { once: true });
    }
  }

  ensureReady(function(){
    hydrate();
    if (global.hankoConsent && typeof global.hankoConsent.onChange === 'function') {
      global.hankoConsent.onChange(function(key, value){
        if (key === 'analytics' && value) {
          hydrate();
          if (global.hankoAnalytics && typeof global.hankoAnalytics.pageView === 'function') {
            global.hankoAnalytics.pageView();
          }
        }
      });
    }
  });

  global.hankoAnalyticsLoaders = { loadGA: loadGA, loadGTM: loadGTM, loadSegment: loadSegment };
})();
</script>
<script>
(function(){
  var DEBUG = {{ if $debug }}true{{ else }}false{{ end }};

  function log(){
    if (DEBUG && window.console && typeof window.console.log === 'function') {
      try { window.console.log.apply(window.console, arguments); } catch(_) {}
    }
  }

  function allowed(){
    return window.hankoConsent && window.hankoConsent.allowed('analytics');
  }

  function pageView(){
    if (!allowed()) { log('[analytics] blocked by consent'); return; }
    var path = location.pathname + location.search;
    var title = document.title || '';
    if (typeof window.gtag === 'function') {
      window.gtag('event', 'page_view', { page_location: location.href, page_path: path, page_title: title });
      log('[analytics] gtag page_view', path);
    }
    if (window.analytics && typeof window.analytics.page === 'function') {
      window.analytics.page({ path: path, title: title, url: location.href });
      log('[analytics] segment page', path);
    }
  }

  function track(name, props){
    if (!allowed()) { log('[analytics] blocked by consent'); return; }
    props = props || {};
    if (typeof window.gtag === 'function') {
      window.gtag('event', name, props);
      log('[analytics] gtag event', name, props);
    }
    if (window.analytics && typeof window.analytics.track === 'function') {
      window.analytics.track(name, props);
      log('[analytics] segment event', name, props);
    }
  }

  window.hankoAnalytics = { pageView: pageView, track: track };

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(pageView, 0);
  } else {
    document.addEventListener('DOMContentLoaded', pageView);
  }

  document.body.addEventListener('htmx:afterSettle', function(){ pageView(); });

  document.addEventListener('click', function(e){
    var target = e.target && e.target.closest('[data-analytics-click]');
    if (!target) { return; }
    var name = target.getAttribute('data-analytics-click') || 'click';
    var props = {};
    var dataset = target.dataset || {};
    Object.keys(dataset).forEach(function(key){
      if (key.indexOf('analyticsProp') === 0) {
        props[key.substring('analyticsProp'.length).toLowerCase()] = dataset[key];
      }
    });
    track(name, props);
  }, true);

  function bindConsent(){
    if (!window.hankoConsent || typeof window.hankoConsent.onChange !== 'function') { return; }
    window.hankoConsent.onChange(function(key, value){
      if (key === 'analytics' && value) {
        pageView();
      }
    });
  }

  if (window.hankoConsent && window.hankoConsent.ready && window.hankoConsent.ready()) {
    bindConsent();
  } else {
    document.addEventListener('hanko:consent-ready', bindConsent, { once: true });
  }
})();
</script>
{{ end }}
