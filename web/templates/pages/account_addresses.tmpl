{{ define "content" }}
{{ $view := $.Account }}
{{ $user := $view.User }}
<section class="py-8">
  <div class="space-y-8">
    <header class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
      <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
        {{ range $i, $crumb := $.Breadcrumbs }}
          {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
          {{ if $crumb.Active }}
            <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
          {{ else }}
            <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
          {{ end }}
        {{ end }}
      </nav>
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ tlang $.Lang "account.page.eyebrow" }}</p>
          <h1 class="text-3xl font-bold text-gray-900 tracking-tight">{{ tlang $.Lang "nav.account" }}</h1>
          <p class="text-sm text-gray-600">{{ tlang $.Lang "account.page.subtitle" }}</p>
        </div>
        <div class="flex flex-col gap-3 rounded-2xl border border-gray-100 bg-gray-50 p-4 sm:flex-row sm:items-center sm:gap-5">
          <div class="flex items-center gap-3">
            <img src="{{ $user.AvatarURL }}" alt="{{ $user.DisplayName }}" class="h-14 w-14 rounded-full border border-gray-200 object-cover">
            <div>
              <p class="text-base font-semibold text-gray-900">{{ $user.DisplayName }}</p>
              <p class="text-xs text-gray-500">{{ $user.Email }}</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 text-xs">
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 font-semibold text-indigo-700">{{ $user.Plan }}</span>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-medium text-slate-700">{{ $user.Role }}</span>
          </div>
        </div>
      </div>
    </header>

    <div class="grid gap-6 lg:grid-cols-[260px_minmax(0,1fr)]">
      <aside class="space-y-5 rounded-3xl border border-gray-200 bg-white p-5 shadow-sm">
        <div class="space-y-3">
          {{ range $item := $view.NavItems }}
            <a href="{{ $item.Href }}"
               class="block rounded-2xl border px-4 py-3 text-sm transition {{ if $item.Active }}border-indigo-200 bg-indigo-50 text-indigo-800{{ else }}border-gray-100 hover:border-indigo-200{{ end }}">
              <div class="flex items-center justify-between gap-2">
                <span class="font-semibold">{{ $item.Label }}</span>
                {{ if $item.Badge }}<span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">{{ $item.Badge }}</span>{{ end }}
              </div>
              <p class="mt-1 text-xs text-gray-500">{{ $item.Description }}</p>
            </a>
          {{ end }}
        </div>
        <div class="rounded-2xl border border-dashed border-gray-200 p-4 text-xs text-gray-500">
          <p class="font-semibold text-gray-700">{{ tlang $.Lang "account.help.title" }}</p>
          <p class="mt-1">{{ tlang $.Lang "account.help.body" }}</p>
          <a href="/guides" class="mt-2 inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-500">
            {{ tlang $.Lang "account.help.cta" }}
            {{ template "icon" (dict "Name" "arrow-top-right-on-square" "Class" "h-4 w-4") }}
          </a>
        </div>
      </aside>

      <div class="space-y-6">
        <section class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ $view.Section.Eyebrow }}</p>
              <h2 class="text-2xl font-semibold text-gray-900">{{ $view.Section.Title }}</h2>
              <p class="text-sm text-gray-600">{{ $view.Section.Subtitle }}</p>
            </div>
            <button type="button"
                    class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500"
                    hx-get="{{ $view.AddAction.URL }}"
                    hx-target="#modal-root"
                    hx-swap="innerHTML">
              {{ $view.AddAction.Label }}
            </button>
          </div>
          {{ if $view.Sync.Title }}
            {{ template "c_inline_alert" (dict "Tone" $view.Sync.Tone "Icon" $view.Sync.Icon "Title" $view.Sync.Title "Body" $view.Sync.Body) }}
          {{ end }}
          <div id="account-address-table-shell">
            {{ slot "frag_account_addresses_table" $view.Table }}
          </div>
        </section>
      </div>
    </div>
  </div>
</section>

<script>
(function(){
  function ensureHTMX(){
    if (!window.htmx) { return null; }
    return window.htmx;
  }
  function refreshAddressTable(){
    var shell = document.getElementById('account-address-table-shell');
    var h = ensureHTMX();
    if (!h || !shell) { return; }
    h.ajax('GET', '/account/addresses/table', { target: shell, swap: 'innerHTML' });
  }
  var openMenus = [];
  function closeMenu(menu){
    if (!menu || !document.body.contains(menu)) { return; }
    var btn = menu.querySelector('[data-address-menu-trigger]');
    var panel = menu.querySelector('[data-address-menu-panel]');
    if (panel) { panel.classList.add('hidden'); }
    if (btn) { btn.setAttribute('aria-expanded', 'false'); }
  }
  function closeAllMenus(){
    openMenus.forEach(closeMenu);
    openMenus = [];
  }
  function initMenus(root){
    var scope = root || document;
    var menus = scope.querySelectorAll('[data-address-menu]');
    menus.forEach(function(menu){
      if (menu.dataset.addressMenuInit === 'true') { return; }
      menu.dataset.addressMenuInit = 'true';
      var btn = menu.querySelector('[data-address-menu-trigger]');
      var panel = menu.querySelector('[data-address-menu-panel]');
      if (!btn || !panel) { return; }
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        if (!panel.classList.contains('hidden')) {
          panel.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
          openMenus = openMenus.filter(function(item){ return item !== menu; });
          return;
        }
        closeAllMenus();
        panel.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
        openMenus.push(menu);
      });
    });
  }
  initMenus(document.getElementById('account-address-table-shell'));
  document.addEventListener('click', function(event){
    if (!event.target.closest('[data-address-menu]')) {
      closeAllMenus();
    }
  });

  document.body.addEventListener('htmx:afterSwap', function(event){
    if (!event || !event.target) { return; }
    if (event.target.id === 'account-address-table-shell' || (event.target.closest && event.target.closest('#account-address-table-shell'))) {
      closeAllMenus();
      initMenus(document.getElementById('account-address-table-shell'));
    }
  });

  document.body.addEventListener('account:addresses:refresh', function(){
    if (window.hankoModalClose) { window.hankoModalClose(); }
    refreshAddressTable();
  });
})();
</script>
{{ end }}
