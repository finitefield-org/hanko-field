{{ define "content" }}
{{ $view := $.Checkout }}
{{ $placed := $view.Submit.Placed }}
<section id="checkout-review-root" class="py-6 space-y-6">
  <header class="space-y-5 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
    <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
      {{ range $i, $crumb := $.Breadcrumbs }}
        {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
        {{ if $crumb.Active }}
          <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
        {{ else }}
          <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
        {{ end }}
      {{ end }}
    </nav>
    <div class="space-y-3">
      <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ if eq $.Lang "ja" }}チェックアウト{{ else }}Checkout{{ end }}</p>
      <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ if eq $.Lang "ja" }}最終確認{{ else }}Review & confirm{{ end }}</h1>
      <p class="text-sm text-gray-600">
        {{ if eq $.Lang "ja" }}デザイン、配送、支払いを最終確認し、注文確定へ進みます。{{ else }}Approve engraving details, verify fulfillment, and acknowledge terms before production kicks off.{{ end }}
      </p>
    </div>
    {{ if $view.Steps }}
      <ol class="grid gap-3 md:grid-cols-5" aria-label="{{ if eq $.Lang "ja" }}進捗状況{{ else }}Checkout progress{{ end }}">
        {{ range $view.Steps }}
          <li class="flex items-center gap-3 rounded-xl border px-3 py-2 text-sm {{ if .Active }}border-indigo-200 bg-indigo-50 text-indigo-700{{ else if .Completed }}border-emerald-200 bg-emerald-50 text-emerald-700{{ else }}border-gray-200 bg-gray-50 text-gray-500{{ end }}">
            <span class="inline-flex h-6 w-6 flex-none items-center justify-center rounded-full text-xs font-semibold {{ if .Active }}bg-indigo-600 text-white{{ else if .Completed }}bg-emerald-500 text-white{{ else }}bg-gray-200 text-gray-600{{ end }}">
              {{ .Position }}
            </span>
            <div>
              <p class="font-semibold">{{ .Label }}</p>
              <p class="text-xs text-gray-500">{{ .Description }}</p>
            </div>
          </li>
        {{ end }}
      </ol>
    {{ end }}
    {{ if $view.Alerts }}
      <div class="space-y-3">
        {{ range $alert := $view.Alerts }}
          {{ template "c_inline_alert" (dict "Tone" $alert.Tone "Icon" $alert.Icon "Title" $alert.Title "Body" $alert.Body) }}
        {{ end }}
      </div>
    {{ end }}
  </header>

  <div class="grid gap-6 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
    <div class="space-y-6">
      <section class="flex flex-col gap-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <div class="flex flex-col gap-4 sm:flex-row">
          <div class="flex-1 space-y-2">
            <div class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-indigo-500">
              {{ if $view.Snapshot.Badge.Label }}
                <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 px-3 py-1 text-[11px] font-semibold text-indigo-700">{{ $view.Snapshot.Badge.Label }}</span>
              {{ end }}
              <span>{{ if eq $.Lang "ja" }}デザイン確認{{ else }}Design snapshot{{ end }}</span>
            </div>
            <h2 class="text-2xl font-bold text-gray-900">{{ $view.Snapshot.Title }}</h2>
            <p class="text-sm text-gray-600">{{ $view.Snapshot.Subtitle }}</p>
            {{ if $view.Snapshot.MetaLines }}
              <ul class="mt-2 space-y-1 text-xs text-gray-500">
                {{ range $meta := $view.Snapshot.MetaLines }}
                  <li>• {{ $meta }}</li>
                {{ end }}
              </ul>
            {{ end }}
            {{ if $view.Snapshot.PreviewURL }}
              <a href="{{ $view.Snapshot.PreviewURL }}" class="inline-flex items-center gap-2 text-sm font-semibold text-indigo-600 hover:text-indigo-500">
                <span>{{ if eq $.Lang "ja" }}プレビューを開く{{ else }}Open live preview{{ end }}</span>
                {{ template "icon" (dict "Name" "arrow-top-right-on-square" "Class" "h-4 w-4") }}
              </a>
            {{ end }}
          </div>
          <div class="overflow-hidden rounded-2xl border border-gray-100 bg-gray-50 p-3">
            <img src="{{ if $view.Snapshot.ImageURL }}{{ $view.Snapshot.ImageURL }}{{ else }}/assets/placeholders/stamp-square.png{{ end }}"
                 alt="{{ $view.Snapshot.ImageAlt }}"
                 class="h-48 w-full rounded-xl object-cover shadow-inner">
          </div>
        </div>
      </section>

      <section class="grid gap-4 lg:grid-cols-2">
        <article class="space-y-3 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
          <header class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}配送{{ else }}Fulfillment{{ end }}</p>
              <h3 class="text-xl font-semibold text-gray-900">{{ $view.Shipment.MethodLabel }}</h3>
              <p class="text-sm text-gray-500">{{ $view.Shipment.Carrier }}</p>
            </div>
            <a href="{{ $view.Shipment.EditURL }}" class="text-sm font-semibold text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}編集{{ else }}Edit{{ end }}</a>
          </header>
          <div class="space-y-2 text-sm text-gray-600">
            {{ if $view.Shipment.Badge }}
              <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold {{ if eq $view.Shipment.BadgeTone "success" }}bg-emerald-50 text-emerald-700{{ else if eq $view.Shipment.BadgeTone "info" }}bg-indigo-50 text-indigo-700{{ else if eq $view.Shipment.BadgeTone "warning" }}bg-amber-50 text-amber-800{{ else }}bg-gray-100 text-gray-700{{ end }}">{{ $view.Shipment.Badge }}</span>
            {{ end }}
            {{ if $view.Shipment.Window }}<p>{{ $view.Shipment.Window }}</p>{{ end }}
            {{ if $view.Shipment.Weight }}<p>{{ if eq $.Lang "ja" }}総重量: {{ else }}Packed weight: {{ end }}{{ $view.Shipment.Weight }}</p>{{ end }}
          </div>
          {{ if $view.Shipment.Highlights }}
            <ul class="space-y-1 text-xs text-gray-500">
              {{ range $item := $view.Shipment.Highlights }}
                <li>• {{ $item }}</li>
              {{ end }}
            </ul>
          {{ end }}
          {{ if $view.Shipment.Address }}
            <div class="rounded-xl border border-gray-100 bg-gray-50 p-4 text-sm text-gray-700">
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-400">{{ if eq $.Lang "ja" }}配送先{{ else }}Ship to{{ end }}</p>
              <p class="font-semibold text-gray-900">{{ if $view.Shipment.Address.Label }}{{ $view.Shipment.Address.Label }}{{ else }}{{ $view.Shipment.Address.Recipient }}{{ end }}</p>
              <p>{{ $view.Shipment.Address.Recipient }}</p>
              <p>{{ $view.Shipment.Address.Line1 }}</p>
              {{ if $view.Shipment.Address.Line2 }}<p>{{ $view.Shipment.Address.Line2 }}</p>{{ end }}
              <p>{{ if $view.Shipment.Address.PostalCode }}{{ $view.Shipment.Address.PostalCode }} {{ end }}{{ $view.Shipment.Address.City }}, {{ $view.Shipment.Address.Region }}</p>
              <p>{{ $view.Shipment.Address.CountryLabel }}</p>
            </div>
          {{ end }}
        </article>

        <article class="space-y-3 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
          <header class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}支払い{{ else }}Payment{{ end }}</p>
              <h3 class="text-xl font-semibold text-gray-900">
                {{ if $view.Payment.Method }}{{ $view.Payment.Method.Label }}{{ else }}{{ if eq $.Lang "ja" }}未選択{{ else }}No method selected{{ end }}{{ end }}
              </h3>
              <p class="text-sm text-gray-500">
                {{ if and $view.Payment.Method $view.Payment.Method.Subtitle }}{{ $view.Payment.Method.Subtitle }}{{ else }}{{ if $view.Payment.Method }}{{ $view.Payment.Method.Brand }}{{ end }}{{ end }}
              </p>
            </div>
            <a href="{{ $view.Payment.EditURL }}" class="text-sm font-semibold text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}変更{{ else }}Change{{ end }}</a>
          </header>
          <div class="space-y-2">
            <p class="text-sm text-gray-600">
              {{ if eq $.Lang "ja" }}請求額{{ else }}Charge{{ end }}: <span class="font-semibold text-gray-900">{{ fmtMoney $view.Payment.Amount $view.Payment.Currency $.Lang }}</span>
            </p>
            <span class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-wide {{ if eq $view.Payment.StatusTone "success" }}text-emerald-700{{ else if eq $view.Payment.StatusTone "error" }}text-red-700{{ else }}text-gray-600{{ end }}">
              {{ template "icon" (dict "Name" "shield-check" "Class" "h-4 w-4") }}
              {{ $view.Payment.Status }}
            </span>
          </div>
          {{ if $view.Payment.Method }}
            <ul class="space-y-1 text-xs text-gray-500">
              <li>• {{ if eq $.Lang "ja" }}更新日: {{ else }}Updated: {{ end }}{{ fmtDate $view.LastUpdated $.Lang }}</li>
              {{ range $note := $view.Payment.Notes }}<li>• {{ $note }}</li>{{ end }}
            </ul>
          {{ else }}
            <p class="text-xs text-red-600">{{ if eq $.Lang "ja" }}支払い方法を追加してください。{{ else }}Add a payment method to finish.{{ end }}</p>
          {{ end }}
        </article>

        <article class="space-y-3 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
          <header class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}請求先{{ else }}Billing contact{{ end }}</p>
              <h3 class="text-xl font-semibold text-gray-900">{{ if $view.Billing.Address }}{{ $view.Billing.Address.Recipient }}{{ else if eq $.Lang "ja" }}未設定{{ else }}Not set{{ end }}</h3>
            </div>
            <a href="{{ $view.Billing.EditURL }}" class="text-sm font-semibold text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}編集{{ else }}Edit{{ end }}</a>
          </header>
          {{ if $view.Billing.Address }}
            <div class="space-y-1 text-sm text-gray-600">
              <p>{{ $view.Billing.Address.Company }}</p>
              <p>{{ $view.Billing.Address.Line1 }}</p>
              {{ if $view.Billing.Address.Line2 }}<p>{{ $view.Billing.Address.Line2 }}</p>{{ end }}
              <p>{{ if $view.Billing.Address.PostalCode }}{{ $view.Billing.Address.PostalCode }} {{ end }}{{ $view.Billing.Address.City }}, {{ $view.Billing.Address.Region }}</p>
              <p>{{ $view.Billing.Address.CountryLabel }}</p>
              {{ if $view.Billing.Address.Email }}<p>{{ $view.Billing.Address.Email }}</p>{{ end }}
            </div>
          {{ else }}
            <p class="text-sm text-gray-500">{{ if eq $.Lang "ja" }}請求情報が未入力です。{{ else }}Billing profile missing.{{ end }}</p>
          {{ end }}
          {{ if $view.Billing.Notes }}
            <ul class="space-y-1 text-xs text-gray-500">
              {{ range $note := $view.Billing.Notes }}<li>• {{ $note }}</li>{{ end }}
            </ul>
          {{ end }}
        </article>
      </section>

      <section class="space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <header>
          <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}注文内容{{ else }}Items{{ end }}</p>
          <h3 class="text-2xl font-semibold text-gray-900">{{ if eq $.Lang "ja" }}{{ $view.Summary.Estimate.ItemsCount }}点{{ else }}{{ $view.Summary.Estimate.ItemsCount }} items{{ end }}</h3>
        </header>
        {{ if $view.Items }}
          <ul class="divide-y divide-gray-100">
            {{ range $item := $view.Items }}
              <li class="flex flex-col gap-3 py-4 sm:flex-row sm:items-start">
                <div class="flex items-center gap-3 sm:w-1/3">
                  <img src="{{ if $item.Image }}{{ $item.Image }}{{ else }}/assets/placeholders/stamp-square.png{{ end }}" alt="{{ $item.Name }}" class="h-20 w-20 flex-none rounded-xl border border-gray-100 object-cover">
                  <div>
                    <p class="font-semibold text-gray-900">{{ $item.Name }}</p>
                    <p class="text-sm text-gray-500">{{ $item.Subtitle }}</p>
                    <p class="text-xs text-gray-400">{{ $item.SKU }}</p>
                  </div>
                </div>
                <div class="flex-1 space-y-1 text-sm text-gray-600">
                  <p>{{ if eq $.Lang "ja" }}数量{{ else }}Qty{{ end }}: {{ $item.Quantity }}</p>
                  {{ if $item.Options }}
                    <ul class="text-xs text-gray-500">
                      {{ range $opt := $item.Options }}<li>{{ $opt.Label }}: {{ $opt.Value }}</li>{{ end }}
                    </ul>
                  {{ end }}
                  {{ if $item.Notes }}
                    <ul class="text-xs text-amber-600">
                      {{ range $note := $item.Notes }}<li>• {{ $note }}</li>{{ end }}
                    </ul>
                  {{ end }}
                </div>
                <div class="text-right text-sm text-gray-600">
                  <p>{{ if eq $.Lang "ja" }}単価{{ else }}Unit{{ end }}</p>
                  <p class="font-semibold text-gray-900">{{ fmtMoney $item.UnitPrice "JPY" $.Lang }}</p>
                  <p class="text-xs text-gray-400">{{ if eq $.Lang "ja" }}小計{{ else }}Line total{{ end }}</p>
                  <p class="font-semibold text-gray-900">{{ fmtMoney $item.LineTotal "JPY" $.Lang }}</p>
                </div>
              </li>
            {{ end }}
          </ul>
        {{ else }}
          <p class="text-sm text-gray-500">{{ if eq $.Lang "ja" }}カートが空です。{{ else }}Your cart is empty.{{ end }}</p>
        {{ end }}
      </section>

      <section class="space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <form id="checkout-review-form"
              class="space-y-4"
              hx-post="{{ $view.SubmitURL }}"
              hx-target="#checkout-review-status"
              hx-swap="innerHTML">
          <label class="flex w-full items-start gap-3 text-sm text-gray-700">
            <input type="checkbox"
                   name="accept_terms"
                   value="1"
                   class="mt-1 h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                   {{ if $placed }}checked disabled aria-disabled="true"{{ else }}required{{ end }}>
            <span>
              <span class="font-semibold text-gray-900">{{ $view.Terms.Label }}</span>
              <span class="block text-xs text-gray-500">{{ $view.Terms.Description }}
                <a href="{{ $view.Terms.PolicyURL }}" class="font-semibold text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}利用規約{{ else }}Terms{{ end }}</a>
                ·
                <a href="{{ $view.Terms.PrivacyURL }}" class="font-semibold text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}プライバシー{{ else }}Privacy{{ end }}</a>
              </span>
            </span>
          </label>
          <div id="checkout-review-status">
            {{ if $view.Submit.Placed }}
              {{ template "c_inline_alert" (dict "Tone" "success" "Icon" "check-circle" "Title" $view.Submit.Title "Body" $view.Submit.Body) }}
            {{ end }}
          </div>
          <div class="flex flex-col gap-3 text-sm text-gray-500">
            <p>{{ if eq $.Lang "ja" }}更新: {{ fmtDate $view.LastUpdated $.Lang }} · {{ $view.Summary.Estimate.ETA }}{{ else }}Updated {{ fmtDate $view.LastUpdated $.Lang }} · {{ $view.Summary.Estimate.ETA }}{{ end }}</p>
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <a href="{{ $view.BackURL }}" class="inline-flex items-center justify-center rounded-xl border border-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:border-gray-300">{{ if eq $.Lang "ja" }}支払いへ戻る{{ else }}Back to payment{{ end }}</a>
              <button type="submit"
                      id="checkout-review-submit"
                      class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-3 text-base font-semibold text-white hover:bg-indigo-500 disabled:pointer-events-none disabled:opacity-60"
                      {{ if $placed }}disabled aria-disabled="true"{{ end }}>
                <span id="checkout-review-submit-label">
                  {{ if $placed }}
                    {{ if eq $.Lang "ja" }}注文済み{{ else }}Order placed{{ end }}
                  {{ else }}
                    {{ if eq $.Lang "ja" }}注文を確定する{{ else }}Place order{{ end }}
                  {{ end }}
                </span>
                {{ if not $placed }}
                  <span id="checkout-review-submit-busy" class="hidden items-center gap-2 text-sm">
                    <svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <circle cx="12" cy="12" r="9" class="opacity-25"></circle>
                      <path d="M21 12a9 9 0 0 1-9 9" class="opacity-75"></path>
                    </svg>
                    {{ if eq $.Lang "ja" }}処理中...{{ else }}Processing...{{ end }}
                  </span>
                {{ end }}
              </button>
            </div>
          </div>
        </form>
      </section>
    </div>

    <aside class="space-y-4">
      <div id="checkout-review-summary-shell">
        {{ slot "frag_checkout_summary" (dict "Lang" $.Lang "Summary" $view.Summary "Support" $view.Support) }}
      </div>
      <section class="space-y-2 rounded-2xl border border-amber-100 bg-amber-50 p-5 text-sm text-amber-900">
        <header>
          <p class="text-xs font-semibold uppercase tracking-wide text-amber-600">{{ if eq $.Lang "ja" }}ロイヤルティ{{ else }}Loyalty{{ end }}</p>
          <h3 class="text-xl font-semibold text-amber-900">{{ $view.Loyalty.Tier }}</h3>
        </header>
        <p class="text-2xl font-bold">{{ $view.Loyalty.Points }} pts</p>
        <p>{{ $view.Loyalty.Summary }}</p>
        <p class="text-xs text-amber-800">{{ $view.Loyalty.Detail }}</p>
        <a href="{{ $view.Loyalty.CTAHref }}" class="inline-flex items-center gap-2 text-sm font-semibold text-amber-800 hover:text-amber-700">
          <span>{{ $view.Loyalty.CTALabel }}</span>
          {{ template "icon" (dict "Name" "sparkles" "Class" "h-4 w-4") }}
        </a>
      </section>
    </aside>
  </div>

  <div class="text-xs text-gray-500">Path: {{ $.Path }}</div>
</section>

<script>
(function(){
  if (window.__checkoutReviewInit) { return; }
  window.__checkoutReviewInit = true;
  var form = document.getElementById('checkout-review-form');
  var submitBtn = document.getElementById('checkout-review-submit');
  var idle = document.getElementById('checkout-review-submit-label');
  var busy = document.getElementById('checkout-review-submit-busy');
  if (!form) { return; }
  form.addEventListener('htmx:beforeRequest', function(){
    if (submitBtn) { submitBtn.setAttribute('disabled', 'true'); }
    if (idle) { idle.classList.add('hidden'); }
    if (busy) { busy.classList.remove('hidden'); busy.classList.add('inline-flex'); }
  });
  form.addEventListener('htmx:afterRequest', function(){
    if (submitBtn) { submitBtn.removeAttribute('disabled'); }
    if (idle) { idle.classList.remove('hidden'); }
    if (busy) { busy.classList.add('hidden'); busy.classList.remove('inline-flex'); }
  });
})();
</script>
{{ end }}
