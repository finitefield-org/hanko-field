{{ define "content" }}
{{ $view := $.Account }}
{{ $user := $view.User }}
<section class="py-8">
  <div class="space-y-8">
    <header class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
      <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
        {{ range $i, $crumb := $.Breadcrumbs }}
          {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
          {{ if $crumb.Active }}
            <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
          {{ else }}
            <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
          {{ end }}
        {{ end }}
      </nav>
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ tlang $.Lang "account.page.eyebrow" }}</p>
          <h1 class="text-3xl font-bold text-gray-900 tracking-tight">{{ tlang $.Lang "nav.account" }}</h1>
          <p class="text-sm font-semibold text-gray-800">{{ $view.Header.Title }}</p>
          <p class="text-sm text-gray-600">{{ $view.Header.Subtitle }}</p>
        </div>
        <div class="flex flex-col gap-3 rounded-2xl border border-gray-100 bg-gray-50 p-4 sm:flex-row sm:items-center sm:gap-5">
          <div class="flex items-center gap-3">
            <img src="{{ $user.AvatarURL }}" alt="{{ $user.DisplayName }}" class="h-14 w-14 rounded-full border border-gray-200 object-cover">
            <div>
              <p class="text-base font-semibold text-gray-900">{{ $user.DisplayName }}</p>
              <p class="text-xs text-gray-500">{{ $user.Email }}</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 text-xs">
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 font-semibold text-indigo-700">{{ $user.Plan }}</span>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-medium text-slate-700">{{ $user.Role }}</span>
          </div>
        </div>
      </div>
    </header>

    <div class="grid gap-6 lg:grid-cols-[260px_minmax(0,1fr)]">
      <aside class="space-y-5 rounded-3xl border border-gray-200 bg-white p-5 shadow-sm">
        <div class="space-y-3">
          {{ range $item := $view.NavItems }}
            <a href="{{ $item.Href }}"
               class="block rounded-2xl border px-4 py-3 text-sm transition {{ if $item.Active }}border-indigo-200 bg-indigo-50 text-indigo-800{{ else }}border-gray-100 hover:border-indigo-200{{ end }}">
              <div class="flex items-center justify-between gap-2">
                <span class="font-semibold">{{ $item.Label }}</span>
                {{ if $item.Badge }}<span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">{{ $item.Badge }}</span>{{ end }}
              </div>
              <p class="mt-1 text-xs text-gray-500">{{ $item.Description }}</p>
            </a>
          {{ end }}
        </div>
        <div class="rounded-2xl border border-dashed border-gray-200 p-4 text-xs text-gray-500">
          <p class="font-semibold text-gray-700">{{ tlang $.Lang "account.help.title" }}</p>
          <p class="mt-1">{{ tlang $.Lang "account.help.body" }}</p>
          <a href="/guides" class="mt-2 inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-500">
            {{ tlang $.Lang "account.help.cta" }}
            {{ template "icon" (dict "Name" "arrow-top-right-on-square" "Class" "h-4 w-4") }}
          </a>
        </div>
      </aside>

      <div class="space-y-6">
        {{ if $view.Banner }}
          <section class="rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
            {{ template "alert_banner" (dict "Lang" $.Lang "Banner" $view.Banner) }}
          </section>
        {{ end }}

        <section class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <header class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ $view.Header.Eyebrow }}</p>
              <h2 class="text-xl font-semibold text-gray-900">{{ $view.Providers.Title }}</h2>
              <p class="text-sm text-gray-600">{{ $view.Providers.Subtitle }}</p>
            </div>
            <p class="text-xs text-gray-500">{{ $view.Providers.HelpText }}</p>
          </header>
          <div class="space-y-5">
            {{ range $provider := $view.Providers.Providers }}
              <article id="provider-{{ $provider.ID }}" class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                  <div class="flex gap-4">
                    <span class="inline-flex h-12 w-12 flex-none items-center justify-center rounded-2xl bg-indigo-50 text-indigo-600">
                      {{ template "icon" (dict "Name" $provider.Icon "Class" "h-6 w-6") }}
                    </span>
                    <div class="space-y-2">
                      <div class="flex flex-wrap items-center gap-3">
                        <h3 class="text-lg font-semibold text-gray-900">{{ $provider.Name }}</h3>
                        <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold {{ $provider.StatusBadgeClass }}">
                          <span class="h-2 w-2 rounded-full {{ $provider.StatusDotClass }}"></span>
                          {{ $provider.StatusLabel }}
                        </span>
                      </div>
                      <p class="text-sm text-gray-600">{{ $provider.Description }}</p>
                      {{ if $provider.LastLinked }}
                        <p class="text-xs {{ $provider.StatusTextClass }}">{{ $provider.LastLinked }}</p>
                      {{ end }}
                      {{ if $provider.Metadata }}
                        <ul class="flex flex-wrap gap-4 text-xs">
                          {{ range $meta := $provider.Metadata }}
                            {{ if and $meta.Label $meta.Value }}
                              <li class="flex items-center gap-1 text-gray-500">
                                <span class="font-semibold text-gray-600">{{ $meta.Label }}:</span>
                                <span class="text-gray-700">{{ $meta.Value }}</span>
                              </li>
                            {{ else if $meta.Label }}
                              <li class="text-gray-500">{{ $meta.Label }}</li>
                            {{ end }}
                          {{ end }}
                        </ul>
                      {{ end }}
                    </div>
                  </div>
                  <div class="flex items-start justify-end">
                    <span class="hidden text-sm {{ $provider.StatusTextClass }} md:inline">{{ $provider.StatusLabel }}</span>
                  </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-3">
                  {{ template "account_security_action" (dict "Action" $provider.PrimaryAction "Lang" $.Lang) }}
                  {{ if $provider.SecondaryAction }}{{ template "account_security_action" (dict "Action" $provider.SecondaryAction "Lang" $.Lang) }}{{ end }}
                  {{ if $provider.DangerAction }}{{ template "account_security_action" (dict "Action" $provider.DangerAction "Lang" $.Lang) }}{{ end }}
                </div>
              </article>
            {{ end }}
          </div>
        </section>

        <section class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <header class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div class="space-y-1">
              <h2 class="text-xl font-semibold text-gray-900">{{ tlang $.Lang "account.security.mfa.title" }}</h2>
              <p class="text-sm text-gray-600">{{ $view.TwoFactor.Description }}</p>
              <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold {{ $view.TwoFactor.StatusBadgeClass }}">
                <span class="h-2 w-2 rounded-full {{ $view.TwoFactor.StatusDotClass }}"></span>
                {{ $view.TwoFactor.StatusLabel }}
              </span>
            </div>
            <div class="flex flex-wrap gap-3">
              {{ template "account_security_action" (dict "Action" $view.TwoFactor.PrimaryAction "Lang" $.Lang) }}
              {{ if $view.TwoFactor.SecondaryAction }}{{ template "account_security_action" (dict "Action" $view.TwoFactor.SecondaryAction "Lang" $.Lang) }}{{ end }}
            </div>
          </header>
          <div class="grid gap-4 md:grid-cols-2">
            {{ range $method := $view.TwoFactor.Methods }}
              <div class="rounded-2xl border border-gray-100 bg-gray-50 p-4">
                <div class="flex items-center justify-between gap-3">
                  <div class="flex items-center gap-3">
                    <span class="inline-flex h-10 w-10 flex-none items-center justify-center rounded-xl bg-white text-indigo-500">
                      {{ template "icon" (dict "Name" $method.Icon "Class" "h-5 w-5") }}
                    </span>
                    <div>
                      <p class="font-semibold text-gray-900">{{ $method.Label }}</p>
                      <p class="text-xs text-gray-500">{{ $method.Description }}</p>
                    </div>
                  </div>
                  <span class="rounded-full px-3 py-1 text-xs font-semibold {{ $method.StatusClass }}">{{ $method.StatusLabel }}</span>
                </div>
              </div>
            {{ end }}
          </div>
          <div class="grid gap-4 lg:grid-cols-[minmax(0,1fr)_320px]">
            <div class="space-y-3 rounded-2xl border border-gray-100 p-4">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-900">{{ tlang $.Lang "account.security.mfa.backup_codes" }}</h3>
                <span class="text-xs text-gray-500">{{ tlang $.Lang "account.security.mfa.backup_rotated" }} {{ $view.TwoFactor.BackupCodesRotated }}</span>
              </div>
              <div class="grid gap-2 sm:grid-cols-3">
                {{ range $code := $view.TwoFactor.BackupCodes }}
                  <div class="rounded-lg border border-dashed border-gray-300 bg-white px-3 py-2 text-center font-mono text-sm tracking-widest text-gray-700">{{ $code }}</div>
                {{ end }}
              </div>
              <p class="text-xs text-gray-500">{{ tlang $.Lang "account.security.mfa.backup_hint" }}</p>
            </div>
            <div class="space-y-2 rounded-2xl border border-gray-100 p-4">
              <h3 class="text-sm font-semibold text-gray-900">{{ tlang $.Lang "account.security.mfa.recovery" }}</h3>
              <p class="text-xs text-gray-600">{{ tlang $.Lang "account.security.mfa.recovery.desc" }}</p>
              <ul class="space-y-2 text-sm text-gray-700">
                <li class="flex items-center gap-2">
                  {{ template "icon" (dict "Name" "envelope-open" "Class" "h-4 w-4 text-gray-400") }}
                  <span>{{ $view.TwoFactor.RecoveryEmail }}</span>
                </li>
                <li class="flex items-center gap-2">
                  {{ template "icon" (dict "Name" "device-phone-mobile" "Class" "h-4 w-4 text-gray-400") }}
                  <span>{{ $view.TwoFactor.RecoveryPhone }}</span>
                </li>
              </ul>
            </div>
          </div>
        </section>

        <section class="rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-xl font-semibold text-gray-900">{{ tlang $.Lang "account.security.password.title" }}</h2>
              <p class="text-sm text-gray-600">{{ $view.Password.Description }}</p>
              <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500">
                <span>{{ tlang $.Lang "account.security.password.last_changed" }} {{ $view.Password.LastChanged }}</span>
                <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 font-semibold {{ $view.Password.StrengthClass }}">{{ $view.Password.StrengthLabel }}</span>
              </div>
            </div>
            <div class="flex flex-wrap gap-3">
              {{ template "account_security_action" (dict "Action" $view.Password.Action "Lang" $.Lang) }}
              {{ if $view.Password.SecondaryAction }}{{ template "account_security_action" (dict "Action" $view.Password.SecondaryAction "Lang" $.Lang) }}{{ end }}
            </div>
          </div>
        </section>

        <section id="sessions" class="space-y-5 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <header class="flex flex-col gap-1">
            <h2 class="text-xl font-semibold text-gray-900">{{ $view.Sessions.Title }}</h2>
            <p class="text-sm text-gray-600">{{ $view.Sessions.Subtitle }}</p>
          </header>
          <div class="overflow-hidden rounded-2xl border border-gray-100" id="account-security-sessions">
            <table class="min-w-full divide-y divide-gray-100 text-sm">
              <thead class="bg-gray-50 text-left text-xs font-semibold uppercase tracking-wide text-gray-500">
                <tr>
                  <th scope="col" class="px-4 py-3">{{ tlang $.Lang "account.sessions.device" }}</th>
                  <th scope="col" class="px-4 py-3">{{ tlang $.Lang "account.sessions.location" }}</th>
                  <th scope="col" class="px-4 py-3">{{ tlang $.Lang "account.sessions.active" }}</th>
                  <th scope="col" class="px-4 py-3">{{ tlang $.Lang "account.security.sessions.method" }}</th>
                  <th scope="col" class="px-4 py-3">{{ tlang $.Lang "account.security.sessions.risk" }}</th>
                  <th scope="col" class="px-4 py-3 text-right">{{ tlang $.Lang "account.sessions.actions" }}</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                {{ range $session := $view.Sessions.Sessions }}
                  <tr class="{{ if $session.Current }}bg-indigo-50/40{{ else }}bg-white{{ end }}">
                    <td class="px-4 py-4">
                      <p class="font-medium text-gray-900">{{ $session.Device }}</p>
                      <p class="text-xs text-gray-500">{{ $session.Platform }} · {{ $session.IP }}</p>
                    </td>
                    <td class="px-4 py-4 text-gray-700">{{ $session.Location }}</td>
                    <td class="px-4 py-4 text-gray-700">{{ $session.LastActive }}</td>
                    <td class="px-4 py-4 text-gray-700">{{ $session.SignInMethod }}</td>
                    <td class="px-4 py-4">
                      <span class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold {{ $session.RiskBadge }}" title="{{ $session.RiskText }}">{{ $session.Risk }}</span>
                    </td>
                    <td class="px-4 py-4 text-right">
                      {{ if eq $session.RevokeAction.Variant "static" }}
                        <span class="text-xs font-semibold text-emerald-600">{{ $session.RevokeAction.Label }}</span>
                      {{ else }}
                        {{ template "account_security_action" (dict "Action" $session.RevokeAction "Lang" $.Lang) }}
                      {{ end }}
                    </td>
                  </tr>
                {{ end }}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>
</section>

<div id="account-security-toast" class="pointer-events-none fixed bottom-6 right-6 z-40 flex max-w-sm flex-col gap-3"></div>

{{ range $provider := $view.Providers.Providers }}
  {{ range $modal := $provider.Modals }}
    <template id="tmpl-{{ $modal.ID }}">
      {{ template "c_modal" (dict "ID" $modal.ID "Title" $modal.Title "BodyTmpl" "account_security_modal_body" "BodyData" (dict "Modal" $modal "Lang" $.Lang) "FooterTmpl" "account_security_modal_footer" "FooterData" (dict "Modal" $modal "Lang" $.Lang)) }}
    </template>
  {{ end }}
{{ end }}

{{ $mfaModal := $view.TwoFactor.Modal }}
<template id="tmpl-{{ $mfaModal.ID }}">
  {{ template "c_modal" (dict "ID" $mfaModal.ID "Title" $mfaModal.Title "BodyTmpl" "account_security_modal_body" "BodyData" (dict "Modal" $mfaModal "Lang" $.Lang) "FooterTmpl" "account_security_modal_footer" "FooterData" (dict "Modal" $mfaModal "Lang" $.Lang)) }}
</template>

<script>
(function(){
  if (window.__accountSecurityInit) { return; }
  window.__accountSecurityInit = true;

  var modalRoot = document.getElementById('modal-root');
  var toastRoot = document.getElementById('account-security-toast');

  function openModal(id){
    if (!id || !modalRoot) { return; }
    var tpl = document.getElementById('tmpl-' + id);
    if (!tpl) { return; }
    modalRoot.innerHTML = tpl.innerHTML;
    var evt = new Event('htmx:afterSwap');
    evt.target = modalRoot;
    document.body.dispatchEvent(evt);
  }

  function closeModal(){
    if (window.hankoModalClose) { window.hankoModalClose(); }
  }

  function pushToast(message){
    if (!message || !toastRoot) { return; }
    var el = document.createElement('div');
    el.className = 'pointer-events-auto rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm font-medium text-emerald-800 shadow';
    el.textContent = message;
    toastRoot.appendChild(el);
    setTimeout(function(){
      el.classList.add('opacity-0', 'transition');
      setTimeout(function(){ toastRoot.removeChild(el); }, 250);
    }, 3200);
  }

  document.addEventListener('click', function(e){
    var trigger = e.target.closest('[data-security-modal]');
    if (trigger){
      e.preventDefault();
      var id = trigger.getAttribute('data-security-modal');
      openModal(id);
      return;
    }
    var toastBtn = e.target.closest('[data-security-toast]');
    if (toastBtn){
      var msg = toastBtn.getAttribute('data-security-toast');
      if (msg){ pushToast(msg); }
      e.preventDefault();
      return;
    }
    var confirmBtn = e.target.closest('[data-security-confirm]');
    if (confirmBtn){
      var confirmMsg = confirmBtn.getAttribute('data-security-confirm');
      if (confirmMsg){ pushToast(confirmMsg); }
      e.preventDefault();
      closeModal();
    }
  });
})();
</script>
{{ end }}

{{ define "account_security_modal_body" }}
  {{ $modal := .Modal }}
  <div class="space-y-4">
    {{ if $modal.Description }}<p class="text-sm text-gray-600">{{ $modal.Description }}</p>{{ end }}
    {{ if $modal.Body }}
      <ul class="space-y-3">
        {{ range $item := $modal.Body }}
          <li class="flex gap-3">
            <span class="mt-0.5 inline-flex h-8 w-8 flex-none items-center justify-center rounded-full bg-indigo-50 text-indigo-600">
              {{ template "icon" (dict "Name" $item.Icon "Class" "h-4 w-4") }}
            </span>
            <div class="space-y-1">
              <p class="text-sm font-semibold text-gray-900">{{ $item.Title }}</p>
              <p class="text-sm text-gray-600">{{ $item.Description }}</p>
            </div>
          </li>
        {{ end }}
      </ul>
    {{ end }}
    {{ if $modal.FooterNote }}<p class="rounded-lg bg-gray-50 p-3 text-xs text-gray-500">{{ $modal.FooterNote }}</p>{{ end }}
  </div>
{{ end }}

{{ define "account_security_modal_footer" }}
  {{ $modal := .Modal }}
  <div class="flex w-full flex-wrap items-center justify-end gap-3">
    <button type="button" class="inline-flex items-center justify-center rounded-md border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50" data-modal-close>{{ if eq .Lang "ja" }}キャンセル{{ else }}Cancel{{ end }}</button>
    {{ if $modal.ConfirmLabel }}
      <button type="button" class="{{ $modal.ConfirmClasses }}" data-security-confirm="{{ $modal.SuccessMessage }}">
        {{ if $modal.ConfirmHref }}{{ $modal.ConfirmLabel }}{{ else }}{{ $modal.ConfirmLabel }}{{ end }}
      </button>
    {{ end }}
  </div>
{{ end }}

{{ define "account_security_action" }}
  {{ $action := .Action }}
  {{ if $action.Label }}
    {{ if $action.ModalID }}
      <button type="button" class="{{ $action.Classes }}" data-security-modal="{{ $action.ModalID }}">
        {{ if $action.Icon }}{{ template "icon" (dict "Name" $action.Icon "Class" "h-4 w-4") }}{{ end }}
        <span>{{ $action.Label }}</span>
      </button>
    {{ else if and $action.Href (eq $action.Method "GET") }}
      <a href="{{ $action.Href }}" class="{{ $action.Classes }}">
        {{ if $action.Icon }}{{ template "icon" (dict "Name" $action.Icon "Class" "h-4 w-4") }}{{ end }}
        <span>{{ $action.Label }}</span>
      </a>
    {{ else }}
      <button type="button" class="{{ $action.Classes }}" {{ if $action.SuccessMessage }}data-security-toast="{{ $action.SuccessMessage }}"{{ end }}>
        {{ if $action.Icon }}{{ template "icon" (dict "Name" $action.Icon "Class" "h-4 w-4") }}{{ end }}
        <span>{{ $action.Label }}</span>
      </button>
    {{ end }}
  {{ end }}
{{ end }}
