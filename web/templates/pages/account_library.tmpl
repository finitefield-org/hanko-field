{{ define "content" }}
{{ $view := $.Account }}
{{ $user := $view.User }}
<section class="py-8">
  <div class="space-y-8">
    <header class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
      <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
        {{ range $i, $crumb := $.Breadcrumbs }}
          {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
          {{ if $crumb.Active }}
            <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
          {{ else }}
            <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
          {{ end }}
        {{ end }}
      </nav>
      <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-2">
          <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ tlang $.Lang "account.page.eyebrow" }}</p>
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">{{ tlang $.Lang "nav.account" }}</h1>
          <p class="text-sm text-gray-600">{{ tlang $.Lang "account.page.subtitle" }}</p>
        </div>
        <div class="flex flex-col gap-3 rounded-2xl border border-gray-100 bg-gray-50 p-4 sm:flex-row sm:items-center sm:gap-5">
          <div class="flex items-center gap-3">
            <img src="{{ $user.AvatarURL }}" alt="{{ $user.DisplayName }}" class="h-14 w-14 rounded-full border border-gray-200 object-cover">
            <div>
              <p class="text-base font-semibold text-gray-900">{{ $user.DisplayName }}</p>
              <p class="text-xs text-gray-500">{{ $user.Email }}</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 text-xs">
            <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 font-semibold text-indigo-700">{{ $user.Plan }}</span>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-medium text-slate-700">{{ $user.Role }}</span>
          </div>
        </div>
      </div>
    </header>

    <div class="grid gap-6 lg:grid-cols-[260px_minmax(0,1fr)]">
      <aside class="space-y-5 rounded-3xl border border-gray-200 bg-white p-5 shadow-sm">
        <div class="space-y-3">
          {{ range $item := $view.NavItems }}
            <a href="{{ $item.Href }}"
               class="block rounded-2xl border px-4 py-3 text-sm transition {{ if $item.Active }}border-indigo-200 bg-indigo-50 text-indigo-800{{ else }}border-gray-100 hover:border-indigo-200{{ end }}">
              <div class="flex items-center justify-between gap-2">
                <span class="font-semibold">{{ $item.Label }}</span>
                {{ if $item.Badge }}<span class="rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">{{ $item.Badge }}</span>{{ end }}
              </div>
              <p class="mt-1 text-xs text-gray-500">{{ $item.Description }}</p>
            </a>
          {{ end }}
        </div>
        <div class="rounded-2xl border border-dashed border-gray-200 p-4 text-xs text-gray-500">
          <p class="font-semibold text-gray-700">{{ tlang $.Lang "account.help.title" }}</p>
          <p class="mt-1">{{ tlang $.Lang "account.help.body" }}</p>
          <a href="/guides" class="mt-2 inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-500">
            {{ tlang $.Lang "account.help.cta" }}
            {{ template "icon" (dict "Name" "arrow-top-right-on-square" "Class" "h-4 w-4") }}
          </a>
        </div>
      </aside>

      <div class="space-y-6">
        <section class="space-y-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ $view.Section.Eyebrow }}</p>
              <h2 class="text-2xl font-semibold text-gray-900">{{ $view.Section.Title }}</h2>
              <p class="text-sm text-gray-600">{{ $view.Section.Subtitle }}</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <a href="{{ $view.Section.SecondaryHref }}"
                 class="inline-flex items-center justify-center rounded-xl border border-gray-200 px-5 py-2.5 text-sm font-semibold text-gray-700 transition hover:border-indigo-300 hover:text-indigo-600">
                {{ $view.Section.SecondaryLabel }}
              </a>
              <a href="{{ $view.Section.PrimaryHref }}"
                 class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500">
                {{ $view.Section.PrimaryLabel }}
              </a>
            </div>
          </div>

          <form id="account-library-filters"
                class="space-y-4"
                hx-get="/account/library/table"
                hx-target="#account-library-grid-shell"
                hx-push-url="true"
                hx-swap="innerHTML"
                hx-include="#account-library-selections">
            <input type="hidden" name="status" id="account-library-status" value="{{ $view.Filters.Status }}">
            <input type="hidden" name="page" id="account-library-page" value="{{ $view.Grid.Page }}">
            <div class="flex flex-wrap items-center gap-2">
              {{ range $opt := $view.Filters.StatusOptions }}
                <button type="button"
                        data-library-status="{{ $opt.ID }}"
                        data-active="{{ if $opt.Active }}true{{ else }}false{{ end }}"
                        class="inline-flex items-center gap-2 rounded-full border px-4 py-1.5 text-xs font-semibold transition {{ if $opt.Active }}border-indigo-300 bg-indigo-50 text-indigo-700 shadow-sm{{ else }}border-transparent bg-gray-100 text-gray-600 hover:bg-gray-200{{ end }}">
                  <span>{{ $opt.Label }}</span>
                </button>
              {{ end }}
            </div>
            <div class="grid gap-3 sm:grid-cols-[minmax(0,220px)_minmax(0,180px)_minmax(0,1fr)]">
              <label class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500">
                {{ template "icon" (dict "Name" "tag" "Class" "h-4 w-4 text-gray-400") }}
                <select name="tag" id="account-library-tag" class="w-full border-0 bg-transparent text-sm text-gray-700 focus:outline-none">
                  {{ range $opt := $view.Filters.TagOptions }}
                    <option value="{{ $opt.ID }}" {{ if $opt.Active }}selected{{ end }}>{{ $opt.Label }}</option>
                  {{ end }}
                </select>
              </label>
              <label class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700 focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500">
                {{ template "icon" (dict "Name" "arrow-path-rounded-square" "Class" "h-4 w-4 text-gray-400") }}
                <select name="sort" id="account-library-sort" class="w-full border-0 bg-transparent text-sm text-gray-700 focus:outline-none">
                  {{ range $opt := $view.Filters.SortOptions }}
                    <option value="{{ $opt.ID }}" {{ if $opt.Active }}selected{{ end }}>{{ $opt.Label }}</option>
                  {{ end }}
                </select>
              </label>
              <label class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600 focus-within:border-indigo-500 focus-within:ring-2 focus-within:ring-indigo-500">
                {{ template "icon" (dict "Name" "magnifying-glass" "Class" "h-4 w-4 text-gray-400") }}
                <input type="search"
                       name="q"
                       id="account-library-search"
                       value="{{ $view.Filters.Query }}"
                       placeholder="{{ $view.Filters.SearchPlaceholder }}"
                       class="w-full border-0 bg-transparent text-sm text-gray-700 focus:outline-none"
                       spellcheck="false"
                       autocomplete="off">
              </label>
            </div>
            <div id="account-library-selections" class="hidden"></div>
          </form>

          <div id="account-library-loading" class="hidden rounded-xl border border-dashed border-indigo-200 bg-indigo-50/70 p-4 text-sm font-medium text-indigo-700">
            {{ if eq $.Lang "ja" }}読み込み中...{{ else }}Loading designs...{{ end }}
          </div>

          <div id="account-library-grid-shell">
            {{ slot "frag_account_library_table" $view.Grid }}
          </div>
        </section>
      </div>
    </div>
  </div>
</section>

<div id="account-library-drawer" hx-target="this" hx-swap="innerHTML">
  {{ template "frag_account_library_drawer" $view.Drawer }}
</div>

<script>
(function () {
  if (window.__accountLibraryInit) { return; }
  window.__accountLibraryInit = true;

  var form = document.getElementById('account-library-filters');
  var statusInput = document.getElementById('account-library-status');
  var pageInput = document.getElementById('account-library-page');
  var selectionsContainer = document.getElementById('account-library-selections');
  var gridShell = document.getElementById('account-library-grid-shell');

  function ensureHTMX() {
    if (!window.htmx) {
      throw new Error('htmx not available');
    }
    return window.htmx;
  }

  function setStatus(value) {
    if (!statusInput) { return; }
    statusInput.value = value || 'all';
  }

  function resetPage() {
    if (!pageInput) { return; }
    pageInput.value = '1';
  }

  function syncSelectionInputs(ids) {
    if (!selectionsContainer) { return; }
    selectionsContainer.innerHTML = '';
    ids.forEach(function(id) {
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'sel';
      input.value = id;
      selectionsContainer.appendChild(input);
    });
  }

  function currentSelections() {
    var items = document.querySelectorAll('[data-library-card][data-selected="true"]');
    var ids = [];
    Array.prototype.forEach.call(items, function(el) {
      var id = el.getAttribute('data-library-card');
      if (id) { ids.push(id); }
    });
    return ids;
  }

  function submitFilters() {
    var htmx = ensureHTMX();
    if (!form) { return; }
    syncSelectionInputs(currentSelections());
    resetPage();
    htmx.trigger(form, 'submit');
  }

  function bindStatusChips(root) {
    var chips = root.querySelectorAll('[data-library-status]');
    Array.prototype.forEach.call(chips, function(chip) {
      chip.addEventListener('click', function (ev) {
        ev.preventDefault();
        var value = chip.getAttribute('data-library-status') || 'all';
        setStatus(value);
        submitFilters();
      });
    });
  }

  function bindFormInputs(root) {
    var tag = document.getElementById('account-library-tag');
    var sort = document.getElementById('account-library-sort');
    var search = document.getElementById('account-library-search');

    if (tag) {
      tag.addEventListener('change', function () {
        submitFilters();
      });
    }
    if (sort) {
      sort.addEventListener('change', function () {
        submitFilters();
      });
    }
    if (search) {
      var timer = null;
      search.addEventListener('input', function () {
        window.clearTimeout(timer);
        timer = window.setTimeout(function () {
          submitFilters();
        }, 350);
      });
    }
  }

  function toggleSelection(card, force) {
    if (!card) { return; }
    var selected = card.getAttribute('data-selected') === 'true';
    if (force === true) {
      selected = true;
    } else if (force === false) {
      selected = false;
    } else {
      selected = !selected;
    }
    card.setAttribute('data-selected', selected ? 'true' : 'false');
    card.dataset.selected = selected ? 'true' : 'false';
    var checkbox = card.querySelector('[data-library-select-indicator]');
    if (checkbox) {
      checkbox.checked = selected;
      checkbox.setAttribute('aria-pressed', selected ? 'true' : 'false');
    }
    syncSelectionInputs(currentSelections());
  }

  function bindCardSelections(root) {
    var cards = root.querySelectorAll('[data-library-card]');
    Array.prototype.forEach.call(cards, function(card) {
      var toggle = card.querySelector('[data-library-select]');
      if (toggle) {
        toggle.addEventListener('click', function (ev) {
          ev.preventDefault();
          toggleSelection(card);
        });
      }
    });
  }

  function initialise(root) {
    if (!root) { return; }
    bindStatusChips(root);
    bindCardSelections(root);
  }

  bindStatusChips(document);
  bindFormInputs(document);
  bindCardSelections(document);

  document.addEventListener('htmx:beforeRequest', function (event) {
    if (event.target === form) {
      document.getElementById('account-library-loading').classList.remove('hidden');
    }
  });

  document.addEventListener('htmx:afterSwap', function (event) {
    if (event.target && event.target.id === 'account-library-grid-shell') {
      document.getElementById('account-library-loading').classList.add('hidden');
      initialise(event.target);
      syncSelectionInputs(currentSelections());
    }
    if (event.target && event.target.id === 'account-library-drawer') {
      var drawer = event.target.querySelector('[data-library-drawer]');
      if (drawer) {
        drawer.focus();
      }
    }
  });

  var loadMoreHandler = function (event) {
    var trigger = event.target.getAttribute('data-library-load-more');
    if (!trigger) { return; }
    var htmx = ensureHTMX();
    pageInput.value = trigger;
    syncSelectionInputs(currentSelections());
    htmx.trigger(form, 'submit');
  };

  document.addEventListener('click', function (event) {
    var loadMore = event.target.closest('[data-library-load-more]');
    if (loadMore) {
      event.preventDefault();
      var next = loadMore.getAttribute('data-library-load-more');
      pageInput.value = next;
      syncSelectionInputs(currentSelections());
      ensureHTMX().trigger(form, 'submit');
    }
  });

  initialise(document);
})();
</script>
{{ end }}
