# Ensure PII masking/anonymization processes meet compliance and logging policies.

**Parent Section:** 11. Security & Compliance
**Task ID:** 120

## Goal
Ensure personal data is masked or anonymized according to compliance policies across all API services, background jobs, logs, exports, and lifecycle flows (e.g., deletion).

## Scope
- Firestore, Storage, and BigQuery exports that include user/contact data.
- Runtime logging (structured logs, audit logs, error reporting) generated by API and batch jobs.
- User-initiated and admin-initiated "deactivate + mask" flows (`POST /users/{uid}:deactivate-and-mask`).
- Compliance evidence (automated checks, reports) required for privacy reviews and SOC2.

## Deliverables
1. **PII Inventory & Rules** — single source of truth enumerating all PII fields, retention windows, masking strategies, and lawful bases.
2. **Masking Utilities** — Go helper package (`pkg/mask`) plus templ/htmx filters exposing deterministic masking for UI + logging middleware integration.
3. **Automated Scrub Hooks** — middleware & Firestore hooks guaranteeing log/event payloads cannot include raw PII.
4. **Deletion Compliance Flow** — idempotent worker verifying post-deletion artifacts (logs, exports) no longer contain PII; emits compliance evidence.
5. **Audit Checklist** — runbook + automated policy checks with verifiable outputs stored in `gs://hanko-field-$ENV-compliance`.

## Work Breakdown

### 1. PII Inventory & Retention Table
- Create `doc/api/models/pii_inventory.md` (new file) sourced from Firestore schemas and PSP contracts.
- Fields to include: entity, field, classification level (P0–P3), lawful basis, retention, masking output, storage location(s).
- Align TTL/backfill tasks with `doc/db/db_design.md` (add references for any TTL indexes needed for TTL auto-deletion).
- Owners: API platform team; update process via PR template checklist.

### 2. Masking Utilities & Usage
- Implement `pkg/mask` with helpers:
  - `mask.Email(email string) string` → `a***@example.com`.
  - `mask.Phone(e164 string) string` → `+81*******12`.
  - `mask.Name(name string) string` → `K***`.
  - `mask.Address(addr Address) AddressMasked` (only city/prefecture stored).
  - `mask.Generic(input string, visible int)` for arbitrary tokens (PSP IDs).
- Provide deterministic hashing (`mask.Hash(value string) string`) using HMAC-SHA256 with key from Secret Manager for referential joins in analytics without exposing raw data.
- Integrate with:
  - Structured logging middleware (task 012) via central `log.Redact()` wrapper.
  - Audit log writer (task 024) so diffs store masked copies & hashed references.
  - Export jobs writing to BigQuery/Storage; require `mask.Pipeline` interface for stream processors.

### 3. Logging/Export Safeguards
- Update `pkg/logging` to enforce deny-list of sensitive keys; panic in non-prod when raw PII detected.
- Provide `PII_SAFE_FIELDS` env var for allow-list exceptions (e.g., compliance bucket exports).
- Configure Cloud Logging exclusion filters to drop any log entry with label `piiLeak=true`; alert via PagerDuty.
- For analytics exports, ensure Dataflow/BigQuery schema uses masked fields only; raw data stored solely in CMEK-protected Storage with 30-day retention.

### 4. Deactivate + Mask Flow Hardening
- Endpoint contract:
  - Step 1: mark user `status=DEACTIVATED`, `piiMasked=true`, `maskedAt`.
  - Step 2: scrub `users` document fields (`displayName`, `email`, `phone`, `addressSnapshot`, `paymentRefs`).
  - Step 3: cascade to dependent collections (orders.shippingAddressSnapshot, favorites, carts) using background task to avoid latency.
- Introduce verification job (`pii-scrub-verifier`) that:
  - Runs within 5 minutes post request, scanning primary collections referencing the user.
  - Writes attestation doc to `/compliance/piiScrubEvents/{id}` with before/after hashed digests.
  - Raises alert if residual PII found; triggers auto-remediation (re-run scrub).

### 5. Compliance Audits & Evidence
- Implement weekly Cloud Scheduler job hitting `/internal/compliance/pii-audit`:
  - Samples N recent log entries, audit docs, exports.
  - Validates no raw PII; stores report JSON + summary CSV to compliance bucket.
- Provide manual run CLI `cmd/pii-audit` for auditors (supports `--since`/`--entity` flags).
- Update SOC2 controls checklist referencing generated reports; archive zipped evidence for each run.

## Acceptance Criteria
- ✅ Inventory document exists, version-controlled, referenced by onboarding checklist.
- ✅ Masking helper adopted by logging middleware, audit log writer, analytics exporters (unit tests verifying redaction).
- ✅ Deactivate-and-mask flow includes verification job with automated attestation records; fails closed with alerts.
- ✅ Cloud Logging filters + runbooks documented; PagerDuty alerts configured and tested.
- ✅ Compliance audit job runs on schedule, producing evidence accessible to privacy/compliance leads.
