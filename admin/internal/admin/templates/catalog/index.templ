package catalog

import (
	"fmt"
	"strings"

	"finitefield.org/hanko-admin/internal/admin/templates/components"
	"finitefield.org/hanko-admin/internal/admin/templates/helpers"
	"finitefield.org/hanko-admin/internal/admin/templates/layouts"
)

templ Index(data PageData) {
	@layouts.Base(data.Title, data.Breadcrumbs, pageBody(data))
}

templ pageBody(data PageData) {
	<div class="space-y-6" data-catalog-root>
		<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
			<div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
				<div class="space-y-2">
					<p class="text-sm font-semibold uppercase tracking-wide text-slate-500">ã‚«ã‚¿ãƒ­ã‚° / { data.KindLabel }</p>
					<h1 class="text-2xl font-semibold text-slate-900">{ data.Title }</h1>
					<p class="text-sm text-slate-600">{ data.Description }</p>
					if data.Summary.LastUpdated != "" {
						<p class="text-xs text-slate-400">æœ€çµ‚æ›´æ–° { data.Summary.LastUpdated }</p>
					}
				</div>
				<div class="flex flex-1 flex-wrap gap-3 lg:flex-none">
					@summaryChip("ç·æ•°", data.Summary.TotalLabel, "bg-slate-50 text-slate-900")
					@summaryChip("å…¬é–‹ä¸­", data.Summary.PublishedLabel, "bg-emerald-50 text-emerald-600")
					@summaryChip("ä¸‹æ›¸ã / ãƒ¬ãƒ“ãƒ¥ãƒ¼", fmt.Sprintf("%s / %s", data.Summary.DraftLabel, data.Summary.ReviewLabel), "bg-amber-50 text-amber-700")
				</div>
				<div class="flex items-center gap-3">
					@components.ButtonWith("ã‚¢ã‚»ãƒƒãƒˆã‚’ä½œæˆ", components.ButtonOptions{
						Variant: "primary",
						Href:    data.CreateURL,
					})
				</div>
			</div>
		<div class="mt-6">
			@components.UnderlineTabs(components.UnderlineTabsProps{Tabs: data.Tabs})
		</div>
		</section>

		<div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_320px]">
			<section class="space-y-4">
				@filterToolbar(data)
			@viewToggle(data.ViewToggle, false)
				@catalogView(data)
				@bulkBar(data.Bulk)
			</section>
			<aside id="catalog-drawer" class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				@Drawer(data.Drawer)
			</aside>
		</div>
	</div>
}

templ summaryChip(label, value, classes string) {
	<div class={ helpers.ClassList("flex min-w-[140px] flex-col gap-1 rounded-xl px-4 py-3 text-sm shadow-sm", classes) }>
		<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{ label }</p>
		<p class="text-lg font-semibold">{ value }</p>
	</div>
}

templ filterToolbar(data PageData) {
	<section class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
		<div class="flex flex-wrap items-center justify-between gap-3">
			<h2 class="text-sm font-semibold text-slate-700">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
			<div class="text-xs text-slate-400" id="catalog-loading">å¾…æ©Ÿä¸­</div>
		</div>
		<form
			class="mt-4 space-y-4"
			method="get"
			hx-get={ filterEndpoint(data) }
			hx-target="#catalog-view"
			hx-swap="outerHTML"
			hx-indicator="#catalog-loading"
			hx-push-url="true"
		>
			<input type="hidden" id="catalog-view-field" name="view" value={ data.ViewToggle.Active } />
			<div class="flex flex-wrap gap-2" role="group" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
				for _, option := range data.Filters.Statuses {
					<label class={ statusFilterClass(option.Active, option.Tone) }>
						<input type="checkbox" name="status" value={ option.Value } class="sr-only" checked?={ option.Active } />
						<span class="text-xs font-semibold">
							{ option.Label }
							if option.Count > 0 {
								<span class="ml-1 text-[11px] text-slate-400">({ option.Count })</span>
							}
						</span>
					</label>
				}
			</div>

			<div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
				<div class="flex flex-col gap-1">
					<label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="catalog-owner">æ‹…å½“è€…</label>
					<select id="catalog-owner" name="owner" class="rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200">
						<option value="">ã™ã¹ã¦</option>
						for _, option := range data.Filters.Owners {
							<option value={ option.Value } selected?={ option.Active }>
								{ option.Label }
								if option.Count > 0 {
									{ fmt.Sprintf(" (%d)", option.Count) }
								}
							</option>
						}
					</select>
				</div>
				<div class="flex flex-col gap-1">
					<label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="catalog-tags">ã‚¿ã‚°</label>
					<select
						id="catalog-tags"
						name="tag"
						multiple
						class="min-h-[72px] rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
					>
						for _, option := range data.Filters.Tags {
							<option value={ option.Value } selected?={ option.Active }>{ option.Label }</option>
						}
					</select>
					<p class="text-xs text-slate-400">Ctrl/Cmdã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</p>
				</div>
				<div class="flex flex-col gap-1">
					<label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="catalog-updated">æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
					<select id="catalog-updated" name="updated" class="rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200">
						<option value="">æŒ‡å®šãªã—</option>
						for _, option := range data.Filters.Updated {
							<option value={ option.Value } selected?={ option.Active }>{ option.Label }</option>
						}
					</select>
				</div>
			</div>

			<div class="flex flex-wrap items-center gap-3">
				<div class="flex flex-1 items-center gap-2 rounded-lg border border-slate-300 px-3 py-2 focus-within:ring-2 focus-within:ring-brand-200">
					<span class="text-slate-400">ğŸ”</span>
					<input
						type="search"
						name="q"
						value={ data.Query.Search }
						placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã€IDã€ã‚¿ã‚°ã§æ¤œç´¢"
						class="flex-1 border-none p-0 text-sm text-slate-900 focus:outline-none"
					/>
				</div>
				<button type="submit" class={ helpers.ButtonClass("primary", "sm", false, false) }>é©ç”¨</button>
			<a href={ helpers.BuildURL(data.PagePath, "") } class={ helpers.ButtonClass("ghost", "sm", false, false) }>ãƒªã‚»ãƒƒãƒˆ</a>
		</div>
	</form>
	</section>
}

	templ viewToggle(toggle ViewToggle, swap bool) {
		<div
			id="catalog-view-toggle"
			class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white p-4 shadow-sm"
			hx-swap-oob?={ swap }
		>
			<div>
				<p class="text-sm font-semibold text-slate-700">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</p>
				<p class="text-xs text-slate-400">ä¸€è¦§ or ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼</p>
		</div>
		<div class="flex gap-2">
			for _, option := range toggle.Options {
				<button
					type="button"
					class={ viewToggleClass(option.Active) }
					hx-get={ option.Endpoint }
					hx-target="#catalog-view"
					hx-swap="outerHTML"
					hx-push-url={ option.PushURL }
					data-view-toggle={ option.Value }
				>
					<span>{ option.Icon }</span>
					<span>{ option.Label }</span>
				</button>
			}
		</div>
	</div>
}

templ catalogView(data PageData) {
	if data.ViewToggle.Active == "cards" {
		@CardsSection(data.Cards)
	} else {
		@TableSection(data.Table)
	}
}

templ TableSection(data TableData) {
	<div
		id="catalog-view"
		class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm"
		hx-target="this"
		hx-swap="outerHTML"
	>
		if len(data.Rows) == 0 {
			<div class="px-6 py-12 text-center text-sm text-slate-500">{ data.EmptyMessage }</div>
		} else {
			<table class="min-w-full divide-y divide-slate-200">
				<thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
					<tr>
						<th scope="col" class="px-4 py-3 text-left">ã‚¢ã‚»ãƒƒãƒˆ</th>
						<th scope="col" class="px-4 py-3 text-left">æ‹…å½“</th>
						<th scope="col" class="px-4 py-3 text-left">æ›´æ–°</th>
						<th scope="col" class="px-4 py-3 text-left">åˆ©ç”¨çŠ¶æ³</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-slate-200 text-sm text-slate-700">
					for _, row := range data.Rows {
						<tr
						class={ rowClass(row.Selected) }
						hx-get={ helpers.BuildURL(data.FragmentPath, helpers.SetRawQuery(data.RawQuery, "selected", row.ID)) }
						hx-target="#catalog-view"
						hx-swap="outerHTML"
						hx-push-url={ helpers.BuildURL(data.PagePath, helpers.SetRawQuery(data.RawQuery, "selected", row.ID)) }
						role="button"
						tabindex="0"
						>
							<td class="px-4 py-4">
								<div class="flex gap-4">
									if row.PreviewURL != "" {
										<img src={ row.PreviewURL } alt={ row.PreviewAlt } class="h-12 w-12 rounded-lg object-cover ring-1 ring-slate-200" />
									}
									<div class="space-y-1">
										<div class="flex items-center gap-2">
											<p class="font-semibold text-slate-900">{ row.Name }</p>
											if row.Badge != "" {
												@components.Badge(row.Badge, row.BadgeTone)
											}
										</div>
										<p class="text-xs text-slate-500">{ row.Identifier }</p>
										<p class="text-xs text-slate-500">{ row.Description }</p>
										<div class="flex flex-wrap gap-1 text-[11px] text-slate-500">
											for _, tag := range row.Tags {
												<span class="rounded-full bg-slate-100 px-2 py-0.5">{ tag }</span>
											}
										</div>
									</div>
								</div>
							</td>
							<td class="px-4 py-4">
								<div class="flex items-center gap-2">
									<div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-xs font-semibold text-slate-600">{ row.OwnerInitials }</div>
									<div>
										<p class="font-medium">{ row.Owner }</p>
										<p class="text-xs text-slate-500">{ row.StatusLabel }</p>
									</div>
								</div>
							</td>
							<td class="px-4 py-4">
								<p class="font-medium text-slate-900">{ row.UpdatedLabel }</p>
								<p class="text-xs text-slate-500">{ row.UpdatedRelative }</p>
							</td>
							<td class="px-4 py-4">
								<p class="font-medium text-slate-900">{ row.UsageLabel }</p>
								<div class="flex flex-wrap gap-2 text-xs text-slate-500">
									for _, metric := range row.Metrics {
										<span>{ metric.Icon } { metric.Label }: { metric.Value }</span>
									}
								</div>
							</td>
						</tr>
					}
				</tbody>
			</table>
		}
	</div>
	<div id="catalog-drawer" hx-swap-oob="true">
		@Drawer(data.Drawer)
	</div>
	@viewToggle(data.View, true)
	<input type="hidden" id="catalog-view-field" name="view" value={ data.View.Active } hx-swap-oob="true" />
}

templ CardsSection(data CardsData) {
	<div
		id="catalog-view"
		class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm"
		hx-target="this"
		hx-swap="outerHTML"
	>
		if len(data.Cards) == 0 {
			<div class="py-12 text-center text-sm text-slate-500">{ data.EmptyMessage }</div>
		} else {
			<div class="grid gap-4 md:grid-cols-2">
				for _, card := range data.Cards {
					<article
					class={ cardClass(card.Selected) }
					hx-get={ helpers.BuildURL(data.FragmentPath, helpers.SetRawQuery(data.RawQuery, "selected", card.ID)) }
					hx-target="#catalog-view"
					hx-swap="outerHTML"
					hx-push-url={ helpers.BuildURL(data.PagePath, helpers.SetRawQuery(data.RawQuery, "selected", card.ID)) }
				>
						<div class="flex items-center justify-between gap-3">
							<div>
								<h3 class="text-base font-semibold text-slate-900">{ card.Title }</h3>
								<p class="text-xs text-slate-500">{ card.Subtitle }</p>
							</div>
							@components.Badge(card.StatusLabel, card.StatusTone)
						</div>
						if card.PreviewURL != "" {
							<img src={ card.PreviewURL } alt={ card.PreviewAlt } class="mt-3 h-32 w-full rounded-xl object-cover ring-1 ring-slate-200" />
						}
						<p class="mt-3 text-sm text-slate-600">{ card.UsageLabel }</p>
						<div class="mt-2 flex flex-wrap gap-2 text-xs text-slate-500">
							for _, metric := range card.Metrics {
								<span>{ metric.Icon } { metric.Label }: { metric.Value }</span>
							}
						</div>
						<div class="mt-3 flex flex-wrap gap-1 text-[11px] text-slate-500">
							for _, tag := range card.Tags {
								<span class="rounded-full bg-slate-100 px-2 py-0.5">{ tag }</span>
							}
						</div>
					</article>
				}
			</div>
		}
	</div>
	<div id="catalog-drawer" hx-swap-oob="true">
		@Drawer(data.Drawer)
	</div>
	@viewToggle(data.View, true)
	<input type="hidden" id="catalog-view-field" name="view" value={ data.View.Active } hx-swap-oob="true" />
}

templ Drawer(data DrawerData) {
	if data.Empty {
		<div class="space-y-2 text-sm text-slate-500">
			<h2 class="text-base font-semibold text-slate-900">è©³ç´°</h2>
			<p>ã‚¢ã‚»ãƒƒãƒˆã‚’é¸æŠã™ã‚‹ã¨ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
		</div>
		return
	}
	<div class="space-y-4">
		<div class="space-y-2">
			<div class="flex items-center gap-2">
				<h2 class="text-lg font-semibold text-slate-900">{ data.Title }</h2>
				@components.Badge(data.StatusLabel, data.StatusTone)
			</div>
			<p class="text-xs uppercase tracking-wide text-slate-400">{ data.KindLabel }</p>
			<p class="text-sm text-slate-600">{ data.Description }</p>
			<p class="text-xs text-slate-400">æ›´æ–° { data.UpdatedLabel }</p>
		</div>
		if data.PreviewURL != "" {
			<img src={ data.PreviewURL } alt={ data.PreviewAlt } class="w-full rounded-xl object-cover ring-1 ring-slate-200" />
		}
		<div class="rounded-xl bg-slate-50 p-3 text-sm">
			<p class="font-semibold text-slate-800">æ‹…å½“è€…</p>
			<p class="text-slate-600">{ data.Owner.Name }</p>
			<p class="text-xs text-slate-400">{ data.Owner.Email }</p>
		</div>
		if len(data.Usage) > 0 {
			<div>
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">åˆ©ç”¨çŠ¶æ³</p>
				<ul class="mt-2 space-y-1 text-sm text-slate-600">
					for _, metric := range data.Usage {
						<li>{ metric.Icon } { metric.Label }: { metric.Value }</li>
					}
				</ul>
			</div>
		}
		if len(data.Metadata) > 0 {
			<div>
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</p>
				<dl class="mt-2 space-y-1 text-sm text-slate-600">
					for _, item := range data.Metadata {
						<div class="flex justify-between gap-3">
							<dt class="text-slate-500">{ item.Icon } { item.Key }</dt>
							<dd class="font-medium text-slate-900">{ item.Value }</dd>
						</div>
					}
				</dl>
			</div>
		}
		if len(data.Dependencies) > 0 {
			<div>
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ä¾å­˜é–¢ä¿‚</p>
				<div class="mt-2 space-y-2">
					for _, dep := range data.Dependencies {
						<div class="flex flex-col rounded-xl border border-slate-200 px-3 py-2">
							<p class="font-semibold text-slate-800">{ dep.Label }</p>
							<p class="text-xs text-slate-500">{ dep.Kind } / { dep.Status }</p>
						</div>
					}
				</div>
			</div>
		}
		if len(data.Audit) > 0 {
			<div>
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">æ›´æ–°å±¥æ­´</p>
				<ul class="mt-2 space-y-2 text-xs text-slate-500">
					for _, entry := range data.Audit {
						<li>
							<p class="font-semibold text-slate-700">{ entry.Actor }</p>
							<p>{ entry.Timestamp } / { entry.Action } ({ entry.Channel })</p>
						</li>
					}
				</ul>
			</div>
		}
		if len(data.Tags) > 0 {
			<div class="flex flex-wrap gap-1 text-[11px] text-slate-500">
				for _, tag := range data.Tags {
					<span class="rounded-full bg-slate-100 px-2 py-0.5">{ tag }</span>
				}
			</div>
		}
	</div>
}

templ bulkBar(data BulkBarData) {
	if !data.Visible {
		return
	}
	<div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm">
		<p class="font-medium text-slate-700">{ data.Summary }</p>
		<div class="flex flex-wrap gap-2">
			for _, action := range data.Actions {
				<button type="button" class={ helpers.ButtonClass(action.Tone, "sm", false, action.Disabled) } disabled?={ action.Disabled }>
					{ action.Label }
				</button>
			}
		</div>
	</div>
}

func viewToggleClass(active bool) string {
	base := "inline-flex items-center gap-1 rounded-full px-3 py-1.5 text-sm font-medium shadow-sm transition"
	if active {
		return base + " bg-slate-900 text-white"
	}
	return base + " bg-slate-100 text-slate-600 hover:bg-slate-200"
}

func statusFilterClass(active bool, tone string) string {
	class := "inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold transition"
	if active {
		return class + " border-brand-500 bg-brand-50 text-brand-700"
	}
	return class + " border-slate-200 bg-slate-50 text-slate-500 hover:border-slate-300"
}

func rowClass(selected bool) string {
	base := "cursor-pointer transition hover:bg-slate-50 focus-within:bg-slate-50"
	if selected {
		return base + " bg-brand-50"
	}
	return base
}

func cardClass(selected bool) string {
	base := "rounded-2xl border px-4 py-4 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md"
	if selected {
		return base + " border-brand-400 bg-brand-50"
	}
	return base + " border-slate-200 bg-white"
}

func filterEndpoint(data PageData) string {
	if strings.TrimSpace(data.ViewToggle.Active) == "cards" {
		return helpers.BuildURL(data.CardsEndpoint, data.Cards.RawQuery)
	}
	return helpers.BuildURL(data.TableEndpoint, data.Table.RawQuery)
}
