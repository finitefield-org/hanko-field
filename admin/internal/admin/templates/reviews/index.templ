package reviews

import (
	"fmt"

	"finitefield.org/hanko-admin/internal/admin/templates/helpers"
	"finitefield.org/hanko-admin/internal/admin/templates/layouts"
)

templ Index(data PageData) {
	@layouts.Base(data.Title, data.Breadcrumbs, pageBody(data))
}

templ pageBody(data PageData) {
	<div class="space-y-6" data-reviews-root>
		<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
			<div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
				<div class="space-y-2">
					<h1 class="text-2xl font-semibold text-slate-900">{ data.Title }</h1>
					<p class="text-sm text-slate-600">{ data.Description }</p>
					if data.Table.LastUpdated != "" {
						<p class="text-xs text-slate-400">æœ€çµ‚æ›´æ–° { data.Table.LastUpdated }
							if data.Table.LastRelative != "" {
								<span> ({ data.Table.LastRelative })</span>
							}
						</p>
					}
				</div>
				<div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
					for _, chip := range data.SummaryChips {
						@summaryChip(chip)
					}
				</div>
			</div>
			if len(data.Productivity) > 0 {
				<div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
					for _, card := range data.Productivity {
						@productivityCard(card)
					}
				</div>
			}
		</section>

		<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
			@filterToolbar(data)
		</section>

		<section class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_360px]" data-reviews-pane>
			<div class="space-y-3">
				<div
					id="reviews-table"
					hx-target="this"
					hx-swap="outerHTML"
					class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm"
				>
					@TableSection(data.Table)
				</div>
			</div>
			<aside class="hidden xl:block">
				<div id="reviews-detail" class="sticky top-20 space-y-4">
					@DetailPane(data.Detail)
				</div>
			</aside>
		</section>
	</div>
}

templ summaryChip(chip SummaryChip) {
	<div class={ summaryChipClass(chip.Tone) } title={ chip.Tooltip }>
		<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">
			if chip.Icon != "" {
				<span aria-hidden="true" class="mr-1">{ chip.Icon }</span>
			}
			{ chip.Label }
		</p>
		<p class="text-lg font-semibold text-slate-900">{ chip.Value }</p>
	</div>
}

templ productivityCard(card ProductivityCard) {
	<div class={ productivityCardClass(card.Tone) }>
		<div class="flex items-center gap-3">
			if card.Icon != "" {
				<div class="flex h-10 w-10 items-center justify-center rounded-full bg-white/80 text-base">{ card.Icon }</div>
			}
			<div class="space-y-1">
				<p class="text-xs font-semibold uppercase tracking-wide">{ card.Label }</p>
				<p class="text-lg font-semibold">{ card.Value }</p>
				if card.Subtext != "" {
					<p class="text-xs text-slate-700">{ card.Subtext }</p>
				}
			</div>
		</div>
	</div>
}

templ filterToolbar(data PageData) {
	<form
		class="space-y-5"
		method="get"
		hx-get={ data.TableEndpoint }
		hx-target="#reviews-table"
		hx-push-url="true"
	>
		<input type="hidden" name="moderation" value={ data.Query.Moderation } />
		<input type="hidden" name="sort" value={ data.Query.Sort } />
		if data.SelectedID != "" {
			<input type="hidden" name="selected" value={ data.SelectedID } />
		}

		<div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
			<div class="flex flex-wrap items-center gap-3">
				<label class="sr-only" for="reviews-search">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
				<div class="relative">
					<input
						id="reviews-search"
						name="q"
						type="search"
						value={ data.Query.Search }
						placeholder="æœ¬æ–‡ãƒ»é¡§å®¢ãƒ»æ³¨æ–‡ç•ªå·ã§æ¤œç´¢"
						class="w-72 rounded-lg border border-slate-300 bg-white py-2 pl-8 pr-3 text-sm text-slate-900 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
					/>
					<span class="pointer-events-none absolute inset-y-0 left-2 flex items-center text-slate-400">ğŸ”</span>
				</div>
				<button type="submit" class={ helpers.ButtonClass("primary", "sm", false, false) }>é©ç”¨</button>
				<a href={ data.ResetURL } class={ helpers.ButtonClass("ghost", "sm", false, false) }>ãƒªã‚»ãƒƒãƒˆ</a>
			</div>
			<div class="flex items-center gap-3">
				<label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="reviews-age">çµŒéæ™‚é–“</label>
				<select
					id="reviews-age"
					name="age"
					class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
				>
					<option value="">ã™ã¹ã¦</option>
					for _, bucket := range data.Filters.AgeBuckets {
						<option value={ bucket.Value } selected?={ bucket.Active }>{ bucket.Label }</option>
					}
				</select>
			</div>
		</div>

		<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
			<div class="flex flex-col gap-2">
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ãƒãƒ£ãƒãƒ«</p>
				<div class="flex flex-wrap gap-2">
					for _, channel := range data.Filters.Channels {
						<label class={ filterChipClass(channel.Selected) }>
							<input type="checkbox" name="channel" value={ channel.Value } class="sr-only" checked?={ channel.Selected } />
							<span class="text-sm font-medium">
								{ channel.Label }
								if channel.Count > 0 {
									<span class="text-xs text-slate-400">({ channel.Count })</span>
								}
							</span>
						</label>
					}
				</div>
			</div>
			<div class="flex flex-col gap-2">
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">è©•ä¾¡</p>
				<div class="flex flex-wrap gap-2">
					for _, rating := range data.Filters.Ratings {
						<label class={ ratingChipClass(rating.Active) }>
							<input type="checkbox" name="rating" value={ fmt.Sprintf("%d", rating.Value) } class="sr-only" checked?={ rating.Active } />
							<span class="text-sm font-medium">
								{ rating.Label }
								if rating.Count > 0 {
									<span class="text-xs text-slate-400">({ rating.Count })</span>
								}
							</span>
						</label>
					}
				</div>
			</div>
			<div class="flex flex-col gap-2">
				<p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ãƒ•ãƒ©ã‚°</p>
				<div class="flex flex-wrap gap-2">
					for _, flag := range data.Filters.Flags {
						<label class={ flagChipClass(flag.Tone, flag.Active) } title={ flag.Description }>
							<input type="checkbox" name="flag" value={ flag.Value } class="sr-only" checked?={ flag.Active } />
							<span class="text-sm font-medium">
								{ flag.Label }
								if flag.Count > 0 {
									<span class="text-xs text-slate-400">({ flag.Count })</span>
								}
							</span>
						</label>
					}
				</div>
			</div>
			<div class="flex flex-col gap-2">
				<label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="reviews-product">å•†å“</label>
				<select
					id="reviews-product"
					name="product"
					class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
				>
					<option value="">ã™ã¹ã¦</option>
					for _, product := range data.Filters.Products {
						<option value={ product.Value } selected?={ product.Selected }>
							{ product.Label }
							if product.Count > 0 {
								<span> ({ product.Count })</span>
							}
						</option>
					}
				</select>
			</div>
		</div>

		<div class="htmx-indicator text-xs text-slate-400">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
	</form>
}

func summaryChipClass(tone string) string {
	base := []string{"rounded-xl border px-4 py-3 shadow-sm"}
	switch tone {
	case "success":
		base = append(base, "border-emerald-100 bg-emerald-50 text-emerald-700")
	case "warning":
		base = append(base, "border-amber-100 bg-amber-50 text-amber-700")
	case "danger":
		base = append(base, "border-rose-100 bg-rose-50 text-rose-700")
	default:
		base = append(base, "border-sky-100 bg-sky-50 text-sky-700")
	}
	return helpers.ClassList(base...)
}

func productivityCardClass(tone string) string {
	base := []string{"rounded-xl border px-4 py-3 shadow-sm text-slate-900"}
	switch tone {
	case "success":
		base = append(base, "border-emerald-200 bg-emerald-100/70")
	case "warning":
		base = append(base, "border-amber-200 bg-amber-100/70")
	case "danger":
		base = append(base, "border-rose-200 bg-rose-100/70")
	default:
		base = append(base, "border-slate-200 bg-slate-100/70")
	}
	return helpers.ClassList(base...)
}

func filterChipClass(selected bool) string {
	base := []string{"inline-flex items-center rounded-full border px-3 py-1.5 text-sm font-medium transition"}
	if selected {
		base = append(base, "border-brand-500 bg-brand-50 text-brand-700 shadow-sm")
	} else {
		base = append(base, "border-slate-200 text-slate-600 hover:border-brand-200 hover:text-brand-600")
	}
	return helpers.ClassList(base...)
}

func ratingChipClass(selected bool) string {
	base := []string{"inline-flex items-center rounded-full border px-3 py-1.5 text-sm font-medium transition"}
	if selected {
		base = append(base, "border-amber-400 bg-amber-50 text-amber-700 shadow-sm")
	} else {
		base = append(base, "border-slate-200 text-slate-600 hover:border-amber-200 hover:text-amber-700")
	}
	return helpers.ClassList(base...)
}

func flagChipClass(tone string, selected bool) string {
	base := []string{"inline-flex items-center rounded-full border px-3 py-1.5 text-sm font-medium transition"}
	switch tone {
	case "danger":
		if selected {
			base = append(base, "border-rose-500 bg-rose-50 text-rose-700 shadow-sm")
		} else {
			base = append(base, "border-rose-200 text-rose-600 hover:border-rose-400 hover:text-rose-700")
		}
	case "warning":
		if selected {
			base = append(base, "border-amber-500 bg-amber-50 text-amber-700 shadow-sm")
		} else {
			base = append(base, "border-amber-200 text-amber-600 hover:border-amber-400 hover:text-amber-700")
		}
	default:
		if selected {
			base = append(base, "border-sky-500 bg-sky-50 text-sky-700 shadow-sm")
		} else {
			base = append(base, "border-slate-200 text-slate-600 hover:border-sky-200 hover:text-sky-700")
		}
	}
	return helpers.ClassList(base...)
}
