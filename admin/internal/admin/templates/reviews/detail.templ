package reviews

import (
	"strings"

	"finitefield.org/hanko-admin/internal/admin/templates/helpers"
)

templ DetailPane(detail DetailData) {
	<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
		if detail.Empty {
			<div class="space-y-2 text-sm text-slate-600">
				<p class="text-base font-semibold text-slate-900">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
				<p>ä¸€è¦§ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
			</div>
			return
		}

		<div class="space-y-6">
			<header class="space-y-4 border-b border-slate-200 pb-4">
				<div class="flex flex-col gap-3">
					<div class="flex flex-wrap items-center justify-between gap-3">
						<div class="flex items-center gap-3">
							@ratingStars(detail.Review.Rating)
							<div class="text-xs text-slate-500">
								<span>{ detail.Review.SubmittedRelative }</span>
								<span class="ml-2 text-slate-400">{ detail.Review.SubmittedAt }</span>
							</div>
						</div>
						if len(detail.Review.Moderation.Actions) > 0 {
							<div class="flex flex-wrap items-center gap-2">
								for _, action := range detail.Review.Moderation.Actions {
									@moderationActionButton(action)
								}
							</div>
						}
					</div>
					<h2 class="text-xl font-semibold text-slate-900">{ detail.Review.Title }</h2>
					<p class="text-sm leading-relaxed text-slate-700 whitespace-pre-line">{ detail.Review.Body }</p>
				</div>
				<div class="flex flex-wrap items-center gap-2 text-xs">
					<span class={ channelBadgeClass(detail.Review.ChannelTone) }>
						{ detail.Review.ChannelIcon } { detail.Review.ChannelLabel }
					</span>
					<span class={ moderationBadgeClass(detail.Review.Moderation.StatusTone) }>
						{ detail.Review.Moderation.StatusLabel }
					</span>
					<span class="text-slate-500">Helpful ğŸ‘ { detail.Review.HelpfulYes } / ğŸ‘ { detail.Review.HelpfulNo }</span>
				</div>
			</header>

			if len(detail.Review.Flags) > 0 {
				<section class="space-y-2">
					<h3 class="text-sm font-semibold text-slate-900">ãƒ•ãƒ©ã‚° / æ³¨æ„äº‹é …</h3>
					<ul class="space-y-2 text-sm text-slate-700">
						for _, flag := range detail.Review.Flags {
							<li class={ detailFlagClass(flag.Tone) }>
								<div class="flex items-center justify-between">
									<span class="font-medium">{ flag.Label }</span>
									<span class="text-xs text-slate-400">{ flag.Occurred }</span>
								</div>
								if flag.Description != "" {
									<p>{ flag.Description }</p>
								}
								if flag.Actor != "" {
									<p class="text-xs text-slate-500">æ‹…å½“: { flag.Actor }</p>
								}
							</li>
						}
					</ul>
				</section>
			}

			if len(detail.Review.Attachments) > 0 {
				<section class="space-y-2">
					<h3 class="text-sm font-semibold text-slate-900">æ·»ä»˜</h3>
					<div class="grid grid-cols-3 gap-3">
						for _, attachment := range detail.Review.Attachments {
							<a href={ attachment.URL } target="_blank" rel="noreferrer" class="group block overflow-hidden rounded-lg border border-slate-200">
								<img src={ firstNonEmpty(attachment.ThumbURL, attachment.URL) } alt={ attachment.Label } class="h-28 w-full object-cover transition group-hover:scale-105" />
								if attachment.Label != "" {
									<p class="px-2 py-1 text-xs text-slate-500">{ attachment.Label }</p>
								}
							</a>
						}
					</div>
				</section>
			}

			<section class="grid gap-4 md:grid-cols-2">
				<div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
					<h3 class="text-sm font-semibold text-slate-900">é¡§å®¢æƒ…å ±</h3>
					<div class="mt-3 space-y-2 text-sm text-slate-700">
						<p class="font-medium text-slate-900">{ detail.Review.Customer.Name }</p>
						if detail.Review.Customer.Email != "" {
							<p>{ detail.Review.Customer.Email }</p>
						}
						if detail.Review.Customer.Location != "" {
							<p>{ detail.Review.Customer.Location }</p>
						}
						if detail.Review.Customer.Segment != "" {
							<p class="text-xs text-slate-500">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ: { detail.Review.Customer.Segment }</p>
						}
						<p class="text-xs text-slate-500">
							æ³¨æ–‡æ•° { detail.Review.Customer.OrderCount } / æœ€çµ‚æ³¨æ–‡ { detail.Review.Customer.LastOrder }
						</p>
					</div>
				</div>
				<div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
					<h3 class="text-sm font-semibold text-slate-900">å•†å“ / æ³¨æ–‡</h3>
					<div class="mt-3 flex items-start gap-3">
						if detail.Review.Product.ImageURL != "" {
							<img src={ detail.Review.Product.ImageURL } alt={ detail.Review.Product.Name } class="h-16 w-16 rounded-md border border-slate-200 object-cover" />
						}
						<div class="space-y-1 text-sm text-slate-700">
							<p class="font-medium text-slate-900">{ detail.Review.Product.Name }</p>
							if detail.Review.Product.Variant != "" {
								<p>{ detail.Review.Product.Variant }</p>
							}
							if detail.Review.Product.SKU != "" {
								<p class="text-xs text-slate-500">SKU: { detail.Review.Product.SKU }</p>
							}
							<p class="text-xs text-slate-500">å˜ä¾¡ { detail.Review.Product.PriceLabel }</p>
							<a href={ detail.Review.Product.DetailURL } class="text-xs font-medium text-brand-600 hover:underline">å•†å“ã‚’é–‹ã</a>
							<a href={ detail.Review.Product.OrderURL } class="text-xs font-medium text-brand-600 hover:underline">æ³¨æ–‡ #{ detail.Review.Product.OrderNumber }</a>
						</div>
					</div>
				</div>
			</section>

			<section class="space-y-3">
				<div class="flex items-center justify-between">
					<h3 class="text-sm font-semibold text-slate-900">ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢</h3>
					<span class={ moderationBadgeClass(detail.Review.Moderation.StatusTone) }>
						{ detail.Review.Moderation.StatusLabel }
					</span>
				</div>
				if detail.Review.Moderation.Notes != "" {
					<p class="rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700">{ detail.Review.Moderation.Notes }</p>
				}
				<p class="text-xs text-slate-500">
					æœ€çµ‚æ›´æ–° { detail.Review.Moderation.LastOccurred } / æ‹…å½“ { detail.Review.Moderation.LastActor }
				</p>
				if len(detail.Review.Moderation.History) > 0 {
					<ol class="space-y-2 border-l-2 border-slate-200 pl-4 text-sm text-slate-700">
						for _, event := range detail.Review.Moderation.History {
							<li>
								<p class="font-semibold text-slate-900">{ event.Label } ãƒ» { event.Outcome }</p>
								if event.Reason != "" {
									<p>{ event.Reason }</p>
								}
								<p class="text-xs text-slate-500">
									{ event.Actor } / { event.Occurred }
								</p>
							</li>
						}
					</ol>
				}
			</section>

			<section class="space-y-3">
				<div class="flex items-center justify-between">
					<h3 class="text-sm font-semibold text-slate-900">è¿”ä¿¡å±¥æ­´</h3>
					if detail.Review.ReplyActionURL != "" {
						<button
							type="button"
							class={ helpers.ButtonClass("ghost", "sm", false, false) }
							hx-get={ detail.Review.ReplyActionURL }
							hx-target="#modal"
							hx-swap="innerHTML"
						>
							è¿”ä¿¡ã‚’è¨˜éŒ²
						</button>
					}
				</div>
				if len(detail.Review.Replies) == 0 {
					<p class="text-sm text-slate-500">ã¾ã è¿”ä¿¡ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
				} else {
					<ol class="space-y-3">
						for _, reply := range detail.Review.Replies {
							<li class="space-y-2 rounded-lg border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700">
								<div class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
									<span class="font-semibold text-slate-700">{ reply.Author }</span>
									<span>{ reply.CreatedRelative } ãƒ» { reply.CreatedAt }</span>
								</div>
								<p class="whitespace-pre-line">{ reply.Body }</p>
								<div class="flex flex-wrap gap-2 text-xs">
									<span class={ replyVisibilityClass(reply.IsPublic) }>{ replyVisibilityLabel(reply.IsPublic) }</span>
									if reply.Notified {
										<span class="inline-flex items-center rounded-full bg-sky-100 px-2 py-1 font-medium text-sky-700">é¡§å®¢é€šçŸ¥æ¸ˆã¿</span>
									}
								</div>
							</li>
						}
					</ol>
				}
			</section>

			<section class="space-y-3 rounded-lg border border-slate-200 bg-slate-50 p-4">
				<h3 class="text-sm font-semibold text-slate-900">ã‚¹ãƒˆã‚¢ãƒ•ãƒ­ãƒ³ãƒˆè¡¨ç¤ºãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
				<div class="space-y-2">
					<div class="flex items-center gap-2 text-amber-500">
						@ratingStars(detail.Review.Preview.Rating)
						<span class="text-xs text-slate-500">{ detail.Review.Preview.Submitted }</span>
					</div>
					<p class="text-sm font-semibold text-slate-900">{ detail.Review.Preview.Headline }</p>
					<p class="text-sm text-slate-700">{ detail.Review.Preview.Body }</p>
					if len(detail.Review.Preview.Photos) > 0 {
						<div class="flex gap-2">
							for _, photo := range detail.Review.Preview.Photos {
								<img src={ firstNonEmpty(photo.ThumbURL, photo.URL) } alt={ photo.Label } class="h-16 w-16 rounded-md border border-slate-200 object-cover" />
							}
						</div>
					}
					<p class="text-xs text-slate-500">è¡¨ç¤ºå: { detail.Review.Preview.DisplayName } / å•†å“: { detail.Review.Preview.ProductName }</p>
				</div>
			</section>
		</div>
	</section>
}

templ moderationActionButton(action ActionButton) {
    <button
        type="button"
        class={ helpers.ButtonClass(action.Variant, "sm", false, false) }
		disabled?={ action.Disabled }
		if action.HxGet != "" {
			hx-get={ action.HxGet }
		}
		if action.HxTarget != "" {
			hx-target={ action.HxTarget }
		}
		if action.HxSwap != "" {
			hx-swap={ action.HxSwap }
		}
	>
		if action.Icon != "" {
			<span class="mr-2">{ action.Icon }</span>
		}
		<span>{ action.Label }</span>
	</button>
}

func detailFlagClass(tone string) string {
	switch tone {
	case "danger":
		return "rounded-lg border border-rose-200 bg-rose-50 px-3 py-2"
	case "warning":
		return "rounded-lg border border-amber-200 bg-amber-50 px-3 py-2"
	case "info":
		return "rounded-lg border border-sky-200 bg-sky-50 px-3 py-2"
	default:
		return "rounded-lg border border-slate-200 bg-white px-3 py-2"
	}
}

func firstNonEmpty(values ...string) string {
	for _, v := range values {
		if strings.TrimSpace(v) != "" {
			return v
		}
	}
	return ""
}

func replyVisibilityClass(public bool) string {
	if public {
		return "inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 font-medium text-emerald-700"
	}
	return "inline-flex items-center rounded-full bg-slate-200 px-2 py-1 font-medium text-slate-700"
}

func replyVisibilityLabel(public bool) string {
	if public {
		return "å…¬é–‹"
	}
	return "å†…éƒ¨ãƒ¡ãƒ¢"
}
