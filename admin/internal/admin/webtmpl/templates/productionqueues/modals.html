{{define "production-queues/upsert-modal"}}
<div class="modal-backdrop" data-modal-state="open">
  <div class="{{modalPanelClass "lg"}}">
    <div class="modal-header">
      <h2 class="modal-title">{{.Title}}</h2>
      <button type="button" class="modal-close" data-modal-dismiss aria-label="閉じる">×</button>
    </div>
    <div class="modal-body">
      <form
        class="space-y-6 text-sm text-slate-700"
        hx-target="#modal"
        hx-swap="innerHTML"
        {{if eq .Method "PUT"}}
          hx-put="{{.ActionURL}}"
        {{else}}
          hx-post="{{.ActionURL}}"
        {{end}}
      >
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
        {{if .Form.ID}}
          <input type="hidden" name="queue_id" value="{{.Form.ID}}" />
        {{end}}
        {{if .ReturnQuery}}
          <input type="hidden" name="return_query" value="{{.ReturnQuery}}" />
        {{end}}
        {{if .Error}}
          <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700">{{.Error}}</div>
        {{end}}

        <section class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-xs">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">基本情報</p>
            <p class="text-xs text-slate-500">名称、所属工房、優先度を設定します。</p>
          </div>
          <div class="grid gap-4 md:grid-cols-2">
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">キュー名</span>
              <input
                type="text"
                name="name"
                required
                value="{{.Form.Name}}"
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                placeholder="例: 青山アトリエ"
              />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">工房</span>
              <input
                type="text"
                name="workshop"
                required
                value="{{.Form.Workshop}}"
                list="queue-workshop-suggestions"
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                placeholder="例: 青山工房"
              />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">プロダクトライン</span>
              <input
                type="text"
                name="product_line"
                value="{{.Form.ProductLine}}"
                list="queue-product-suggestions"
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                placeholder="例: Classic / Brilliant"
              />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">優先度</span>
              <select
                name="priority"
                required
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
              >
                {{range .Options.PriorityOptions}}
                  <option value="{{.Value}}" {{if eq .Value $.Form.Priority}}selected{{end}}>{{.Label}}</option>
                {{end}}
              </select>
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">キュー容量</span>
              <input
                type="number"
                name="capacity"
                min="1"
                value="{{fmtInt .Form.Capacity}}"
                required
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
              />
            </label>
            <label class="flex flex-col gap-1 text-sm text-slate-600">
              <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">ターゲットSLA (時間)</span>
              <input
                type="number"
                name="target_sla_hours"
                min="1"
                value="{{fmtInt .Form.TargetSLAHours}}"
                required
                class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
              />
            </label>
            <label class="flex items-center gap-2 text-sm text-slate-600">
              <input
                type="checkbox"
                name="active"
                value="true"
                {{if .Form.Active}}checked{{end}}
                class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
              />
              <span>稼働中として公開</span>
            </label>
          </div>
          <label class="flex flex-col gap-1 text-sm text-slate-600 md:col-span-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">説明</span>
            <textarea
              name="description"
              rows="3"
              class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
            >{{.Form.Description}}</textarea>
          </label>
          <label class="flex flex-col gap-1 text-sm text-slate-600 md:col-span-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">メモ</span>
            <textarea
              name="notes"
              rows="2"
              placeholder="1行につき1つのメモを入力"
              class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
            >{{.Form.Notes}}</textarea>
          </label>
        </section>

        <section class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-xs">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ワークセンター割り当て</p>
              <p class="text-xs text-slate-500">複数選択可。プライマリを1つ選択してください。</p>
            </div>
          </div>
          {{if eq (len .Options.WorkCenters) 0}}
            <p class="text-sm text-slate-500">利用可能なワークセンターがありません。</p>
          {{else}}
            <ul class="space-y-2">
              {{range .Options.WorkCenters}}
                {{$id := .ID}}
                <li class="flex flex-col gap-2 rounded-lg border border-slate-200 px-3 py-2">
                  <label class="flex items-center gap-2">
                    <input
                      type="checkbox"
                      name="work_center_id"
                      value="{{$id}}"
                      {{if containsString $.Form.SelectedWorkCenters $id}}checked{{end}}
                      class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                    />
                    <span class="font-medium text-slate-900">{{.Label}}</span>
                    {{if not .Active}}<span class="{{badgeClass "warning"}}">停止中</span>{{end}}
                  </label>
                  <div class="flex items-center justify-between text-xs text-slate-500">
                    <p>{{.Subtitle}}</p>
                    <label class="flex items-center gap-1">
                      <input
                        type="radio"
                        name="primary_work_center"
                        value="{{$id}}"
                        {{if equalFold $.Form.PrimaryWorkCenter $id}}checked{{end}}
                        class="h-3.5 w-3.5 border-slate-300 text-brand-600 focus:ring-brand-500"
                      />
                      <span>Primary</span>
                    </label>
                  </div>
                </li>
              {{end}}
            </ul>
          {{end}}
        </section>

        <section class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-xs">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">担当ロール</p>
            <p class="text-xs text-slate-500">推奨人数を元に調整してください。0を入力するとロールは無視されます。</p>
          </div>
          {{if eq (len .Options.RoleOptions) 0}}
            <p class="text-sm text-slate-500">ロール定義がありません。</p>
          {{else}}
            <ul class="space-y-2">
              {{range .Options.RoleOptions}}
                {{$key := trimSpace .Key}}
                {{$count := intValue (index $.Form.RoleHeadcounts $key)}}
                <li class="flex items-center justify-between gap-3 rounded-lg border border-slate-200 px-3 py-2">
                  <div class="flex flex-col">
                    <span class="font-medium text-slate-900">{{.Label}}</span>
                    <span class="text-xs text-slate-500">推奨 {{fmtInt .SuggestedHeadcount}} 名</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <input type="hidden" name="role_key" value="{{.Key}}" />
                    <input
                      type="number"
                      name="role_headcount"
                      min="0"
                      value="{{fmtInt $count}}"
                      class="w-20 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                    />
                    <span class="text-xs text-slate-500">名</span>
                  </div>
                </li>
              {{end}}
            </ul>
          {{end}}
        </section>

        <section class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-xs">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ステージ定義</p>
            <p class="text-xs text-slate-500">各ステージのWIP上限とターゲットSLAを調整します。</p>
          </div>
          {{if eq (len .Form.Stages) 0}}
            <p class="text-sm text-slate-500">ステージが定義されていません。</p>
          {{else}}
            <div class="space-y-3">
              {{range .Form.Stages}}
                <div class="space-y-3 rounded-lg border border-slate-200 px-3 py-3">
                  <div class="flex items-center justify-between">
                    <div class="flex flex-col">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">ステージ名</label>
                      <input
                        type="text"
                        name="stage_label"
                        value="{{.Label}}"
                        class="rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                        required
                      />
                    </div>
                    <input type="hidden" name="stage_code" value="{{.Code}}" />
                  </div>
                  <div class="grid gap-3 sm:grid-cols-2">
                    <label class="flex flex-col gap-1 text-sm text-slate-600">
                      <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">WIP上限</span>
                      <input
                        type="number"
                        name="stage_wip_limit"
                        min="1"
                        value="{{fmtInt .WIPLimit}}"
                        class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                        required
                      />
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-600">
                      <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">ターゲットSLA (時間)</span>
                      <input
                        type="number"
                        name="stage_target_sla"
                        min="1"
                        value="{{fmtInt .TargetSLAHours}}"
                        class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                        required
                      />
                    </label>
                  </div>
                  <label class="flex flex-col gap-1 text-sm text-slate-600">
                    <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">説明</span>
                    <textarea
                      name="stage_description"
                      rows="2"
                      class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                    >{{.Description}}</textarea>
                  </label>
                </div>
              {{end}}
            </div>
          {{end}}
        </section>

        <div class="flex flex-col gap-2 pt-2">
          <button type="submit" class="{{buttonClass "primary" "md" true false}}">{{.SubmitLabel}}</button>
          <p class="text-xs text-slate-500">送信後に一覧が自動更新されます。</p>
        </div>
      </form>

      {{if gt (len .Options.WorkshopSuggestions) 0}}
        <datalist id="queue-workshop-suggestions">
          {{range .Options.WorkshopSuggestions}}
            <option value="{{.}}"></option>
          {{end}}
        </datalist>
      {{end}}
      {{if gt (len .Options.ProductLineSuggestions) 0}}
        <datalist id="queue-product-suggestions">
          {{range .Options.ProductLineSuggestions}}
            <option value="{{.}}"></option>
          {{end}}
        </datalist>
      {{end}}
    </div>
  </div>
</div>
{{end}}

{{define "production-queues/delete-modal"}}
<div class="modal-backdrop" data-modal-state="open">
  <div class="{{modalPanelClass "md"}}">
    <div class="modal-header">
      <h2 class="modal-title">{{.Title}}</h2>
      <button type="button" class="modal-close" data-modal-dismiss aria-label="閉じる">×</button>
    </div>
    <div class="modal-body">
      <form
        class="space-y-5 text-sm text-slate-700"
        hx-target="#modal"
        hx-swap="innerHTML"
        {{if eq .Method "DELETE"}}
          hx-delete="{{.ActionURL}}"
        {{else}}
          hx-post="{{.ActionURL}}"
        {{end}}
      >
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
        {{if .ReturnQuery}}
          <input type="hidden" name="return_query" value="{{.ReturnQuery}}" />
        {{end}}
        <p>
          <span class="font-semibold text-slate-900">{{.QueueName}}</span>
          を削除しますか？
        </p>
        <p class="text-xs text-slate-500">この操作は取り消せません。キューに紐づくステージ設定やワークセンター割り当ては失われます。</p>
        {{if .Error}}
          <div class="rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700">{{.Error}}</div>
        {{end}}
        <button type="submit" class="{{buttonClass "danger" "md" true false}}">削除する</button>
      </form>
    </div>
  </div>
</div>
{{end}}
