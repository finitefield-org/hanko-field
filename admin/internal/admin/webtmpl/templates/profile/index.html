{{define "profile/index"}}
{{template "layouts/base" .}}
{{end}}

{{define "profile/content"}}
{{$page := .Page}}
<div class="space-y-8">
  {{template "profile/page-header" $page}}
  <div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_20rem]">
    <div class="flex flex-col gap-6">
      {{template "profile/summary-card" $page}}
      <div id="profile-flash">
        {{if $page.Flash}}
          {{template "profile/flash-message" $page.Flash}}
        {{end}}
      </div>
      {{template "profile/tabs" (dict "Page" $page "BasePath" $.BasePath)}}
    </div>
  </div>
</div>
{{end}}

{{define "profile/page-header"}}
<header class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-center gap-4">
      <div class="flex h-16 w-16 items-center justify-center rounded-full bg-indigo-100 text-2xl font-semibold text-indigo-700">
        {{profileAvatarInitial .DisplayName .UserEmail .UserName}}
      </div>
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">{{.DisplayName}}</h1>
        {{if .UserEmail}}
          <p class="text-sm text-slate-600">{{.UserEmail}}</p>
        {{end}}
        {{if and .Security (not .Security.UpdatedAt.IsZero)}}
          <p class="mt-1 text-xs text-slate-400">最終更新 {{profileFormatTimestamp .Security.UpdatedAt}}</p>
        {{end}}
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2">
      {{if eq (len .Roles) 0}}
        <span class="{{badgeClass "warning"}}">ロール未設定</span>
      {{else}}
        {{range $role := .Roles}}
          <span class="{{badgeClass "info"}}">{{$role}}</span>
        {{end}}
      {{end}}
    </div>
  </div>
</header>
{{end}}

{{define "profile/summary-card"}}
<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
  <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
    <div>
      <h2 class="text-base font-semibold text-slate-900">プロフィール概要</h2>
      <p class="mt-2 text-sm text-slate-600">連絡先とログイン状況を確認できます。</p>
    </div>
    <a class="{{buttonClass "secondary" "sm" false false}}" href="https://console.firebase.google.com/" target="_blank" rel="noreferrer">Firebase Console を開く</a>
  </div>
  <dl class="mt-6 grid grid-cols-1 gap-4 text-sm text-slate-600 sm:grid-cols-2 lg:grid-cols-3">
    <div>
      <dt class="font-medium text-slate-500">メールアドレス</dt>
      <dd class="mt-1 font-semibold text-slate-900">
        {{if .UserEmail}}
          {{.UserEmail}}
        {{else}}
          <span class="text-slate-400">未登録</span>
        {{end}}
      </dd>
    </div>
    <div>
      <dt class="font-medium text-slate-500">ユーザー ID</dt>
      <dd class="mt-1 font-mono text-slate-900">{{.UserName}}</dd>
    </div>
    {{if and .Security .Security.Phone}}
      <div>
        <dt class="font-medium text-slate-500">電話番号</dt>
        <dd class="mt-1 text-slate-900">{{.Security.Phone}}</dd>
      </div>
    {{end}}
    <div>
      <dt class="font-medium text-slate-500">最終ログイン</dt>
      <dd class="mt-1 text-slate-900">
    {{if .LastLogin}}
      {{profileFormatOptionalTime .LastLogin}}
        {{else}}
          <span class="text-slate-400">記録なし</span>
        {{end}}
      </dd>
    </div>
  </dl>
</section>
{{end}}

{{define "profile/tabs"}}
<div id="profile-tabs" class="space-y-4">
  {{template "profile/tabs-inner" .}}
</div>
{{end}}

{{define "profile/tabs-inner"}}
{{$page := .Page}}
{{$base := joinBase .BasePath "/profile"}}
{{$tabContext := dict "Page" $page "BasePath" .BasePath}}
<div class="border-b border-slate-200">
  <nav class="flex flex-wrap items-center gap-2" aria-label="セクションタブ">
    <a
      href="{{buildURL $base "tab=account"}}"
      class="{{underlineTabClass (eq $page.ActiveTab "account")}}"
      data-tab="account"
      hx-get="{{buildURL $base "tab=account"}}"
      hx-target="#profile-tabs"
      hx-swap="outerHTML"
      hx-push-url="true"
    >アカウント</a>
    <a
      href="{{buildURL $base "tab=sessions"}}"
      class="{{underlineTabClass (eq $page.ActiveTab "sessions")}}"
      data-tab="sessions"
      hx-get="{{buildURL $base "tab=sessions"}}"
      hx-target="#profile-tabs"
      hx-swap="outerHTML"
      hx-push-url="true"
    >セッション</a>
    <a
      href="{{buildURL $base "tab=flags"}}"
      class="{{underlineTabClass (eq $page.ActiveTab "flags")}}"
      data-tab="flags"
      hx-get="{{buildURL $base "tab=flags"}}"
      hx-target="#profile-tabs"
      hx-swap="outerHTML"
      hx-push-url="true"
    >機能フラグ</a>
  </nav>
</div>
<div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
  <div class="space-y-6 px-6 py-6">
    {{if eq $page.ActiveTab "account"}}
      {{template "profile/account-tab" $page}}
    {{else if eq $page.ActiveTab "sessions"}}
      {{template "profile/sessions-tab" $tabContext}}
    {{else if eq $page.ActiveTab "flags"}}
      {{template "profile/flags-tab" $page}}
    {{else}}
      {{template "profile/account-tab" $page}}
    {{end}}
  </div>
</div>
{{end}}

{{define "profile/account-tab"}}
<div class="space-y-6">
  <section class="space-y-3">
    <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">連絡先</h3>
    <p class="text-sm text-slate-600">スタッフプロフィールは Firebase Auth を信頼ソースとして同期されています。</p>
    <dl class="grid grid-cols-1 gap-4 text-sm text-slate-600 sm:grid-cols-2">
      <div>
        <dt class="font-medium text-slate-500">表示名</dt>
        <dd class="mt-1 text-slate-900">{{.DisplayName}}</dd>
      </div>
      <div>
        <dt class="font-medium text-slate-500">メールアドレス</dt>
        <dd class="mt-1 text-slate-900">{{.UserEmail}}</dd>
      </div>
      <div>
        <dt class="font-medium text-slate-500">ユーザー ID</dt>
        <dd class="mt-1 font-mono text-slate-900">{{.UserName}}</dd>
      </div>
      {{if and .Security .Security.Phone}}
        <div>
          <dt class="font-medium text-slate-500">電話番号</dt>
          <dd class="mt-1 text-slate-900">{{.Security.Phone}}</dd>
        </div>
      {{end}}
    </dl>
  </section>
  <section class="space-y-3">
    <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-500">連絡先の更新</h3>
    <p class="text-sm text-slate-600">プロフィール情報の変更は Firebase Console から行ってください。</p>
    <div>
      <a class="{{buttonClass "secondary" "sm" false false}}" href="https://console.firebase.google.com/" target="_blank" rel="noreferrer">Firebase Console を開く</a>
    </div>
  </section>
</div>
{{end}}

{{define "profile/sessions-tab"}}
<div class="space-y-4">
  <section id="sessions-card">
    {{template "profile/sessions-card" (dict "Security" .Page.Security "CSRFToken" .Page.CSRFToken "BasePath" .BasePath)}}
  </section>
  <p class="text-xs text-slate-500">すべてのセッションを失効すると、次回ログイン時に再認証が必要になります。</p>
</div>
{{end}}

{{define "profile/flags-tab"}}
<div class="space-y-4">
  <p class="text-sm text-slate-600">機能フラグは段階的リリースや運用中の実験機能のトグルに使用されます。</p>
  {{if eq (len .FeatureFlags) 0}}
    <p class="rounded-lg border border-dashed border-slate-300 px-4 py-4 text-sm text-slate-500">割り当てられた機能フラグはありません。</p>
  {{else}}
    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase text-slate-500">
          <tr>
            <th class="px-4 py-3 text-left font-medium">キー</th>
            <th class="px-4 py-3 text-left font-medium">状態</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {{range $flag := .FeatureFlags}}
            <tr>
              <td class="px-4 py-3 font-mono text-slate-900">{{$flag.Key}}</td>
              <td class="px-4 py-3">
                {{if $flag.Enabled}}
                  <span class="{{badgeClass "success"}}">有効</span>
                {{else}}
                  <span class="{{badgeClass "muted"}}">無効</span>
                {{end}}
              </td>
            </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  {{end}}
</div>
{{end}}

{{define "profile/flash-message"}}
<div class="rounded-lg border border-sky-200 bg-sky-50 px-4 py-3 text-sm text-sky-900 shadow-sm">
  {{.}}
</div>
{{end}}

{{define "profile/alert-card"}}
<div class="rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm">
  <h2 class="text-base font-semibold text-slate-900">{{.Title}}</h2>
  <p class="mt-2 text-sm text-slate-600">{{.Body}}</p>
  {{if and .LinkHref .LinkText}}
    <a
      href="{{.LinkHref}}"
      target="_blank"
      rel="noreferrer"
      class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-500"
    >
      {{.LinkText}} →
    </a>
  {{end}}
</div>
{{end}}

{{define "profile/sessions-card"}}
{{$state := .Security}}
{{$csrf := .CSRFToken}}
{{$base := .BasePath}}
<section class="card">
  <h2 class="card-title">アクティブセッション</h2>
  <div class="card-body">
    <div class="space-y-4">
      <p class="text-sm text-slate-600">現在ログイン中のブラウザとデバイス。見覚えのないセッションは直ちに失効してください。</p>
      {{if or (not $state) (eq (len $state.Sessions) 0)}}
        <p class="rounded-lg border border-dashed border-slate-300 px-4 py-4 text-sm text-slate-500">アクティブなセッションはありません。</p>
      {{else}}
        <div class="overflow-hidden rounded-xl border border-slate-200">
          <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-xs uppercase text-slate-500">
              <tr>
                <th class="px-4 py-3 text-left font-medium">デバイス</th>
                <th class="px-4 py-3 text-left font-medium">IP / 場所</th>
                <th class="px-4 py-3 text-left font-medium">更新</th>
                <th class="px-4 py-3 text-left font-medium">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 bg-white">
              {{range $session := $state.Sessions}}
                <tr>
                  <td class="px-4 py-3">
                    <div class="font-semibold text-slate-900">{{$session.UserAgent}}</div>
                    <div class="text-xs text-slate-500">開始: {{profileFormatTimestamp $session.CreatedAt}}</div>
                    {{if $session.Current}}
                      <span class="{{badgeClass "info"}}">現在</span>
                    {{end}}
                  </td>
                  <td class="px-4 py-3 text-slate-600">
                    <p>{{$session.IPAddress}}</p>
                    {{if $session.Location}}
                      <p class="text-xs text-slate-500">{{$session.Location}}</p>
                    {{end}}
                  </td>
                  <td class="px-4 py-3 text-slate-600">{{profileFormatTimestamp $session.LastSeenAt}}</td>
                  <td class="px-4 py-3">
                    {{if not $session.Current}}
                      <form
                        hx-post="{{joinBase $base (printf "/profile/sessions/%s/revoke" $session.ID)}}"
                        hx-target="#sessions-card"
                        hx-swap="outerHTML"
                        class="inline-flex"
                      >
                        <input type="hidden" name="csrf_token" value="{{$csrf}}" />
                        <button type="submit" class="{{buttonClass "danger" "sm" false false}}">失効</button>
                      </form>
                    {{else}}
                      <span class="text-xs text-slate-400">現在のセッション</span>
                    {{end}}
                  </td>
                </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      {{end}}
    </div>
  </div>
</section>
{{end}}
