{{define "orders/manual-capture-modal"}}
<div class="modal-overlay" data-modal-overlay>
  <div class="modal-panel" data-modal-panel role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-description" aria-label="売上を確定" tabindex="-1">
    <header class="modal-header">
      <div class="flex-1">
        <h2 id="modal-title" class="modal-title">売上を確定</h2>
      </div>
      <button type="button" class="btn btn-ghost btn-sm" data-modal-close>
        <span class="sr-only">閉じる</span>
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true" class="h-4 w-4">
          <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" />
        </svg>
      </button>
    </header>
    <div id="modal-description" class="modal-body">
      <div class="space-y-6 text-sm text-slate-700">
        <div class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">注文番号</p>
          <p class="text-lg font-semibold text-slate-900">#{{.OrderNumber}}</p>
          {{if .CustomerName}}
            <p class="text-xs text-slate-500">{{.CustomerName}}</p>
          {{end}}
          <p class="text-xs text-slate-500">
            合計 {{.Total}}
            {{if .PaymentStatus}}
              <span class="ml-2 inline-flex items-center gap-1">
                <span class="{{badgeClass .PaymentTone}}">{{.PaymentStatus}}</span>
              </span>
            {{end}}
          </p>
          {{if .Outstanding}}
            <p class="text-xs text-amber-600">未確定: {{.Outstanding}}</p>
          {{end}}
        </div>

        {{if and .CaptureSuccess .Response}}
          <div class="space-y-3 rounded-xl border border-emerald-200 bg-emerald-50 p-4 text-emerald-900">
            <div class="flex items-center justify-between gap-3">
              <p class="font-semibold text-emerald-900">売上を確定しました</p>
              {{if .Response.Status}}
                <span class="{{badgeClass .Response.StatusTone}}">{{.Response.Status}}</span>
              {{end}}
            </div>
            {{if .Response.Message}}
              <p class="text-xs text-emerald-800">{{.Response.Message}}</p>
            {{end}}
            <dl class="grid grid-cols-1 gap-2 text-xs text-emerald-800 sm:grid-cols-2">
              {{if .Response.ProviderLabel}}
                <div>
                  <dt class="font-semibold text-emerald-900">PSP</dt>
                  <dd>{{.Response.ProviderLabel}}</dd>
                </div>
              {{end}}
              {{if .Response.Reference}}
                <div>
                  <dt class="font-semibold text-emerald-900">リファレンス</dt>
                  <dd class="break-words">{{.Response.Reference}}</dd>
                </div>
              {{end}}
              <div>
                <dt class="font-semibold text-emerald-900">確定金額</dt>
                <dd>{{.Response.Captured}}</dd>
              </div>
              {{if .Response.Code}}
                <div>
                  <dt class="font-semibold text-emerald-900">コード</dt>
                  <dd>{{.Response.Code}}</dd>
                </div>
              {{end}}
              {{if or .Response.Processed .Response.Relative}}
                <div>
                  <dt class="font-semibold text-emerald-900">処理日時</dt>
                  <dd>
                    {{.Response.Processed}}
                    {{if .Response.Relative}}
                      <span class="ml-1 text-emerald-700">({{.Response.Relative}})</span>
                    {{end}}
                  </dd>
                </div>
              {{end}}
            </dl>
            {{if gt (len .Response.Raw) 0}}
              <div class="rounded-lg border border-emerald-200 bg-white p-3 text-xs text-slate-600">
                <p class="mb-2 font-semibold text-slate-700">PSP Raw Payload</p>
                <dl class="space-y-1">
                  {{range $item := .Response.Raw}}
                    <div class="flex items-start justify-between gap-3">
                      <dt class="font-medium text-slate-700">{{$item.Key}}</dt>
                      <dd class="max-w-[16rem] break-words text-right text-slate-600 sm:max-w-none">{{$item.Value}}</dd>
                    </div>
                  {{end}}
                </dl>
              </div>
            {{end}}
          </div>
        {{end}}

        <form
          hx-post="{{.ActionURL}}"
          hx-target="#modal"
          hx-swap="innerHTML"
          class="space-y-4"
        >
          <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
          <div class="space-y-2">
            <label for="manual-capture-payment" class="text-xs font-semibold uppercase tracking-wide text-slate-500">支払い</label>
            <select
              id="manual-capture-payment"
              name="paymentID"
              class="{{.PaymentClass}}"
              required
              {{if .DisableForm}}disabled{{end}}
            >
              {{if eq (len .Payments) 0}}
                <option value="">売上確定可能な支払いがありません</option>
              {{else}}
                {{range $option := .Payments}}
                  <option value="{{$option.ID}}" {{if $option.Selected}}selected{{end}} {{if $option.Disabled}}disabled{{end}}>
                    {{$option.Label}}
                  </option>
                {{end}}
              {{end}}
            </select>
            {{with index .FieldErrors "paymentID"}}
              <p class="text-xs text-rose-600">{{.}}</p>
            {{else}}
              <p class="text-xs text-slate-500">売上を確定する支払いを選択してください。</p>
            {{end}}
          </div>
          <div class="space-y-2">
            <label for="manual-capture-amount" class="text-xs font-semibold uppercase tracking-wide text-slate-500">金額 ({{.Currency}})</label>
            <input
              id="manual-capture-amount"
              name="amount"
              type="text"
              inputmode="decimal"
              placeholder="例) 12000"
              value="{{.AmountInput}}"
              class="{{.AmountClass}}"
              {{if .DisableForm}}disabled{{end}}
            />
            {{with index .FieldErrors "amount"}}
              <p class="text-xs text-rose-600">{{.}}</p>
            {{else}}
              {{if .SupportsPartial}}
                <p class="text-xs text-slate-500">未入力の場合は残額全てを確定します。部分売上に対応しています。</p>
              {{else}}
                <p class="text-xs text-slate-500">全額確定のみ対応しています。</p>
              {{end}}
            {{end}}
          </div>
          <div class="space-y-2">
            <label for="manual-capture-reason" class="text-xs font-semibold uppercase tracking-wide text-slate-500">理由</label>
            <textarea
              id="manual-capture-reason"
              name="reason"
              rows="3"
              class="{{.ReasonClass}}"
              placeholder="例) オフライン入金の着金確認済み"
              required
              {{if .DisableForm}}disabled{{end}}
            >{{.Reason}}</textarea>
            {{with index .FieldErrors "reason"}}
              <p class="text-xs text-rose-600">{{.}}</p>
            {{else}}
              <p class="text-xs text-slate-500">会計メモとして残ります。どのように売上を確定したか記録してください。</p>
            {{end}}
          </div>
          {{if .Error}}
            <p class="text-sm text-rose-600">{{.Error}}</p>
          {{end}}
          <button type="submit" class="{{buttonClass "primary" "md" true false}}" {{if .DisableForm}}disabled{{end}}>売上を確定</button>
        </form>

        {{if gt (len .Payments) 0}}
          <div class="space-y-3">
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">支払いの内訳</h3>
            <ul class="divide-y divide-slate-200 rounded-lg border border-slate-200">
              {{range $option := .Payments}}
                <li class="space-y-2 p-3">
                  <div class="flex items-center justify-between gap-2">
                    <p class="font-medium text-slate-800">{{$option.Label}}</p>
                    <span class="{{badgeClass $option.StatusTone}}">{{$option.Status}}</span>
                  </div>
                  {{if $option.Caption}}
                    <p class="text-xs text-slate-500">{{$option.Caption}}</p>
                  {{end}}
                  <dl class="grid grid-cols-1 gap-1 text-xs text-slate-500 sm:grid-cols-3">
                    <div>
                      <dt class="font-semibold text-slate-600">承認額</dt>
                      <dd>{{$option.Authorized}}</dd>
                    </div>
                    <div>
                      <dt class="font-semibold text-slate-600">売上済み</dt>
                      <dd>{{$option.Captured}}</dd>
                    </div>
                    <div>
                      <dt class="font-semibold text-slate-600">残額</dt>
                      <dd>{{$option.Remaining}}</dd>
                    </div>
                  </dl>
                </li>
              {{end}}
            </ul>
          </div>
        {{end}}
      </div>
    </div>
  </div>
</div>
{{end}}
