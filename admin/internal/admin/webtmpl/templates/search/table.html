{{define "search/table"}}
<div class="flex flex-col gap-4" data-search-table>
  {{if .Error}}
    <div class="{{searchNoticeClass "danger"}}">
      <span>{{.Error}}</span>
    </div>
  {{end}}

  {{if eq (len .Groups) 0}}
    <div class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-5 py-8 text-center text-sm text-slate-600">
      {{if .Error}}
        <p>再度実行しても問題が続く場合は、システム管理者にお問い合わせください。</p>
      {{else if .EmptyMessage}}
        <p>{{.EmptyMessage}}</p>
      {{else}}
        <p>検索対象のデータがありません。</p>
      {{end}}
    </div>
  {{else}}
    {{range $group := .Groups}}
      {{template "search/group" (dict "Query" $.QueryTerm "Group" $group)}}
    {{end}}
  {{end}}

  {{template "search/shortcut-footer" .}}
</div>
{{end}}

{{define "search/group"}}
{{$group := .Group}}
<section class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm" data-search-group>
  <header class="flex items-center justify-between gap-3 border-b border-slate-200 bg-slate-50 px-5 py-3">
    <div class="flex items-center gap-3 text-sm font-semibold text-slate-900">
      {{if $group.Icon}}
        <span class="text-lg">{{$group.Icon}}</span>
      {{end}}
      <span>{{$group.Label}}</span>
    </div>
    <span class="text-xs text-slate-500">{{$group.Total}} 件</span>
  </header>
  <div class="divide-y divide-slate-100" data-search-group-body>
    {{if eq (len $group.Hits) 0}}
      <div class="px-5 py-6 text-sm text-slate-500">このカテゴリに該当する結果はありません。</div>
    {{else}}
      {{range $hit := $group.Hits}}
        {{template "search/row" (dict "Query" $.Query "Group" $group "Hit" $hit)}}
      {{end}}
    {{end}}
    {{if $group.HasMore}}
      <div class="bg-slate-50 px-5 py-3 text-xs text-slate-500">さらに結果があります。検索条件を絞り込んでください。</div>
    {{end}}
  </div>
</section>
{{end}}

{{define "search/row"}}
{{$query := .Query}}
{{$group := .Group}}
{{$hit := .Hit}}
<div
  class="group flex cursor-pointer flex-col gap-3 px-5 py-4 transition hover:bg-slate-50 focus:outline-none focus-visible:bg-slate-50 focus-visible:ring-2 focus-visible:ring-brand-300 md:flex-row md:items-start"
  tabindex="0"
  role="button"
  data-search-result
  data-search-url="{{$hit.URL}}"
  data-search-entity="{{$group.Label}}"
  data-search-entity-key="{{$group.Entity}}"
  data-search-entity-icon="{{$group.Icon}}"
>
  <div class="flex items-start gap-3 md:flex-1">
    <div class="hidden text-xl text-slate-500 md:block" aria-hidden="true">{{$group.Icon}}</div>
    <div class="min-w-0 flex-1">
      <div class="flex flex-wrap items-center gap-2">
        <p class="text-sm font-semibold text-slate-900" data-search-field="title">
          {{template "search/highlight" (dict "Value" $hit.Title "Term" $query)}}
        </p>
        {{if $hit.Badge}}
          <span data-search-field="badge">
            {{template "components/badge" (dict "Label" $hit.Badge "Tone" $hit.BadgeTone)}}
          </span>
        {{end}}
      </div>
      {{if $hit.Description}}
        <p class="mt-2 text-sm text-slate-600" data-search-field="description">
          {{template "search/highlight" (dict "Value" $hit.Description "Term" $query)}}
        </p>
      {{end}}
      <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-slate-500">
        <span class="rounded-md bg-slate-100 px-2 py-1 text-slate-600" data-search-field="entity">
          {{$group.Label}}
        </span>
        {{if $hit.Persona}}
          <span data-search-field="persona">担当: {{$hit.Persona}}</span>
        {{end}}
        <span data-search-field="score">スコア {{searchFormatScore $hit.Score}}</span>
        {{if $hit.OccurredAt}}
          <span data-search-field="occurred">{{relativeTime $hit.OccurredAt}}</span>
        {{end}}
      </div>
      {{if gt (len $hit.Metadata) 0}}
        <dl class="mt-3 flex flex-wrap gap-x-4 gap-y-2 text-xs text-slate-500" data-search-field="metadata">
          {{range $meta := $hit.Metadata}}
            <div class="flex items-center gap-1">
              {{if $meta.Icon}}
                <span aria-hidden="true">{{$meta.Icon}}</span>
              {{end}}
              <dt class="font-medium text-slate-600">{{$meta.Key}}</dt>
              <dd class="text-slate-600">{{$meta.Value}}</dd>
            </div>
          {{end}}
        </dl>
      {{end}}
    </div>
  </div>
  <div class="flex items-start justify-end gap-2 md:w-40">
    <a href="{{$hit.URL}}" class="{{buttonClass "ghost" "sm" false false}}" data-search-open-link="true">開く</a>
  </div>
</div>
{{end}}

{{define "search/shortcut-footer"}}
<div class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white px-5 py-4 text-sm text-slate-600 md:flex-row md:items-center md:justify-between">
  <div>
    <strong class="font-semibold text-slate-900">{{.Summary.TotalHits}} 件</strong>
    <span class="ml-2 text-xs text-slate-500">処理時間: {{.Summary.Duration}}</span>
  </div>
  {{if gt (len .ShortcutHints) 0}}
    <ul class="flex flex-wrap gap-3 text-xs text-slate-500">
      {{range $hint := .ShortcutHints}}
        <li class="flex items-center gap-2">
          <div class="flex items-center gap-1">
            {{range $key := $hint.Keys}}
              <kbd class="rounded border border-slate-300 bg-slate-50 px-2 py-1 font-mono text-[11px] text-slate-700 shadow-sm">{{$key}}</kbd>
            {{end}}
          </div>
          <span>{{$hint.Description}}</span>
        </li>
      {{end}}
    </ul>
  {{end}}
</div>
{{end}}

{{define "search/highlight"}}
{{$segments := searchHighlightSegments .Value .Term}}
{{if eq (len $segments) 0}}
  {{.Value}}
{{else}}
  {{range $segment := $segments}}
    {{if $segment.Match}}
      <mark class="rounded bg-brand-100 px-1 text-brand-700">{{$segment.Text}}</mark>
    {{else}}
      {{$segment.Text}}
    {{end}}
  {{end}}
{{end}}
{{end}}
