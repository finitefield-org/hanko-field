{{define "finance/tax-index"}}
{{template "layouts/base" .}}
{{end}}

{{define "finance/tax-content"}}
<div class="space-y-6">
  <section class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-sm">
    <header class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
      <div class="space-y-2">
        <h1 class="text-2xl font-semibold text-slate-900">{{.Page.Title}}</h1>
        <p class="text-sm text-slate-600">{{.Page.Description}}</p>
        {{if .Page.Header.LastSynced}}
          <p class="text-xs text-slate-500">最終同期: {{.Page.Header.LastSynced}}</p>
        {{end}}
      </div>
      <div class="flex flex-col gap-4">
        {{if gt (len .Page.Header.Metrics) 0}}
          <div class="grid gap-3 sm:grid-cols-3">
            {{range .Page.Header.Metrics}}
              {{template "finance/tax-header-metric" .}}
            {{end}}
          </div>
        {{end}}
        {{if gt (len .Page.Header.PolicyLinks) 0}}
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">参考リンク</span>
            {{range .Page.Header.PolicyLinks}}
              <a
                href="{{.Href}}"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1 text-sm font-medium text-brand-600 hover:text-brand-700"
              >
                {{.Label}} →
              </a>
            {{end}}
          </div>
        {{end}}
      </div>
    </header>
    {{if gt (len .Page.Header.Alerts) 0}}
      <div class="mt-6 space-y-3">
        {{range .Page.Header.Alerts}}
          {{template "finance/inline-alert" .}}
        {{end}}
      </div>
    {{end}}
  </section>

  {{template "finance/tax-grid" .Page}}
</div>
{{end}}

{{define "finance/tax-grid"}}
<div id="{{financeGridContainerID}}" class="grid gap-6 lg:grid-cols-[260px_minmax(0,1fr)_360px]">
  <aside class="space-y-4">
    {{template "finance/tax-navigation" .Content}}
  </aside>
  <section class="space-y-6" id="{{financeContentContainerID}}">
    {{template "finance/tax-table-card" .Content.Table}}
    {{template "finance/tax-detail-card" .Content.Detail}}
  </section>
  <aside class="space-y-4" id="{{financeHistoryContainerID}}">
    {{template "finance/history-panel" .Content.History}}
  </aside>
</div>
{{if .Snackbar}}
  <div hx-swap-oob="true" id="toast-stack">
    {{template "components/toast" .Snackbar}}
  </div>
{{end}}
{{end}}

{{define "finance/tax-navigation"}}
<form
  class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm"
  hx-get="{{.Navigation.ActionURL}}"
  hx-target="#{{financeGridContainerID}}"
  hx-swap="outerHTML"
>
  <input type="hidden" name="selected" value="{{.Query.SelectedID}}" />
  <div class="flex items-center gap-2">
    <input
      type="search"
      name="search"
      value="{{.Navigation.SearchValue}}"
      placeholder="{{.Navigation.SearchPlaceholder}}"
      class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
    />
    <button type="submit" class="{{buttonClass "secondary" "sm" false false}}">検索</button>
  </div>
  <label class="inline-flex items-center gap-2 text-xs text-slate-600">
    <input
      type="checkbox"
      name="includeSoon"
      value="true"
      {{if .Navigation.IncludeSoon}}checked{{end}}
      class="rounded border-slate-300 text-brand-600 focus:ring-brand-500"
    />
    30日以内の更新予定を表示
  </label>
  <nav class="space-y-4 text-sm">
    {{range .Navigation.Regions}}
      <div class="space-y-2">
        <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-500">
          <span>{{.Label}}</span>
          <span>{{.Count}}</span>
        </div>
        <ul class="space-y-1">
          {{range .Items}}
            <li>
              <a
                href="{{.Href}}"
                hx-get="{{.HXGet}}"
                hx-target="{{.HXTarget}}"
                hx-swap="{{.HXSwap}}"
                class="{{financeNavigationItemClass .Selected}}"
                {{if .Selected}}data-selected="true"{{end}}
              >
                <div class="flex flex-col">
                  <span class="font-medium">{{.Label}}</span>
                  <span class="text-xs text-slate-500">{{.Code}}</span>
                </div>
                <div class="flex flex-col items-end">
                  {{if .Pending}}
                    <span class="text-xs font-semibold text-amber-600">予定</span>
                  {{else if not .Active}}
                    <span class="text-xs font-semibold text-slate-400">停止</span>
                  {{end}}
                  {{if .Registration}}
                    <span class="text-[10px] text-slate-400">{{.Registration}}</span>
                  {{end}}
                </div>
              </a>
            </li>
          {{end}}
        </ul>
      </div>
    {{end}}
  </nav>
</form>
{{end}}

{{define "finance/tax-table-card"}}
<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <header class="flex items-center justify-between">
    <h2 class="text-lg font-semibold text-slate-900">地域一覧</h2>
    <span class="text-xs text-slate-500">クリックで詳細を表示</span>
  </header>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-200 text-sm">
      <thead class="bg-slate-50 text-xs uppercase text-slate-500">
        <tr>
          <th scope="col" class="px-4 py-3 text-left font-semibold">地域</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">標準税率</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">軽減税率</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">課税閾値</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">適用期間</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">ステータス</th>
          <th scope="col" class="px-4 py-3 text-left font-semibold">最終更新</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {{if eq (len .Rows) 0}}
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-sm text-slate-500">{{.EmptyMessage}}</td>
          </tr>
        {{else}}
          {{range .Rows}}
            <tr class="{{financeTaxTableRowClass .Selected}}">
              <td class="px-4 py-4">
                <a
                  href="{{.SelectURL}}"
                  hx-get="{{.HXGet}}"
                  hx-target="#{{financeGridContainerID}}"
                  hx-swap="outerHTML"
                  class="flex flex-col gap-0.5 font-medium text-slate-900 hover:text-brand-600"
                >
                  <span>{{.Country}}</span>
                  <span class="text-xs font-normal text-slate-500">{{.Region}} · {{.Code}}</span>
                </a>
              </td>
              <td class="px-4 py-4 text-slate-900">{{.DefaultRate}}</td>
              <td class="px-4 py-4 text-slate-700">{{.ReducedRate}}</td>
              <td class="px-4 py-4 text-slate-700">{{.ThresholdLabel}}</td>
              <td class="px-4 py-4 text-slate-700">{{.EffectiveLabel}}</td>
              <td class="px-4 py-4">
                <span class="{{badgeClass .StatusTone}}">{{.StatusLabel}}</span>
              </td>
              <td class="px-4 py-4 text-xs text-slate-500">{{.UpdatedLabel}}</td>
            </tr>
          {{end}}
        {{end}}
      </tbody>
    </table>
  </div>
</section>
{{end}}

{{define "finance/tax-detail-card"}}
<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm" id="{{financeDetailContainerID}}">
  {{if .Empty}}
    <div class="py-10 text-center text-sm text-slate-500">
      {{.Title}}
    </div>
  {{else}}
    <header class="flex flex-col gap-2 border-b border-slate-200 pb-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">{{.Title}}</h2>
        <p class="text-sm text-slate-500">{{.Region}} · {{.Code}}</p>
      </div>
      <div class="flex flex-wrap items-center gap-4 text-sm text-slate-600">
        <span>標準 {{.DefaultRate}}</span>
        {{if .ReducedRate}}
          <span>軽減 {{.ReducedRate}}</span>
        {{end}}
        <span>更新 {{.UpdatedAt}} ({{.UpdatedRelative}})</span>
      </div>
    </header>
    <div class="space-y-6 pt-4">
      {{if gt (len .Alerts) 0}}
        <div class="space-y-3">
          {{range .Alerts}}
            {{template "finance/inline-alert" .}}
          {{end}}
        </div>
      {{end}}

      {{if gt (len .Notes) 0}}
        <section class="rounded-xl border border-slate-100 bg-slate-50 px-4 py-3">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">メモ</h3>
          <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-600">
            {{range .Notes}}
              <li>{{.}}</li>
            {{end}}
          </ul>
        </section>
      {{end}}

      <section class="space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold text-slate-900">税率ルール</h3>
          <button
            type="button"
            class="{{buttonClass "primary" "sm" false false}}"
            hx-get="{{.Rules.NewRuleURL}}"
            hx-target="#modal"
            hx-swap="innerHTML"
          >
            新規追加
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-xs uppercase text-slate-500">
              <tr>
                <th class="px-4 py-3 text-left font-semibold">区分</th>
                <th class="px-4 py-3 text-left font-semibold">税率</th>
                <th class="px-4 py-3 text-left font-semibold">課税閾値</th>
                <th class="px-4 py-3 text-left font-semibold">適用期間</th>
                <th class="px-4 py-3 text-left font-semibold">ステータス</th>
                <th class="px-4 py-3 text-left font-semibold">更新</th>
                <th class="px-4 py-3 text-right font-semibold">操作</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              {{if eq (len .Rules.Table.Rows) 0}}
                <tr>
                  <td colspan="7" class="px-4 py-6 text-center text-sm text-slate-500">{{.Rules.Table.EmptyMessage}}</td>
                </tr>
              {{else}}
                {{range .Rules.Table.Rows}}
                  <tr>
                    <td class="px-4 py-3">
                      <div class="flex flex-col">
                        <span class="font-medium text-slate-900">{{.Label}}</span>
                        <span class="text-xs text-slate-500">{{.Scope}}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-slate-700">{{.Rate}}</td>
                    <td class="px-4 py-3 text-slate-700">{{.Threshold}}</td>
                    <td class="px-4 py-3 text-slate-700">{{.Effective}}</td>
                    <td class="px-4 py-3">
                      <span class="{{badgeClass .StatusTone}}">{{.Status}}</span>
                      {{if .Registration}}
                        <p class="mt-1 text-[10px] uppercase tracking-wide text-slate-400">{{.Registration}}</p>
                      {{end}}
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-500">{{.Updated}}</td>
                    <td class="px-4 py-3 text-right">
                      <div class="flex justify-end gap-2">
                        <button
                          type="button"
                          class="{{buttonClass "secondary" "xs" false false}}"
                          hx-get="{{.EditURL}}"
                          hx-target="#modal"
                          hx-swap="innerHTML"
                        >
                          編集
                        </button>
                        <button
                          type="button"
                          class="{{buttonClass "ghost" "xs" false false}}"
                          hx-get="{{.DeleteURL}}"
                          hx-target="#modal"
                          hx-swap="innerHTML"
                        >
                          削除
                        </button>
                      </div>
                    </td>
                  </tr>
                {{end}}
              {{end}}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  {{end}}
</section>
{{end}}

{{define "finance/tax-header-metric"}}
<div class="{{financeHeaderMetricClass .Tone}}">
  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{.Label}}</p>
  <p class="text-xl font-semibold text-slate-900">{{.Value}}</p>
  {{if .SubLabel}}
    <p class="text-xs text-slate-500">{{.SubLabel}}</p>
  {{end}}
</div>
{{end}}

{{define "finance/tax-rule-form-modal"}}
<div class="modal-backdrop" data-modal-state="open">
  <div class="{{modalPanelClass "lg"}}">
    <div class="modal-header">
      <h2 class="modal-title">{{.Title}}</h2>
      <button type="button" class="modal-close" data-modal-dismiss aria-label="閉じる">×</button>
    </div>
    <div class="modal-body space-y-4">
      <p class="text-sm text-slate-600">{{.Description}}</p>
      {{if .GeneralError}}
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
          {{.GeneralError}}
        </div>
      {{end}}
      <form
        id="tax-rule-form"
        class="space-y-4"
        hx-target="#{{financeGridContainerID}}"
        hx-swap="outerHTML"
        {{if eq .Method "put"}}
          hx-put="{{.ActionURL}}"
        {{else}}
          hx-post="{{.ActionURL}}"
        {{end}}
      >
        <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
        {{if .Fields.RuleID}}
          <input type="hidden" name="ruleID" value="{{.Fields.RuleID}}" />
        {{end}}
        <input type="hidden" name="type" value="{{.Fields.Type}}" />
        {{if .ReturnQuery}}
          <input type="hidden" name="return_query" value="{{.ReturnQuery}}" />
        {{end}}
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-label">名称</label>
            <input
              id="rule-label"
              name="label"
              type="text"
              value="{{.Fields.Label}}"
              class="{{financeInputClass (index .FieldErrors "label")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "label")}}
          </div>
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-scope">課税区分</label>
            <select id="rule-scope" name="scope" class="{{financeInputClass (index .FieldErrors "scope")}}">
              <option value="standard" {{if eq .Fields.Scope "standard"}}selected{{end}}>標準課税</option>
              <option value="reduced" {{if eq .Fields.Scope "reduced"}}selected{{end}}>軽減課税</option>
              <option value="state" {{if eq .Fields.Scope "state"}}selected{{end}}>州税</option>
              <option value="local" {{if eq .Fields.Scope "local"}}selected{{end}}>地方税</option>
              <option value="custom" {{if eq .Fields.Scope "custom"}}selected{{end}}>その他</option>
            </select>
            {{template "finance/field-error" (index .FieldErrors "scope")}}
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-rate">税率 (%)</label>
            <input
              id="rule-rate"
              name="rate"
              type="number"
              step="0.01"
              min="0"
              value="{{.Fields.Rate}}"
              class="{{financeInputClass (index .FieldErrors "rate")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "rate")}}
          </div>
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-threshold">課税閾値 (minor)</label>
            <input
              id="rule-threshold"
              name="threshold"
              type="number"
              min="0"
              value="{{.Fields.Threshold}}"
              class="{{financeInputClass (index .FieldErrors "threshold")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "threshold")}}
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-effective-from">適用開始</label>
            <input
              id="rule-effective-from"
              name="effective_from"
              type="date"
              value="{{.Fields.EffectiveFrom}}"
              class="{{financeInputClass (index .FieldErrors "effective_from")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "effective_from")}}
          </div>
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-effective-to">適用終了</label>
            <input
              id="rule-effective-to"
              name="effective_to"
              type="date"
              value="{{.Fields.EffectiveTo}}"
              class="{{financeInputClass (index .FieldErrors "effective_to")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "effective_to")}}
          </div>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
          <div class="space-y-1.5">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-registration">登録番号</label>
            <input
              id="rule-registration"
              name="registration"
              type="text"
              value="{{.Fields.RegistrationNumber}}"
              class="{{financeInputClass (index .FieldErrors "registration")}}"
            />
            {{template "finance/field-error" (index .FieldErrors "registration")}}
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">設定</label>
            <label class="flex items-center gap-2 text-xs text-slate-600">
              <input
                type="checkbox"
                name="requires_registration"
                value="true"
                {{if .Fields.RequiresRegistration}}checked{{end}}
                class="rounded border-slate-300 text-brand-600 focus:ring-brand-500"
              />
              登録番号必須
            </label>
            <label class="flex items-center gap-2 text-xs text-slate-600">
              <input
                type="checkbox"
                name="default"
                value="true"
                {{if .Fields.Default}}checked{{end}}
                class="rounded border-slate-300 text-brand-600 focus:ring-brand-500"
              />
              既定の税率に設定
            </label>
            {{template "finance/field-error" (index .FieldErrors "default")}}
          </div>
        </div>
        <div class="space-y-1.5">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="rule-notes">備考</label>
          <textarea
            id="rule-notes"
            name="notes"
            rows="3"
            class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
          >{{.Fields.Notes}}</textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="{{buttonClass "ghost" "md" false false}}" data-modal-dismiss>キャンセル</button>
      <button type="submit" class="{{buttonClass "primary" "md" false false}}" form="tax-rule-form">
        {{.SubmitLabel}}
      </button>
    </div>
  </div>
</div>
{{end}}

{{define "finance/tax-rule-delete-modal"}}
<div class="modal-backdrop" data-modal-state="open">
  <div class="{{modalPanelClass "md"}}">
    <div class="modal-header">
      <h2 class="modal-title">{{.Title}}</h2>
      <button type="button" class="modal-close" data-modal-dismiss aria-label="閉じる">×</button>
    </div>
    <div class="modal-body space-y-4">
      <p class="text-sm text-slate-600">{{.Description}}</p>
      <ul class="space-y-2 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
        <li><strong>名称:</strong> {{.RuleLabel}}</li>
        <li><strong>税率:</strong> {{.Rate}}</li>
        <li><strong>期間:</strong> {{.Effective}}</li>
      </ul>
      {{if .Error}}
        <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
          {{.Error}}
        </div>
      {{end}}
    </div>
    <div class="modal-footer">
      <button type="button" class="{{buttonClass "ghost" "md" false false}}" data-modal-dismiss>{{.CancelLabel}}</button>
      <form
        hx-delete="{{.ActionURL}}"
        hx-target="#{{financeGridContainerID}}"
        hx-swap="outerHTML"
      >
        <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
        {{if .ReturnQuery}}
          <input type="hidden" name="return_query" value="{{.ReturnQuery}}" />
        {{end}}
        <button type="submit" class="{{buttonClass "danger" "md" false false}}">{{.SubmitLabel}}</button>
      </form>
    </div>
  </div>
</div>
{{end}}

{{define "finance/field-error"}}
{{if .}}
  <p class="text-xs text-red-600">{{.}}</p>
{{end}}
{{end}}
