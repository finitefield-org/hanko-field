{{define "finance/reconciliation-index"}}
{{template "layouts/base" .}}
{{end}}

{{define "finance/reconciliation-content"}}
{{template "finance/reconciliation-root" .Page}}
{{end}}

{{define "finance/reconciliation-root"}}
<div id="{{financeReconciliationRootID}}" class="space-y-6">
  {{template "finance/reconciliation-header" .}}
  {{template "finance/reconciliation-dashboard" .}}
</div>
{{if .Snackbar}}
  <div hx-swap-oob="true" id="toast-stack">
    {{template "components/toast" .Snackbar}}
  </div>
{{end}}
{{end}}

{{define "finance/reconciliation-header"}}
<section class="rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-sm">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-2">
      <h1 class="text-2xl font-semibold text-slate-900">{{.Title}}</h1>
      <p class="text-sm text-slate-600">{{.Description}}</p>
    </div>
    {{if gt (len .Metrics) 0}}
      <div class="grid w-full gap-3 sm:grid-cols-3 lg:w-auto">
        {{range .Metrics}}
          <div class="{{financeMetricCardClass .Tone}}">
            <div class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{.Label}}</div>
            <div class="text-xl font-semibold text-slate-900">{{.Value}}</div>
            {{if .SubLabel}}
              <div class="text-xs text-slate-500">{{.SubLabel}}</div>
            {{end}}
          </div>
        {{end}}
      </div>
    {{end}}
  </div>
</section>
{{end}}

{{define "finance/reconciliation-dashboard"}}
<div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_360px]">
  <section class="space-y-6">
    {{template "finance/reconciliation-summary-card" .}}
    {{template "finance/reconciliation-reports-card" .Reports}}
    {{template "finance/reconciliation-jobs-card" .Jobs}}
  </section>
  <aside class="space-y-4">
    {{template "finance/history-panel" .History}}
  </aside>
</div>
{{end}}

{{define "finance/reconciliation-summary-card"}}
<section class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-4">
      <div class="flex items-center gap-2">
        <span class="{{badgeClass .Summary.StatusTone}}">{{.Summary.StatusLabel}}</span>
        {{if .Summary.LastRunBy}}
          <span class="text-xs text-slate-500">担当: {{.Summary.LastRunBy}}</span>
        {{end}}
      </div>
      <dl class="grid gap-3 text-sm text-slate-600 md:grid-cols-2">
        <div>
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">最終実行</dt>
          <dd class="mt-1 space-y-0.5">
            <p class="font-medium text-slate-900">{{.Summary.LastRunAt}}</p>
            {{if .Summary.LastRunRelative}}
              <p class="text-xs text-slate-500">{{.Summary.LastRunRelative}}</p>
            {{end}}
          </dd>
        </div>
        <div>
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">所要時間</dt>
          <dd class="mt-1 text-slate-900">{{.Summary.Duration}}</dd>
        </div>
        <div>
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">次回予定</dt>
          <dd class="mt-1 space-y-0.5">
            <p class="font-medium text-slate-900">{{.Summary.NextRunLabel}}</p>
            {{if .Summary.NextRunRelative}}
              <p class="text-xs text-slate-500">{{.Summary.NextRunRelative}}</p>
            {{end}}
          </dd>
        </div>
        <div>
          <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">未処理例外</dt>
          <dd class="mt-1 space-y-0.5">
            <span class="{{badgeClass .Summary.PendingTone}}">{{.Summary.PendingLabel}}</span>
            {{if .Summary.PendingAmount}}
              <p class="text-xs text-slate-500">差異合計 {{.Summary.PendingAmount}}</p>
            {{end}}
          </dd>
        </div>
      </dl>
    </div>
    <div class="flex flex-col items-start gap-3">
      <form
        hx-post="{{.Trigger.ActionURL}}"
        hx-target="#{{financeReconciliationRootID}}"
        hx-swap="outerHTML"
        hx-indicator="#{{.Trigger.IndicatorID}}"
      >
        <input type="hidden" name="csrf_token" value="{{.Trigger.CSRFToken}}" />
        <button
          type="submit"
          class="{{buttonClass "primary" "sm" false false}}"
          {{if .Trigger.Disabled}}disabled{{end}}
        >
          リコンシリエーションを実行
        </button>
      </form>
      <div id="{{.Trigger.IndicatorID}}" class="htmx-indicator text-xs text-slate-400">実行中...</div>
      {{if and .Trigger.Disabled .Trigger.DisabledReason}}
        <p class="text-xs text-amber-600">{{.Trigger.DisabledReason}}</p>
      {{end}}
    </div>
  </div>
  {{if gt (len .Alerts) 0}}
    <div class="space-y-3">
      {{range .Alerts}}
        {{template "finance/inline-alert" .}}
      {{end}}
    </div>
  {{end}}
</section>
{{end}}

{{define "finance/reconciliation-reports-card"}}
<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <div class="flex items-start justify-between">
    <h3 class="text-sm font-semibold text-slate-900">エクスポート</h3>
  </div>
  {{if eq (len .Rows) 0}}
    <p class="text-sm text-slate-500">{{.EmptyMessage}}</p>
  {{else}}
    <div class="overflow-hidden rounded-xl border border-slate-200">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-4 py-3 text-left">レポート</th>
            <th class="px-4 py-3 text-left">更新日時</th>
            <th class="px-4 py-3 text-left">状態</th>
            <th class="px-4 py-3 text-left">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 bg-white">
          {{range .Rows}}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-3 align-top">
                <div class="font-medium text-slate-900">{{.Label}}</div>
                {{if .Description}}
                  <p class="text-xs text-slate-500">{{.Description}}</p>
                {{end}}
                {{if .BackgroundJob}}
                  <p class="text-xs text-slate-400">生成ジョブ: {{.BackgroundJob}}</p>
                {{end}}
              </td>
              <td class="px-4 py-3 align-top">
                <div class="font-medium text-slate-900">{{.LastGenerated}}</div>
                {{if .Relative}}
                  <p class="text-xs text-slate-500">{{.Relative}}</p>
                {{end}}
                {{if .FileSize}}
                  <p class="text-xs text-slate-400">{{.FileSize}}</p>
                {{end}}
              </td>
              <td class="px-4 py-3 align-top">
                <span class="{{badgeClass .StatusTone}}">{{.StatusLabel}}</span>
              </td>
              <td class="px-4 py-3 align-top">
                {{if .DownloadEnabled}}
                  <a
                    href="{{.DownloadURL}}"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="{{buttonClass "secondary" "sm" false false}}"
                  >
                    {{.DownloadLabel}}
                  </a>
                {{else}}
                  <span class="text-xs text-slate-400">リンク未生成</span>
                {{end}}
              </td>
            </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  {{end}}
</section>
{{end}}

{{define "finance/reconciliation-jobs-card"}}
<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
  <h3 class="text-sm font-semibold text-slate-900">バックグラウンドジョブ</h3>
  {{if eq (len .Rows) 0}}
    <p class="text-sm text-slate-500">{{.EmptyMessage}}</p>
  {{else}}
    <div class="overflow-hidden rounded-xl border border-slate-200">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-500">
          <tr>
            <th class="px-4 py-3 text-left">ジョブ</th>
            <th class="px-4 py-3 text-left">実行状況</th>
            <th class="px-4 py-3 text-left">ステータス</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 bg-white">
          {{range .Rows}}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-3 align-top">
                <div class="font-medium text-slate-900">{{.Label}}</div>
                {{if .Schedule}}
                  <p class="text-xs text-slate-500">{{.Schedule}}</p>
                {{end}}
                {{if .LastError}}
                  <p class="text-xs text-amber-600">{{.LastError}}</p>
                {{end}}
              </td>
              <td class="px-4 py-3 align-top">
                <div class="space-y-1">
                  <p class="font-medium text-slate-900">{{.LastRun}}</p>
                  {{if .Relative}}
                    <p class="text-xs text-slate-500">{{.Relative}}</p>
                  {{end}}
                  {{if .Duration}}
                    <p class="text-xs text-slate-400">所要時間 {{.Duration}}</p>
                  {{end}}
                  <p class="text-xs text-slate-500">次回 {{.NextRun}}</p>
                </div>
              </td>
              <td class="px-4 py-3 align-top">
                <span class="{{badgeClass .StatusTone}}">{{.StatusLabel}}</span>
              </td>
            </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  {{end}}
</section>
{{end}}
