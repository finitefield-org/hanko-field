{{define "promotionusage/index"}}
{{template "layouts/base" .}}
{{end}}

{{define "promotionusage/content"}}
{{$page := .Page}}
<div class="space-y-6" data-promotion-usage-root>
  {{template "promotionusage/section-header" $page}}
  {{if $page.Alert}}
    {{template "promotionusage/alert" $page.Alert}}
  {{end}}
  {{template "promotionusage/filters" $page}}
  <div id="promotion-usage-table" hx-target="this" hx-swap="outerHTML" data-promotion-usage-table-root>
    {{template "promotionusage/table" .Table}}
  </div>
  <div id="promotion-usage-export" class="space-y-3">
    {{template "promotionusage/export-status" $page.ExportStatus}}
  </div>
</div>
{{end}}

{{define "promotionusage/section-header"}}
<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-2">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-semibold text-slate-900">{{.Promotion.Name}}</h1>
        {{if trimSpace .Promotion.Code}}
          <span class="rounded-md bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-500">{{.Promotion.Code}}</span>
        {{end}}
        {{if trimSpace .Promotion.StatusLabel}}
          {{template "components/badge" (dict "Label" .Promotion.StatusLabel "Tone" .Promotion.StatusTone)}}
        {{end}}
      </div>
      {{if trimSpace .Promotion.PeriodLabel}}
        <p class="text-sm text-slate-600">{{.Promotion.PeriodLabel}}</p>
      {{end}}
      <p class="text-sm text-slate-600">{{.Description}}</p>
    </div>
    {{if gt (len .Metrics) 0}}
      <div class="grid w-full gap-3 sm:grid-cols-2 lg:w-auto lg:grid-cols-3">
        {{range $metric := .Metrics}}
          <div class="flex h-full flex-col justify-between rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 shadow-sm">
            <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
              {{if $metric.Icon}}<span aria-hidden="true">{{$metric.Icon}}</span>{{end}}
              {{$metric.Label}}
            </div>
            <div class="mt-1 text-xl font-semibold text-slate-900">{{$metric.Value}}</div>
            {{if trimSpace $metric.SubText}}
              <div class="mt-1 text-xs text-slate-500">{{$metric.SubText}}</div>
            {{end}}
          </div>
        {{end}}
      </div>
    {{end}}
  </div>
</section>
{{end}}

{{define "promotionusage/alert"}}
<div class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800 shadow-sm" role="alert">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-start gap-2">
      <span aria-hidden="true" class="mt-0.5 text-lg">⚠️</span>
      <p>{{.Message}}</p>
    </div>
    {{if trimSpace .LinkURL}}
      <a href="{{.LinkURL}}" class="text-sm font-semibold text-amber-900 underline decoration-2 underline-offset-2 hover:text-amber-700">
        {{fallback .LinkLabel "詳細を確認"}}
      </a>
    {{end}}
  </div>
</div>
{{end}}

{{define "promotionusage/filters"}}
<section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
  <form
    id="promotion-usage-filter"
    method="get"
    class="space-y-6"
    hx-get="{{.TableEndpoint}}"
    hx-target="#promotion-usage-table"
    hx-swap="outerHTML"
    hx-push-url="true"
  >
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="pageSize" value="{{maxInt .Query.PageSize 1}}" />
    {{if trimSpace .Query.SortKey}}
      <input type="hidden" name="sort" value="{{.Query.SortKey}}" />
    {{end}}
    {{if trimSpace .Query.SortDirection}}
      <input type="hidden" name="direction" value="{{.Query.SortDirection}}" />
    {{end}}
    {{if trimSpace .Query.StartInput}}
      <input type="hidden" name="start" value="{{.Query.StartInput}}" />
    {{end}}
    {{if trimSpace .Query.EndInput}}
      <input type="hidden" name="end" value="{{.Query.EndInput}}" />
    {{end}}

    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-2">
        <label class="inline-flex items-center gap-2 text-sm text-slate-600">
          <input
            type="checkbox"
            name="autoRefresh"
            value="1"
            class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
            {{if .Query.AutoRefresh}}checked{{end}}
            hx-trigger="change"
            hx-get="{{.TableEndpoint}}"
            hx-target="#promotion-usage-table"
            hx-swap="outerHTML"
            hx-include="#promotion-usage-filter"
          />
          <span>{{.AutoRefreshLabel}}</span>
        </label>
      </div>
      {{template "promotionusage/export-toolbar" .}}
    </div>

    <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-4">
      <div class="flex flex-col gap-2">
        <label for="usage-min" class="text-xs font-semibold uppercase tracking-wide text-slate-500">最低利用回数</label>
        <input
          id="usage-min"
          name="minUses"
          type="number"
          min="0"
          value="{{.Query.MinUses}}"
          placeholder="例) 3"
          class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        />
      </div>
      <div class="flex flex-col gap-2">
        <label for="usage-timeframe" class="text-xs font-semibold uppercase tracking-wide text-slate-500">期間</label>
        <select
          id="usage-timeframe"
          name="timeframe"
          class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        >
          {{range $option := .Filters.TimeframeOptions}}
            <option value="{{$option.Key}}" {{if $option.Selected}}selected{{end}}>{{$option.Label}}</option>
          {{end}}
        </select>
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">チャネル</label>
        <div class="flex flex-wrap gap-2">
          {{range $option := .Filters.ChannelOptions}}
            <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1 text-xs text-slate-600 shadow-sm hover:border-brand-300">
              <input
                type="checkbox"
                name="channel"
                value="{{$option.Value}}"
                class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                {{if $option.Selected}}checked{{end}}
              />
              <span>
                {{$option.Label}}
                {{if gt $option.Count 0}}
                  <span class="ml-1 text-slate-400">({{$option.Count}})</span>
                {{end}}
              </span>
            </label>
          {{end}}
        </div>
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">利用チャネル元</label>
        <div class="flex flex-wrap gap-2">
          {{range $option := .Filters.SourceOptions}}
            <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1 text-xs text-slate-600 shadow-sm hover:border-brand-300">
              <input
                type="checkbox"
                name="source"
                value="{{$option.Value}}"
                class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                {{if $option.Selected}}checked{{end}}
              />
              <span>
                {{$option.Label}}
                {{if gt $option.Count 0}}
                  <span class="ml-1 text-slate-400">({{$option.Count}})</span>
                {{end}}
              </span>
            </label>
          {{end}}
        </div>
      </div>
      <div class="flex flex-col gap-2 md:col-span-2 lg:col-span-4">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500">セグメント</label>
        <div class="flex flex-wrap gap-2">
          {{range $option := .Filters.SegmentOptions}}
            <label class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1 text-xs text-slate-600 shadow-sm hover:border-brand-300">
              <input
                type="checkbox"
                name="segment"
                value="{{$option.Value}}"
                class="h-4 w-4 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                {{if $option.Selected}}checked{{end}}
              />
              <span>
                {{$option.Label}}
                {{if gt $option.Count 0}}
                  <span class="ml-1 text-slate-400">({{$option.Count}})</span>
                {{end}}
              </span>
            </label>
          {{end}}
        </div>
      </div>
    </div>

    <div class="flex items-center justify-end gap-3">
      <button type="submit" class="{{buttonClass "primary" "sm" false false}}">適用</button>
      <a
        href="{{.TableEndpoint}}"
        class="{{buttonClass "secondary" "sm" false false}}"
        hx-get="{{.TableEndpoint}}"
        hx-target="#promotion-usage-table"
        hx-swap="outerHTML"
        hx-push-url="true"
      >
        リセット
      </a>
    </div>
  </form>
</section>
{{end}}

{{define "promotionusage/export-toolbar"}}
<form
  method="post"
  hx-post="{{.ExportEndpoint}}"
  hx-target="#promotion-usage-export"
  hx-swap="outerHTML"
  class="flex items-center gap-2"
>
  <input type="hidden" name="promotionName" value="{{.Promotion.Name}}" />
  <input type="hidden" name="promotionCode" value="{{.Promotion.Code}}" />
  {{if gt .Query.MinUses 0}}
    <input type="hidden" name="minUses" value="{{.Query.MinUses}}" />
  {{end}}
  {{if trimSpace .Query.Timeframe}}
    <input type="hidden" name="timeframe" value="{{.Query.Timeframe}}" />
  {{end}}
  {{range $ch := .Query.Channels}}
    <input type="hidden" name="channel" value="{{$ch}}" />
  {{end}}
  {{range $src := .Query.Sources}}
    <input type="hidden" name="source" value="{{$src}}" />
  {{end}}
  {{range $seg := .Query.Segments}}
    <input type="hidden" name="segment" value="{{$seg}}" />
  {{end}}
  {{if trimSpace .Query.SortKey}}
    <input type="hidden" name="sort" value="{{.Query.SortKey}}" />
  {{end}}
  {{if trimSpace .Query.SortDirection}}
    <input type="hidden" name="direction" value="{{.Query.SortDirection}}" />
  {{end}}
  {{if gt .Query.PageSize 0}}
    <input type="hidden" name="pageSize" value="{{.Query.PageSize}}" />
  {{end}}
  {{if trimSpace .Query.StartInput}}
    <input type="hidden" name="start" value="{{.Query.StartInput}}" />
  {{end}}
  {{if trimSpace .Query.EndInput}}
    <input type="hidden" name="end" value="{{.Query.EndInput}}" />
  {{end}}
  <button type="submit" class="{{buttonClass "secondary" "sm" false false}}" data-loading-text="エクスポート中...">CSVエクスポート</button>
</form>
{{end}}
