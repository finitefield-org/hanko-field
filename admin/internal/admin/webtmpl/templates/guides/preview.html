{{define "guides/preview"}}
{{template "layouts/base" .}}
{{end}}

{{define "guides/preview-content"}}
{{$page := .Page}}
<div class="space-y-6">
  {{template "guides/preview-header" $page.Header}}
  <div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_360px]">
    <section class="space-y-4">
      {{template "guides/preview-viewport" $page.Viewer}}
    </section>
    <aside class="space-y-4">
      {{template "guides/preview-sidebar" (dict "Sidebar" $page.Sidebar "ShareURL" $page.Header.ShareURL)}}
    </aside>
  </div>
  {{template "guides/preview-action-bar" $page.Feedback}}
</div>
{{end}}

{{define "guides/preview-header"}}
<section class="sticky top-20 z-10 rounded-2xl border border-slate-200 bg-white/90 px-6 py-5 shadow-sm backdrop-blur">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-2">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">ガイドプレビュー</p>
      <h1 class="text-3xl font-semibold text-slate-900">{{.Title}}</h1>
      {{if .Subtitle}}
        <p class="max-w-2xl text-sm text-slate-600">{{.Subtitle}}</p>
      {{end}}
      <div class="flex flex-wrap items-center gap-3 text-sm text-slate-500">
        <span class="{{badgeClass .StatusTone}}">{{.StatusLabel}}</span>
        {{if .UpdatedRelative}}
          <span>最終更新 {{.UpdatedRelative}}</span>
        {{end}}
        {{if .UpdatedAt}}
          <span class="hidden md:inline text-slate-400">({{.UpdatedAt}})</span>
        {{end}}
      </div>
    </div>
    <div class="flex flex-col items-stretch gap-4 lg:items-end">
      {{template "guides/preview-locale-switcher" .LocaleOptions}}
      <div class="flex flex-wrap justify-end gap-2 text-sm">
        {{if .ShareURL}}
          <a href="{{.ShareURL}}" target="_blank" rel="noreferrer" class="btn btn-secondary btn-sm">
            <span>共有リンク</span>
            <span aria-hidden="true">↗</span>
          </a>
        {{end}}
        {{if .ExternalURL}}
          <a href="{{.ExternalURL}}" target="_blank" rel="noreferrer" class="btn btn-ghost btn-sm">
            公開ページを開く
          </a>
        {{end}}
      </div>
    </div>
  </div>
</section>
{{end}}

{{define "guides/preview-locale-switcher"}}
{{if gt (len .) 0}}
  <div class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-100 p-1 text-sm font-medium text-slate-600" role="tablist" aria-label="ロケール選択">
    {{range $option := .}}
      <a
        href="{{$option.URL}}"
        class="{{guidesPreviewLocaleClass $option.Active}}"
        role="tab"
        aria-selected="{{boolAttr $option.Active}}"
      >
        {{$option.Label}}
      </a>
    {{end}}
  </div>
{{end}}
{{end}}

{{define "guides/preview-viewport"}}
<div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
  <div class="flex flex-wrap items-center justify-between gap-3 border-b border-slate-200 px-6 py-3">
    <div>
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">プレビュー</p>
      {{if .Language}}
        <p class="text-xs text-slate-400">閲覧中の言語: {{.Language}}</p>
      {{end}}
    </div>
    {{if gt (len .DeviceModes) 0}}
      <div class="inline-flex items-center gap-1 rounded-full bg-slate-100 p-1 text-xs font-semibold text-slate-600">
        {{range $mode := .DeviceModes}}
          <button type="button" class="{{guidesPreviewModeClass $mode.Active}}" {{if $mode.Active}}disabled{{end}}>
            {{$mode.Label}}
          </button>
        {{end}}
      </div>
    {{end}}
  </div>
  <div class="space-y-6 px-6 py-6">
    {{if .HeroImageURL}}
      <div class="overflow-hidden rounded-2xl shadow-sm ring-1 ring-slate-200">
        <img src="{{.HeroImageURL}}" alt="" class="h-64 w-full object-cover" />
      </div>
    {{end}}
    <article class="prose prose-slate max-w-none">
      {{.Body}}
    </article>
  </div>
</div>
{{end}}

{{define "guides/preview-sidebar"}}
{{$sidebar := .Sidebar}}
<div class="space-y-4">
  <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">メタデータ</h2>
    <dl class="mt-4 space-y-3 text-sm text-slate-600">
      {{if $sidebar.Summary}}
        <div class="space-y-1">
          <dt class="font-medium text-slate-500">概要</dt>
          <dd class="leading-relaxed">{{$sidebar.Summary}}</dd>
        </div>
      {{end}}
      {{if $sidebar.PersonaLabel}}
        {{template "guides/preview-meta-row" (dict "Label" "ペルソナ" "Value" $sidebar.PersonaLabel)}}
      {{end}}
      {{if $sidebar.CategoryLabel}}
        {{template "guides/preview-meta-row" (dict "Label" "カテゴリ" "Value" $sidebar.CategoryLabel)}}
      {{end}}
      {{if $sidebar.LocaleLabel}}
        {{template "guides/preview-meta-row" (dict "Label" "言語" "Value" $sidebar.LocaleLabel)}}
      {{end}}
      {{if $sidebar.Author}}
        {{template "guides/preview-meta-row" (dict "Label" "オーナー" "Value" $sidebar.Author)}}
      {{end}}
      {{if $sidebar.ReadingTime}}
        {{template "guides/preview-meta-row" (dict "Label" "想定読了" "Value" $sidebar.ReadingTime)}}
      {{end}}
      {{if gt $sidebar.WordCount 0}}
        {{template "guides/preview-meta-row" (dict "Label" "語数" "Value" (printf "%d 語" $sidebar.WordCount))}}
      {{end}}
      {{if $sidebar.PublishedLabel}}
        {{template "guides/preview-meta-row" (dict "Label" "公開済み" "Value" $sidebar.PublishedLabel)}}
      {{end}}
      {{if $sidebar.ScheduleLabel}}
        {{template "guides/preview-meta-row" (dict "Label" "公開予定" "Value" $sidebar.ScheduleLabel)}}
      {{end}}
      {{if $sidebar.UpdatedDisplay}}
        {{template "guides/preview-meta-row" (dict "Label" $sidebar.UpdatedLabel "Value" $sidebar.UpdatedDisplay)}}
      {{end}}
      {{if .ShareURL}}
        <div class="space-y-1">
          <dt class="font-medium text-slate-500">共有URL</dt>
          <dd class="break-all rounded-lg bg-slate-50 px-3 py-2 text-xs text-slate-500">{{.ShareURL}}</dd>
        </div>
      {{end}}
      {{if gt (len $sidebar.Tags) 0}}
        <div class="space-y-1">
          <dt class="font-medium text-slate-500">タグ</dt>
          <dd class="flex flex-wrap gap-2">
            {{range $tag := $sidebar.Tags}}
              <span class="rounded-full bg-slate-100 px-3 py-1 text-xs text-slate-600">{{$tag}}</span>
            {{end}}
          </dd>
        </div>
      {{end}}
    </dl>
  </section>
  {{if gt (len $sidebar.Notes) 0}}
    <section class="rounded-2xl border border-amber-200 bg-amber-50 p-6 shadow-sm">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-amber-700">レビューメモ</h2>
      <ul class="mt-4 space-y-3 text-sm text-amber-900">
        {{range $note := $sidebar.Notes}}
          <li class="rounded-xl bg-white px-4 py-3 shadow-sm ring-1 ring-amber-100">{{$note}}</li>
        {{end}}
      </ul>
    </section>
  {{end}}
  {{if gt (len $sidebar.Upcoming) 0}}
    <section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500">今後の予定</h2>
      <ol class="mt-4 space-y-4">
        {{range $event := $sidebar.Upcoming}}
          <li class="flex gap-3 rounded-xl border border-slate-200 px-4 py-3">
            {{if trimSpace $event.Icon}}
              <span class="text-xl">{{$event.Icon}}</span>
            {{end}}
            <div class="space-y-1 text-sm">
              <p class="font-semibold text-slate-800">{{$event.Title}}</p>
              {{if $event.Description}}
                <p class="text-slate-600">{{$event.Description}}</p>
              {{end}}
              <p class="text-xs text-slate-500">{{$event.OccursLabel}} · {{$event.Relative}}</p>
            </div>
          </li>
        {{end}}
      </ol>
    </section>
  {{end}}
</div>
{{end}}

{{define "guides/preview-action-bar"}}
<section class="sticky bottom-8 rounded-2xl border border-slate-200 bg-white p-5 shadow-lg">
  <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div class="w-full md:max-w-xl">
      <label for="preview-feedback" class="text-sm font-semibold text-slate-700">フィードバック</label>
      <textarea
        id="preview-feedback"
        rows="2"
        class="mt-2 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700 shadow-inner focus:border-brand-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-brand-500"
        placeholder="{{.CommentPlaceholder}}"
      ></textarea>
    </div>
    <div class="flex shrink-0 items-center gap-2">
      {{if .RequestChangesURL}}
        <a href="{{.RequestChangesURL}}" class="btn btn-outline btn-md">修正依頼</a>
      {{end}}
      {{if .ApproveURL}}
        <a href="{{.ApproveURL}}" class="btn btn-primary btn-md">承認</a>
      {{end}}
    </div>
  </div>
</section>
{{end}}

{{define "guides/preview-meta-row"}}
<div class="flex items-start justify-between gap-3">
  <dt class="font-medium text-slate-500">{{.Label}}</dt>
  <dd class="text-right text-slate-700">{{.Value}}</dd>
</div>
{{end}}
