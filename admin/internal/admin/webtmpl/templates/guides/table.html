{{define "guides/table-fragment"}}
<div
  id="guides-table"
  class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm"
  data-guides-table
  hx-swap-oob="true"
  data-fragment-path="{{.Table.FragmentPath}}"
  data-fragment-query="{{.Table.RawQuery}}"
>
  {{template "guides/table" (dict "Table" .Table "CSRFToken" .CSRFToken)}}
</div>
<div id="guides-summary" hx-swap-oob="true">
  {{template "guides/summary-chips" .Summary}}
</div>
<div id="guides-bulk-area" hx-swap-oob="true">
  {{template "guides/bulk-section" (dict "Bulk" .Bulk "CSRFToken" .CSRFToken)}}
</div>
<div id="guides-drawer" hx-swap-oob="true">
  {{template "guides/drawer" .Drawer}}
</div>
{{end}}

{{define "guides/table"}}
{{$table := .Table}}
{{$csrf := .CSRFToken}}
{{if $table.Error}}
  <div class="border-b border-danger-100 bg-danger-50 px-6 py-4 text-sm text-danger-700">
    {{$table.Error}}
  </div>
{{end}}

{{if eq (len $table.Rows) 0}}
  <div class="px-6 py-16 text-center text-sm text-slate-500">
    {{if $table.EmptyMessage}}
      {{$table.EmptyMessage}}
    {{else}}
      ガイドが見つかりませんでした。
    {{end}}
  </div>
{{else}}
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-slate-200 text-sm">
      <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500">
        <tr>
          <th scope="col" class="px-4 py-3 text-left">
            <input type="checkbox" class="rounded border-slate-300 text-brand-600 focus:ring-brand-500" data-guides-select-all />
          </th>
          <th scope="col" class="px-4 py-3 text-left">ガイド</th>
          <th scope="col" class="px-4 py-3 text-left">ロケール</th>
          <th scope="col" class="px-4 py-3 text-left">担当</th>
          <th scope="col" class="px-4 py-3 text-left">ステータス</th>
          <th scope="col" class="px-4 py-3 text-left">公開予定</th>
          <th scope="col" class="px-4 py-3 text-left">更新</th>
          <th scope="col" class="px-4 py-3 text-left">アクション</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200 text-slate-700">
        {{range $row := $table.Rows}}
          <tr
            class="{{guidesTableRowClass $row.Selected}}"
            data-selected="{{boolAttr $row.Selected}}"
            {{range $k, $v := $row.Attributes}} {{$k}}="{{$v}}"{{end}}
          >
            <td class="px-4 py-4 align-top">
              <input
                type="checkbox"
                class="rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                value="{{$row.ID}}"
                data-guide-select
                {{if $row.Selected}}checked{{end}}
              />
            </td>
            <td class="px-4 py-4 align-top">
              <div class="space-y-1">
                <p class="text-sm font-semibold text-slate-900">{{$row.Title}}</p>
                <p class="text-xs text-slate-500">{{$row.Summary}}</p>
                <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                  <span>カテゴリ: {{$row.CategoryLabel}}</span>
                  <span>ペルソナ: {{$row.PersonaLabel}}</span>
                </div>
              </div>
            </td>
            <td class="px-4 py-4 align-top text-slate-600">{{$row.LocaleLabel}}</td>
            <td class="px-4 py-4 align-top text-slate-600">{{$row.Author}}</td>
            <td class="px-4 py-4 align-top">
              <span class="{{badgeClass $row.StatusTone}}">{{$row.StatusLabel}}</span>
              <div class="mt-2 space-y-1">
                {{if $row.IsPublished}}
                  <form
                    hx-post="{{$row.UnpublishURL}}"
                    hx-target="#guides-table"
                    hx-swap="outerHTML"
                    hx-include="#guides-filter"
                    class="inline"
                  >
                    <input type="hidden" name="csrf_token" value="{{$csrf}}" />
                    <button type="submit" class="{{buttonClass "ghost" "xs" false false}}">下書きへ戻す</button>
                  </form>
                {{else}}
                  <form
                    hx-post="{{$row.PublishURL}}"
                    hx-target="#guides-table"
                    hx-swap="outerHTML"
                    hx-include="#guides-filter"
                    class="inline"
                  >
                    <input type="hidden" name="csrf_token" value="{{$csrf}}" />
                    <button type="submit" class="{{buttonClass "ghost" "xs" false false}}">公開する</button>
                  </form>
                {{end}}
              </div>
            </td>
            <td class="px-4 py-4 align-top">
              <form
                class="space-y-2"
                hx-post="{{$row.ScheduleURL}}"
                hx-target="#guides-table"
                hx-swap="outerHTML"
                hx-include="#guides-filter"
              >
                <input type="hidden" name="csrf_token" value="{{$csrf}}" />
                <label class="sr-only" for="{{printf "schedule-%s" $row.ID}}">公開予定</label>
                <input
                  type="datetime-local"
                  id="{{printf "schedule-%s" $row.ID}}"
                  name="scheduledAt"
                  value="{{$row.ScheduleInputValue}}"
                  class="w-48 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
                />
                <div class="flex items-center gap-2">
                  <button type="submit" class="{{buttonClass "secondary" "xs" false false}}">保存</button>
                  <button
                    type="button"
                    class="{{buttonClass "ghost" "xs" false false}}"
                    hx-post="{{$row.UnscheduleURL}}"
                    hx-target="#guides-table"
                    hx-swap="outerHTML"
                    hx-include="#guides-filter"
                    data-guides-unschedule
                  >
                    解除
                  </button>
                </div>
                <p class="text-xs text-slate-400">{{$row.ScheduleHint}}</p>
              </form>
            </td>
            <td class="px-4 py-4 align-top text-xs text-slate-500">
              <div class="flex flex-col">
                <span>{{$row.UpdatedRelative}}</span>
                <span class="text-slate-400" title="{{$row.UpdatedTooltip}}">{{$row.UpdatedTooltip}}</span>
              </div>
            </td>
            <td class="px-4 py-4 align-top">
              <div class="flex flex-wrap gap-2">
                {{range $action := $row.Actions}}
                  <a
                    href="{{$action.URL}}"
                    class="inline-flex items-center gap-1 rounded-md border border-slate-200 px-3 py-1.5 text-xs text-slate-600 transition hover:border-brand-300 hover:text-brand-600"
                  >
                    {{if $action.Icon}}<span>{{$action.Icon}}</span>{{end}}
                    {{$action.Label}}
                  </a>
                {{end}}
              </div>
            </td>
          </tr>
        {{end}}
      </tbody>
    </table>
  </div>
{{end}}
{{end}}

{{define "guides/drawer"}}
<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm" data-guides-drawer>
  {{if .Empty}}
    <div class="space-y-2 text-sm text-slate-600">
      <p class="text-base font-semibold text-slate-900">ガイドを選択してください</p>
      <p>一覧からガイドを選択すると、ここに概要と公開予定が表示されます。</p>
    </div>
  {{else}}
    <div class="flex flex-col gap-4">
      <div class="space-y-2">
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{.LocaleLabel}} · {{.PersonaLabel}}</p>
        <h2 class="text-lg font-semibold text-slate-900">{{.Title}}</h2>
        <p class="text-sm text-slate-600">{{.Summary}}</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="{{badgeClass .StatusTone}}">{{.StatusLabel}}</span>
        {{if .PublishedLabel}}
          <span class="text-xs text-slate-500">公開: {{.PublishedLabel}}</span>
        {{end}}
        {{if .ScheduledLabel}}
          <span class="text-xs text-slate-500">予定: {{.ScheduledLabel}}</span>
        {{end}}
      </div>
      {{if .HeroImageURL}}
        <div class="overflow-hidden rounded-xl border border-slate-200">
          <img src="{{.HeroImageURL}}" alt="ガイドのカバー" class="h-48 w-full object-cover" loading="lazy" />
        </div>
      {{end}}
      {{if gt (len .Highlights) 0}}
        <div class="grid gap-3 sm:grid-cols-2">
          {{range $highlight := .Highlights}}
            <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-3 text-sm text-slate-700">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{$highlight.Label}}</p>
              <p class="mt-1 text-base font-semibold text-slate-900">
                {{if $highlight.Icon}}<span class="mr-1">{{$highlight.Icon}}</span>{{end}}
                {{$highlight.Value}}
              </p>
            </div>
          {{end}}
        </div>
      {{end}}
      {{if gt (len .Timeline) 0}}
        <div class="space-y-3">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">予定</h3>
          <ol class="space-y-3 text-sm text-slate-600">
            {{range $event := .Timeline}}
              <li class="rounded-lg border border-slate-200 px-3 py-2">
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  {{if $event.Icon}}<span>{{$event.Icon}}</span>{{end}}
                  <span>{{$event.Relative}}</span>
                </div>
                <p class="mt-1 font-medium text-slate-800">{{$event.Title}}</p>
                {{if $event.Description}}
                  <p class="text-xs text-slate-500">{{$event.Description}}</p>
                {{end}}
                <p class="mt-1 text-xs text-slate-400">{{$event.OccursLabel}}</p>
              </li>
            {{end}}
          </ol>
        </div>
      {{end}}
      {{if .LastChangeNote}}
        <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500">
          <p><span class="font-semibold">最終更新:</span> {{.LastChangeNote}}</p>
        </div>
      {{end}}
      {{if gt (len .Tags) 0}}
        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
          <span class="font-semibold uppercase tracking-wide">タグ:</span>
          {{range $tag := .Tags}}
            <span class="rounded-full bg-slate-100 px-2 py-1">{{$tag}}</span>
          {{end}}
        </div>
      {{end}}
      <p class="text-xs text-slate-400">更新: {{.UpdatedLabel}} ({{.UpdatedRelative}})</p>
    </div>
  {{end}}
</section>
{{end}}
