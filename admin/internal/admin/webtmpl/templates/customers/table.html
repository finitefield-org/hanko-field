{{define "customers/table"}}
{{$table := .Table}}
{{$sort := $table.Sort}}
{{$locale := .Locale}}
<div class="space-y-4" data-customers-table-fragment>
  {{if $table.Error}}
    <div class="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-800">
      {{$table.Error}}
    </div>
  {{end}}

  <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
    <table class="min-w-full divide-y divide-slate-200">
      <thead class="bg-slate-50">
        <tr class="text-xs font-semibold uppercase tracking-wide text-slate-500">
          <th scope="col" class="px-4 py-3 text-left text-slate-600">{{localize $locale "admin.customers.table.header.customer"}}</th>
          {{$ordersLabel := localize $locale "admin.customers.table.header.orders"}}
          {{$ordersDir := sortCurrentDirection $sort.Active "total_orders"}}
          <th
            scope="col"
            class="px-4 py-3 text-right text-slate-600"
            aria-sort="{{sortAria $ordersDir}}"
            data-sort-key="total_orders"
            data-sort-direction="{{$ordersDir}}"
          >
            <a
              class="{{sortHeaderClass $ordersDir}}"
              href="{{sortHref $sort.BasePath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "total_orders" "desc" true}}"
              {{if or $table.HxTarget $table.HxSwap $sort.HxPushURL}}
                hx-get="{{sortHxHref $sort.FragmentPath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "total_orders" "desc" true}}"
                {{if $table.HxTarget}}hx-target="{{$table.HxTarget}}"{{end}}
                {{if $table.HxSwap}}hx-swap="{{$table.HxSwap}}"{{end}}
                {{if $sort.HxPushURL}}hx-push-url="true"{{end}}
              {{end}}
              role="button"
              aria-pressed="{{if $ordersDir}}true{{else}}false{{end}}"
              data-next-direction="{{sortNextDirectionAttr $sort.Active "total_orders" "desc"}}"
            >
              <span class="flex items-center gap-1">
                <span>{{$ordersLabel}}</span>
                <span class="sr-only">{{sortSrLabel $ordersLabel $sort.Active "total_orders" "desc"}}</span>
                <span aria-hidden="true" class="{{sortIconClass $ordersDir}}">
                  {{if eq $ordersDir "asc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M10 5l-3 3h6l-3-3z" fill="currentColor"></path>
                      <path d="M13 12l-3 3-3-3h6z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                    </svg>
                  {{else if eq $ordersDir "desc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M7 8l3-3 3 3H7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                      <path d="M10 15l3-3H7l3 3z" fill="currentColor"></path>
                    </svg>
                  {{else}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-500" focusable="false">
                      <path d="M10 5l-2.5 2.5h5L10 5z" fill="currentColor" opacity="0.75"></path>
                      <path d="M10 15l2.5-2.5h-5L10 15z" fill="currentColor" opacity="0.75"></path>
                    </svg>
                  {{end}}
                </span>
              </span>
            </a>
          </th>
          {{$ltvLabel := localize $locale "admin.customers.table.header.ltv"}}
          {{$ltvDir := sortCurrentDirection $sort.Active "lifetime_value"}}
          <th
            scope="col"
            class="px-4 py-3 text-right text-slate-600"
            aria-sort="{{sortAria $ltvDir}}"
            data-sort-key="lifetime_value"
            data-sort-direction="{{$ltvDir}}"
          >
            <a
              class="{{sortHeaderClass $ltvDir}}"
              href="{{sortHref $sort.BasePath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "lifetime_value" "desc" true}}"
              {{if or $table.HxTarget $table.HxSwap $sort.HxPushURL}}
                hx-get="{{sortHxHref $sort.FragmentPath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "lifetime_value" "desc" true}}"
                {{if $table.HxTarget}}hx-target="{{$table.HxTarget}}"{{end}}
                {{if $table.HxSwap}}hx-swap="{{$table.HxSwap}}"{{end}}
                {{if $sort.HxPushURL}}hx-push-url="true"{{end}}
              {{end}}
              role="button"
              aria-pressed="{{if $ltvDir}}true{{else}}false{{end}}"
              data-next-direction="{{sortNextDirectionAttr $sort.Active "lifetime_value" "desc"}}"
            >
              <span class="flex items-center gap-1">
                <span>{{$ltvLabel}}</span>
                <span class="sr-only">{{sortSrLabel $ltvLabel $sort.Active "lifetime_value" "desc"}}</span>
                <span aria-hidden="true" class="{{sortIconClass $ltvDir}}">
                  {{if eq $ltvDir "asc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M10 5l-3 3h6l-3-3z" fill="currentColor"></path>
                      <path d="M13 12l-3 3-3-3h6z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                    </svg>
                  {{else if eq $ltvDir "desc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M7 8l3-3 3 3H7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                      <path d="M10 15l3-3H7l3 3z" fill="currentColor"></path>
                    </svg>
                  {{else}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-500" focusable="false">
                      <path d="M10 5l-2.5 2.5h5L10 5z" fill="currentColor" opacity="0.75"></path>
                      <path d="M10 15l2.5-2.5h-5L10 15z" fill="currentColor" opacity="0.75"></path>
                    </svg>
                  {{end}}
                </span>
              </span>
            </a>
          </th>
          {{$lastOrderLabel := localize $locale "admin.customers.table.header.last_order"}}
          {{$lastOrderDir := sortCurrentDirection $sort.Active "last_order"}}
          <th
            scope="col"
            class="px-4 py-3 text-left text-slate-600"
            aria-sort="{{sortAria $lastOrderDir}}"
            data-sort-key="last_order"
            data-sort-direction="{{$lastOrderDir}}"
          >
            <a
              class="{{sortHeaderClass $lastOrderDir}}"
              href="{{sortHref $sort.BasePath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "last_order" "desc" true}}"
              {{if or $table.HxTarget $table.HxSwap $sort.HxPushURL}}
                hx-get="{{sortHxHref $sort.FragmentPath $sort.RawQuery $sort.Param $sort.PageParam $sort.Active "last_order" "desc" true}}"
                {{if $table.HxTarget}}hx-target="{{$table.HxTarget}}"{{end}}
                {{if $table.HxSwap}}hx-swap="{{$table.HxSwap}}"{{end}}
                {{if $sort.HxPushURL}}hx-push-url="true"{{end}}
              {{end}}
              role="button"
              aria-pressed="{{if $lastOrderDir}}true{{else}}false{{end}}"
              data-next-direction="{{sortNextDirectionAttr $sort.Active "last_order" "desc"}}"
            >
              <span class="flex items-center gap-1">
                <span>{{$lastOrderLabel}}</span>
                <span class="sr-only">{{sortSrLabel $lastOrderLabel $sort.Active "last_order" "desc"}}</span>
                <span aria-hidden="true" class="{{sortIconClass $lastOrderDir}}">
                  {{if eq $lastOrderDir "asc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M10 5l-3 3h6l-3-3z" fill="currentColor"></path>
                      <path d="M13 12l-3 3-3-3h6z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                    </svg>
                  {{else if eq $lastOrderDir "desc"}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-600" focusable="false">
                      <path d="M7 8l3-3 3 3H7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" fill="none" opacity="0.45"></path>
                      <path d="M10 15l3-3H7l3 3z" fill="currentColor"></path>
                    </svg>
                  {{else}}
                    <svg viewBox="0 0 20 20" fill="none" class="h-4 w-4 text-slate-500" focusable="false">
                      <path d="M10 5l-2.5 2.5h5L10 5z" fill="currentColor" opacity="0.75"></path>
                      <path d="M10 15l2.5-2.5h-5L10 15z" fill="currentColor" opacity="0.75"></path>
                    </svg>
                  {{end}}
                </span>
              </span>
            </a>
          </th>
          <th scope="col" class="px-4 py-3 text-left text-slate-600">{{localize $locale "admin.customers.table.header.flags"}}</th>
          <th scope="col" class="px-4 py-3 text-right text-slate-600">{{localize $locale "admin.customers.table.header.actions"}}</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-200 text-sm text-slate-700">
        {{if eq (len $table.Rows) 0}}
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-sm text-slate-500">
              {{if $table.EmptyMessage}}
                {{$table.EmptyMessage}}
              {{else}}
                {{localize $locale "admin.customers.table.empty"}}
              {{end}}
            </td>
          </tr>
        {{else}}
          {{range $row := $table.Rows}}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-4">
                <div class="flex items-start gap-3">
                  <div class="avatar h-10 w-10 rounded-full bg-slate-200 text-center text-sm font-semibold text-slate-600">
                    {{if $row.AvatarURL}}
                      <img src="{{$row.AvatarURL}}" alt="{{$row.AvatarAlt}}" class="h-10 w-10 rounded-full object-cover" />
                    {{else}}
                      <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-slate-200 text-slate-600">
                        {{customersInitials $row.DisplayName (localize $locale "admin.customers.avatar.initials_fallback")}}
                      </span>
                    {{end}}
                  </div>
                  <div class="flex flex-col gap-1">
                    <div class="flex items-center gap-2">
                      <a href="{{$row.DetailURL}}" class="font-semibold text-slate-900 hover:text-brand-600">
                        {{$row.DisplayName}}
                      </a>
                      {{if $row.StatusLabel}}
                        <span class="{{badgeClass $row.StatusTone}}">{{$row.StatusLabel}}</span>
                      {{end}}
                      {{if $row.TierLabel}}
                        <span class="{{badgeClass $row.TierTone}}">{{$row.TierLabel}}</span>
                      {{end}}
                      {{if $row.RiskLabel}}
                        <span class="{{badgeClass $row.RiskTone}}">{{$row.RiskLabel}}</span>
                      {{end}}
                    </div>
                    {{if $row.Email}}
                      <p class="text-xs text-slate-500">{{$row.Email}}</p>
                    {{end}}
                    {{if or $row.Company $row.Location}}
                      <p class="text-xs text-slate-400">
                        {{if $row.Company}}{{$row.Company}}{{end}}
                        {{if and $row.Company $row.Location}} · {{end}}
                        {{if $row.Location}}{{$row.Location}}{{end}}
                      </p>
                    {{end}}
                  </div>
                </div>
              </td>
              <td class="px-4 py-4 text-right font-semibold text-slate-900">{{$row.TotalOrdersLabel}}</td>
              <td class="px-4 py-4 text-right font-semibold text-slate-900">{{$row.LifetimeValue}}</td>
              <td class="px-4 py-4">
                {{if $row.LastOrderLabel}}
                  <div class="flex flex-col">
                    <span class="font-medium text-slate-900">{{$row.LastOrderLabel}}</span>
                    {{if $row.LastOrderRelative}}
                      <span class="text-xs text-slate-400">{{$row.LastOrderRelative}}</span>
                    {{end}}
                    {{if $row.LastOrderNumber}}
                      <span class="text-xs text-slate-500">#{{$row.LastOrderNumber}}</span>
                    {{end}}
                  </div>
                {{else}}
                  <span class="text-xs text-slate-400">{{localize $locale "admin.customers.table.no_orders"}}</span>
                {{end}}
              </td>
              <td class="px-4 py-4">
                <div class="flex flex-wrap items-center gap-2">
                  {{range $flag := $row.Flags}}
                    <span class="{{badgeClass $flag.Tone}}" {{if $flag.Title}}title="{{$flag.Title}}"{{end}}>
                      {{if $flag.Icon}}<span aria-hidden="true" class="mr-1">{{$flag.Icon}}</span>{{end}}
                      {{$flag.Label}}
                    </span>
                  {{end}}
                  {{range $tag := $row.Tags}}
                    <span class="rounded-full bg-slate-100 px-2 py-1 text-xs text-slate-600">#{{$tag}}</span>
                  {{end}}
                </div>
              </td>
              <td class="px-4 py-4 text-right">
                <a href="{{$row.DetailURL}}" class="inline-flex items-center gap-1 text-sm font-semibold text-brand-600 hover:text-brand-700">
                  {{localize $locale "admin.customers.table.action.view"}}
                  <span aria-hidden="true">→</span>
                </a>
              </td>
            </tr>
          {{end}}
        {{end}}
      </tbody>
    </table>
  </div>

  {{template "components/pagination" .Pagination}}
</div>
{{end}}
