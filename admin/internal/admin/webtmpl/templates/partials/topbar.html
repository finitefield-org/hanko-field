{{define "partials/topbar-actions"}}
  {{template "partials/topbar-environment" .}}
  {{if hasCap .Capabilities "search.global"}}
    {{template "partials/topbar-search" .}}
  {{end}}
  {{if hasCap .Capabilities "notifications.feed"}}
    {{template "partials/topbar-notifications" .}}
  {{end}}
  {{template "partials/topbar-workload" .}}
  {{template "partials/topbar-language" .}}
  {{template "partials/topbar-user" .}}
{{end}}

{{define "partials/topbar-environment"}}
  <span class="inline-flex" data-environment-badge>
    <span class="{{badgeClass (environmentTone .Environment)}}" title="{{environmentDisplay .Environment}}">
      <span aria-hidden="true">{{environmentLabel .Environment}}</span>
      <span class="sr-only">{{localize .Locale "admin.topbar.environment"}}: {{environmentDisplay .Environment}}</span>
    </span>
  </span>
{{end}}

{{define "partials/topbar-language"}}
  {{if and (gt (len .SupportedLocales) 1) .BasePath}}
    <form
      class="hidden items-center gap-2 rounded-md border border-slate-200 bg-white px-2 py-1 text-sm text-slate-600 shadow-sm md:inline-flex"
      hx-post="{{topbarRoute .BasePath "/preferences/locale"}}"
      hx-trigger="change"
      hx-target="this"
      hx-swap="none"
    >
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
      <label for="locale-select" class="sr-only">{{localize .Locale "admin.topbar.language.label"}}</label>
      <select
        id="locale-select"
        name="locale"
        class="bg-transparent text-sm font-medium focus:outline-none"
      >
        {{range $code := .SupportedLocales}}
          <option value="{{$code}}" {{if equalFold $.Locale $code}}selected{{end}}>{{localeDisplayName $.Locale $code}}</option>
        {{end}}
      </select>
    </form>
  {{end}}
{{end}}

{{define "partials/topbar-search"}}
  <button
    type="button"
    class="group hidden items-center gap-2 rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-1 sm:inline-flex"
    hx-get="{{topbarRoute .BasePath "/search?overlay=1"}}"
    hx-target="#modal"
    hx-swap="innerHTML"
    data-topbar-search-trigger
    data-search-href="{{topbarRoute .BasePath "/search"}}"
    aria-label="{{localize .Locale "admin.topbar.search.aria"}}"
  >
    <span class="inline-flex items-center justify-center rounded-md bg-slate-100 p-1 text-sm text-slate-600 transition group-hover:bg-slate-200 group-hover:text-slate-900">
      <svg viewBox="0 0 20 20" fill="none" aria-hidden="true" class="h-4 w-4">
        <path d="M9 3.5a5.5 5.5 0 1 1 3.5 9.748l3.376 3.376a.75.75 0 0 1-1.06 1.06l-3.376-3.375A5.5 5.5 0 0 1 9 3.5Zm0 1.5a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" fill="currentColor"></path>
      </svg>
    </span>
    <span class="text-sm font-medium">検索</span>
    <kbd class="ml-2 inline-flex items-center rounded border border-slate-200 bg-slate-50 px-1.5 py-0.5 text-[11px] font-semibold text-slate-500 shadow-sm">/</kbd>
  </button>
{{end}}

{{define "partials/topbar-notifications"}}
  <div
    class="relative"
    data-notifications-root
    hx-get="{{topbarRoute .BasePath "/notifications/badge"}}"
    hx-trigger="load"
    hx-target="this"
    hx-swap="outerHTML"
    data-notifications-href="{{topbarRoute .BasePath "/notifications"}}"
  >
    <a
      href="{{topbarRoute .BasePath "/notifications"}}"
      class="relative inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-600 shadow-sm transition hover:border-slate-300 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-1"
      data-notifications-button
      aria-label="通知センターを開く"
    >
      <span class="sr-only">通知センターを開く</span>
      <svg viewBox="0 0 20 20" fill="none" aria-hidden="true" class="h-5 w-5">
        <path d="M10 2a4.5 4.5 0 0 1 4.5 4.5v1.085c0 .472.17.93.478 1.287l.83.953c.804.924.132 2.375-1.086 2.375H5.278c-1.218 0-1.89-1.451-1.086-2.375l.83-.953A1.999 1.999 0 0 0 5.5 7.585V6.5A4.5 4.5 0 0 1 10 2Zm0 16a2.5 2.5 0 0 1-2.45-2h4.9A2.5 2.5 0 0 1 10 18Z" fill="currentColor"></path>
      </svg>
      <span
        class="absolute -top-1 -right-1 inline-flex min-w-[1.5rem] items-center justify-center rounded-full bg-danger-500 px-1 text-[11px] font-semibold leading-none text-white shadow-sm transition"
        aria-live="polite"
        aria-atomic="true"
        data-notification-count
        data-empty="true"
      >
        {{formatNotificationCount 0}}
      </span>
    </a>
  </div>
{{end}}

{{define "partials/topbar-workload"}}
  {{if .BasePath}}
    {{if or (hasCap .Capabilities "notifications.feed") (hasCap .Capabilities "reviews.moderate") (hasCap .Capabilities "system.tasks")}}
      <div
        class="hidden items-center gap-3 lg:flex"
        data-workload-badges
        data-workload-endpoint="{{topbarRoute .BasePath "/notifications/badge"}}"
        data-badge-total="0"
        data-badge-critical="0"
        data-badge-warning="0"
        data-badge-reviews="0"
        data-badge-tasks="0"
      >
        {{if hasCap .Capabilities "reviews.moderate"}}
          <span class="hidden items-center gap-1 text-xs font-medium text-slate-600" data-workload-item="reviews">
            <span aria-hidden="true">レビュー</span>
            <span
              class="{{badgeClass "warning"}} text-[11px]"
              data-workload-badge="reviews"
              data-badge-label="レビュー審査の保留"
              data-empty="true"
              aria-hidden="true"
            >
              0
            </span>
            <span
              class="sr-only"
              role="status"
              aria-live="polite"
              aria-atomic="true"
              data-workload-announcer="reviews"
              data-badge-label="レビュー審査の保留"
            >
              {{printf "%s: 0件" "レビュー審査の保留"}}
            </span>
          </span>
        {{end}}
        {{if hasCap .Capabilities "notifications.feed"}}
          <span class="hidden items-center gap-1 text-xs font-medium text-slate-600" data-workload-item="alerts">
            <span aria-hidden="true">アラート</span>
            <span
              class="{{badgeClass "danger"}} text-[11px]"
              data-workload-badge="alerts"
              data-badge-label="未対応アラート"
              data-empty="true"
              aria-hidden="true"
            >
              0
            </span>
            <span
              class="sr-only"
              role="status"
              aria-live="polite"
              aria-atomic="true"
              data-workload-announcer="alerts"
              data-badge-label="未対応アラート"
            >
              {{printf "%s: 0件" "未対応アラート"}}
            </span>
          </span>
        {{end}}
        {{if hasCap .Capabilities "system.tasks"}}
          <span class="hidden items-center gap-1 text-xs font-medium text-slate-600" data-workload-item="tasks">
            <span aria-hidden="true">タスク</span>
            <span
              class="{{badgeClass "info"}} text-[11px]"
              data-workload-badge="tasks"
              data-badge-label="未完了タスク"
              data-empty="true"
              aria-hidden="true"
            >
              0
            </span>
            <span
              class="sr-only"
              role="status"
              aria-live="polite"
              aria-atomic="true"
              data-workload-announcer="tasks"
              data-badge-label="未完了タスク"
            >
              {{printf "%s: 0件" "未完了タスク"}}
            </span>
          </span>
        {{end}}
      </div>
    {{end}}
  {{end}}
{{end}}

{{define "partials/topbar-user"}}
  {{if .BasePath}}
    <div class="relative" data-user-menu>
      <button
        type="button"
        class="flex items-center gap-2 rounded-full border border-transparent px-2 py-1 text-left text-slate-700 transition hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-1"
        data-user-menu-trigger
        aria-haspopup="menu"
        aria-expanded="false"
      >
        <span class="flex h-9 w-9 flex-shrink-0 items-center justify-center rounded-full bg-slate-100 text-sm font-semibold text-slate-600">
          {{userInitials .User}}
        </span>
        <span class="hidden min-w-0 flex-col sm:flex">
          <span class="truncate text-sm font-semibold text-slate-900">{{userDisplayName .User}}</span>
          {{if userSecondaryLabel .User}}
            <span class="truncate text-xs text-slate-500">{{userSecondaryLabel .User}}</span>
          {{end}}
        </span>
        <span class="hidden sm:inline-flex">
          <svg viewBox="0 0 20 20" fill="none" aria-hidden="true" class="h-4 w-4 text-slate-400">
            <path d="M6 8l4 4 4-4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
          </svg>
        </span>
      </button>
      <div
        class="absolute right-0 z-50 mt-2 w-56 transform rounded-md border border-slate-200 bg-white py-1 text-sm text-slate-700 shadow-xl opacity-0 pointer-events-none transition focus:outline-none"
        role="menu"
        aria-hidden="true"
        tabindex="-1"
        data-user-menu-panel
      >
        {{if hasCap .Capabilities "profile.self"}}
          <a
            href="{{topbarRoute .BasePath "/profile"}}"
            class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 focus:bg-slate-100 focus:text-slate-900"
            role="menuitem"
            tabindex="-1"
            data-user-menu-item
          >
            プロフィール
          </a>
        {{end}}
        <form method="post" action="{{topbarRoute .BasePath "/logout"}}" role="none" class="px-1" data-user-menu-logout>
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          <button
            type="submit"
            class="flex w-full items-center gap-2 rounded px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 focus:bg-slate-100 focus:text-slate-900"
            role="menuitem"
            tabindex="-1"
            data-user-menu-item
          >
            <svg viewBox="0 0 20 20" fill="none" aria-hidden="true" class="h-4 w-4 text-slate-400">
              <path d="M6.75 3.5h3.5a2.25 2.25 0 0 1 2.25 2.25v.25H11.5v-.25a1 1 0 0 0-1-1h-3.5a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h3.5a1 1 0 0 0 1-1v-.25h1.5v.25a2.25 2.25 0 0 1-2.25 2.25h-3.5A2.25 2.25 0 0 1 4.5 14.75v-9A2.25 2.25 0 0 1 6.75 3.5Zm7.28 3.22 2 2a.75.75 0 0 1 0 1.06l-2 2a.75.75 0 1 1-1.06-1.06l.72-.72H8.75a.75.75 0 0 1 0-1.5h4.94l-.72-.72a.75.75 0 1 1 1.06-1.06Z" fill="currentColor"></path>
            </svg>
            <span>ログアウト</span>
          </button>
        </form>
      </div>
    </div>
  {{end}}
{{end}}
