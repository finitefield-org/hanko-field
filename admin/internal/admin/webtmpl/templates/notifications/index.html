{{define "notifications/index"}}
{{template "layouts/base" .}}
{{end}}

{{define "notifications/content"}}
<div class="space-y-6" data-notifications-root>
  <section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">{{.Title}}</h1>
        <p class="mt-2 text-sm text-slate-600">{{.Description}}</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        {{range $legend := .Legend}}
          <span class="{{badgeClass $legend.Tone}}" title="{{$legend.Description}}">
            {{if $legend.Icon}}<span aria-hidden="true" class="mr-1">{{$legend.Icon}}</span>{{end}}
            {{$legend.Label}}
          </span>
        {{end}}
      </div>
    </div>
    <div class="mt-6 border-t border-slate-200 pt-4">
      {{template "notifications/filter-toolbar" .}}
    </div>
  </section>

  <div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_360px]">
    <section class="flex flex-col gap-4">
      <div
        id="notifications-table"
        hx-target="this"
        hx-swap="innerHTML"
        class="space-y-4"
        data-notifications-table
        data-notifications-endpoint="{{.TableEndpoint}}"
      >
        {{template "notifications/table" .Table}}
      </div>
    </section>
    <aside class="hidden xl:block">
      <div class="sticky top-20 space-y-4">
        {{template "notifications/detail-drawer" .Drawer}}
      </div>
    </aside>
  </div>
</div>
{{end}}

{{define "notifications/filter-toolbar"}}
<form
  class="flex flex-col gap-4"
  hx-get="{{.TableEndpoint}}"
  hx-trigger="submit"
  hx-target="#notifications-table"
  hx-push-url="true"
  hx-indicator="#notifications-loading"
>
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="flex flex-wrap gap-2" role="radiogroup" aria-label="ç¨®é¡">
      {{range $option := .Filters.Categories}}
        <label class="{{categoryOptionClass $option.Active}}">
          <input
            type="radio"
            name="category"
            value="{{$option.Value}}"
            class="sr-only"
            {{if $option.Active}}checked{{end}}
          />
          <span class="inline-flex items-center gap-1 text-sm">
            {{if $option.Icon}}<span aria-hidden="true">{{$option.Icon}}</span>{{end}}
            {{$option.Label}}
            {{if gt $option.Count 0}}<span class="text-xs text-slate-400">({{$option.Count}})</span>{{end}}
          </span>
        </label>
      {{end}}
    </div>
    <div class="flex items-center gap-3">
      <label class="sr-only" for="notifications-search">æ¤œç´¢</label>
      <div class="relative">
        <input
          id="notifications-search"
          name="q"
          type="search"
          value="{{.Query.Search}}"
          placeholder="é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¤œç´¢"
          class="w-72 rounded-lg border border-slate-300 bg-white py-2 pl-8 pr-3 text-sm text-slate-900 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        />
        <span class="pointer-events-none absolute inset-y-0 left-2 flex items-center text-slate-400">ğŸ”</span>
      </div>
      <button type="submit" class="{{buttonClass "primary" "sm" false false}}">é©ç”¨</button>
      <button type="reset" class="{{buttonClass "secondary" "sm" false false}}" data-notifications-reset>ã‚¯ãƒªã‚¢</button>
    </div>
  </div>

  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div class="flex flex-wrap gap-2" role="radiogroup" aria-label="å„ªå…ˆåº¦">
      {{range $option := .Filters.Severities}}
        <label class="{{severityOptionClass $option.Active $option.Tone}}">
          <input
            type="radio"
            name="severity"
            value="{{$option.Value}}"
            class="sr-only"
            {{if $option.Active}}checked{{end}}
          />
          <span class="inline-flex items-center gap-1 text-sm">
            {{$option.Label}}
            {{if gt $option.Count 0}}<span class="text-xs text-slate-400">({{$option.Count}})</span>{{end}}
          </span>
        </label>
      {{end}}
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="notifications-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <select
        id="notifications-status"
        name="status"
        class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
      >
        {{range $option := .Filters.Statuses}}
          <option value="{{$option.Value}}" {{if eq $option.Value $.Query.Status}}selected{{end}}>{{$option.Label}}</option>
        {{end}}
      </select>
      <div class="flex items-center gap-2">
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="notifications-date-start">æœŸé–“</label>
        <input
          id="notifications-date-start"
          name="start"
          type="date"
          value="{{.Query.StartDate}}"
          class="w-36 rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        />
        <span class="text-slate-400">ã€œ</span>
        <input
          id="notifications-date-end"
          name="end"
          type="date"
          value="{{.Query.EndDate}}"
          class="w-36 rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        />
      </div>
    </div>
  </div>
  <div id="notifications-loading" class="htmx-indicator text-xs text-slate-400">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</form>
{{end}}

{{define "notifications/detail-drawer"}}
<section
  class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm"
  data-notification-detail
  data-notification-id="{{.ID}}"
>
  {{if .Empty}}
    <div class="space-y-2 text-sm text-slate-600">
      <p class="text-base font-semibold text-slate-900">é€šçŸ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <p>ä¸€è¦§ã‹ã‚‰é€šçŸ¥ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨å¯¾å¿œå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>
  {{else}}
    <div class="flex flex-col gap-3">
      <div class="flex items-start justify-between gap-3" data-notification-header>
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500" data-notification-category>{{.CategoryLabel}}</p>
          <h2 class="mt-1 text-lg font-semibold text-slate-900" data-notification-title>{{.Title}}</h2>
        </div>
        <span class="{{badgeClass .SeverityTone}}" data-notification-severity>{{.SeverityLabel}}</span>
      </div>
      <p class="text-sm text-slate-600" data-notification-summary>{{.Summary}}</p>

      <dl class="mt-2 space-y-2 text-sm text-slate-600">
        <div class="flex items-center justify-between gap-2">
          <dt class="font-medium text-slate-500">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
          <dd><span class="{{badgeClass .StatusTone}}" data-notification-status>{{.StatusLabel}}</span></dd>
        </div>
        {{if .Owner}}
          <div class="flex items-center justify-between gap-2">
            <dt class="font-medium text-slate-500">æ‹…å½“</dt>
            <dd data-notification-owner>{{.Owner}}</dd>
          </div>
        {{end}}
        {{if .Resource.Label}}
          <div class="flex items-center justify-between gap-2">
            <dt class="font-medium text-slate-500">{{.Resource.Kind}}</dt>
            <dd>
              {{if .Resource.URL}}
                <a href="{{.Resource.URL}}" class="text-brand-600 hover:text-brand-500" data-notification-resource>{{.Resource.Label}}</a>
              {{else}}
                <span data-notification-resource>{{.Resource.Label}}</span>
              {{end}}
            </dd>
          </div>
        {{end}}
        <div class="flex items-center justify-between gap-2">
          <dt class="font-medium text-slate-500">æ¤œçŸ¥</dt>
          <dd title="{{.CreatedTooltip}}" data-notification-created>{{.CreatedRelative}}</dd>
        </div>
        {{if .AcknowledgedLabel}}
          <div class="flex items-center justify-between gap-2">
            <dt class="font-medium text-slate-500">ç¢ºèª</dt>
            <dd data-notification-acknowledged>{{.AcknowledgedLabel}}</dd>
          </div>
        {{end}}
        {{if .ResolvedLabel}}
          <div class="flex items-center justify-between gap-2">
            <dt class="font-medium text-slate-500">è§£æ±º</dt>
            <dd data-notification-resolved>{{.ResolvedLabel}}</dd>
          </div>
        {{end}}
      </dl>

      <div class="mt-4 space-y-2" data-notification-metadata-container {{if eq (len .Metadata) 0}}hidden{{end}}>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">è¿½åŠ æƒ…å ±</h3>
        <dl class="space-y-2 text-sm text-slate-600" data-notification-metadata>
          {{range $meta := .Metadata}}
            <div class="flex items-center justify-between gap-2">
              <dt class="font-medium text-slate-500">{{$meta.Label}}</dt>
              <dd>{{$meta.Value}}</dd>
            </div>
          {{end}}
        </dl>
      </div>

      <div class="mt-4 space-y-2" data-notification-actions {{if eq (len .Links) 0}}hidden{{end}}>
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
        <div class="flex flex-wrap gap-2" data-notification-action-list>
          {{range $action := .Links}}
            <a href="{{$action.URL}}" class="{{buttonClass "secondary" "sm" false false}}">{{$action.Label}}</a>
          {{end}}
        </div>
      </div>

      <div class="mt-6 space-y-3" data-notification-timeline-container {{if eq (len .Timeline) 0}}hidden{{end}}>
        {{if eq (len .Timeline) 0}}
          <p class="text-sm text-slate-500">ã¾ã ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {{else}}
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
          <ol class="relative border-l border-slate-200 pl-4 text-sm text-slate-600" data-notification-timeline>
            {{range $event := .Timeline}}
              <li class="mb-4 last:mb-0">
                <div class="absolute -left-1.5 h-3 w-3 rounded-full border border-white bg-slate-300"></div>
                <p class="flex items-center gap-2 text-xs text-slate-400">
                  {{if $event.Icon}}<span>{{$event.Icon}}</span>{{end}}
                  <span>{{$event.OccurredRelative}}</span>
                  {{if $event.Actor}}<span>Â· {{$event.Actor}}</span>{{end}}
                </p>
                <p class="mt-1 font-medium text-slate-800">{{$event.Title}}</p>
                {{if $event.Description}}<p class="mt-1 text-slate-600">{{$event.Description}}</p>{{end}}
              </li>
            {{end}}
          </ol>
        {{end}}
      </div>
    </div>
  {{end}}
</section>
{{end}}
