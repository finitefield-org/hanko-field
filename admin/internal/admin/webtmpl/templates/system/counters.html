{{define "system/counters"}}
{{template "layouts/base" .}}
{{end}}

{{define "system/counters-content"}}
{{$page := .Page}}
<div class="space-y-6" data-system-counters-root>
  <section class="rounded-2xl bg-white px-6 py-6 shadow-sm ring-1 ring-slate-200">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-2">
        <h1 class="text-2xl font-semibold text-slate-900">{{$page.Title}}</h1>
        <p class="text-sm text-slate-600">{{$page.Description}}</p>
        {{if $page.GeneratedLabel}}
          <p class="text-xs text-slate-400">{{$page.GeneratedLabel}}</p>
        {{end}}
      </div>
      {{template "system/counters-header-controls" $page}}
    </div>

    {{if gt (len $page.Alerts) 0}}
      <div class="mt-6 space-y-3">
        {{range $alert := $page.Alerts}}
          {{template "system/inline-alert" $alert}}
        {{end}}
      </div>
    {{end}}
  </section>

  <div class="grid gap-6 xl:grid-cols-[minmax(0,1fr)_360px]">
    <section>
      <div
        id="system-counters-table"
        data-system-counters-table
        class="space-y-4"
        hx-get="{{buildURL $page.Table.FragmentPath $page.Query.RawQuery}}"
        hx-target="this"
        hx-swap="outerHTML"
        hx-trigger="refresh from:body"
      >
        {{template "system/counters-table" (dict "Table" $page.Table "BasePath" $.BasePath "Query" $page.Query)}}
      </div>
    </section>
    <aside>
      <div class="sticky top-20 space-y-4">
        <div id="system-counter-drawer" data-system-counter-drawer>
          {{template "system/counters-drawer" (dict "Drawer" $page.Drawer "Query" $page.Query)}}
        </div>
      </div>
    </aside>
  </div>
</div>
{{end}}

{{define "system/counters-header-controls"}}
{{if eq (len .NamespaceSelector.Options) 0}}
  {{else}}
  <form
    class="flex w-full flex-col gap-3 rounded-xl border border-slate-200 bg-slate-50 p-4 shadow-sm sm:flex-row sm:items-end"
    method="get"
    action="{{.NamespaceSelector.Endpoint}}"
    hx-get="{{.NamespaceSelector.Endpoint}}"
    hx-target="#system-counters-table"
    hx-swap="outerHTML"
    hx-push-url="true"
  >
    <div class="flex w-full flex-col gap-2 sm:w-auto">
      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="counter-namespace">ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹</label>
      <select id="counter-namespace" name="namespace" class="rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200">
        {{range $option := .NamespaceSelector.Options}}
          <option value="{{$option.ID}}" {{if $option.Active}}selected{{end}}>
            {{$option.Label}}{{if $option.Sublabel}} ({{$option.Sublabel}}){{end}}
          </option>
        {{end}}
      </select>
    </div>
    <div class="flex w-full flex-col gap-2">
      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="counter-search">æ¤œç´¢</label>
      <input
        id="counter-search"
        name="q"
        type="search"
        placeholder="ã‚«ã‚¦ãƒ³ã‚¿åãƒ»èª¬æ˜ã§æ¤œç´¢"
        value="{{.Query.Search}}"
        class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
      />
    </div>
    <div class="flex flex-col gap-2 sm:w-32">
      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" aria-hidden="true">&nbsp;</label>
      <button type="submit" class="{{buttonClass "primary" "sm" true false}}">æ›´æ–°</button>
    </div>
    <input type="hidden" name="scope" value="{{.Query.Scope}}" />
    <input type="hidden" name="selected" value="{{.Query.Selected}}" />
  </form>
{{end}}
{{end}}

{{define "system/counters-table"}}
{{$table := .Table}}
<div class="rounded-2xl border border-slate-200 bg-white shadow-sm">
  {{if $table.Error}}
    <div class="border-b border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">{{$table.Error}}</div>
  {{end}}
  {{if eq (len $table.Items) 0}}
    <div class="px-6 py-12 text-center text-sm text-slate-500">{{$table.EmptyMessage}}</div>
  {{else}}
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
          <tr class="text-xs font-semibold uppercase tracking-wide text-slate-500">
            <th scope="col" class="px-4 py-3 text-left">ã‚«ã‚¦ãƒ³ã‚¿</th>
            <th scope="col" class="px-4 py-3 text-left">ã‚¹ã‚³ãƒ¼ãƒ—</th>
            <th scope="col" class="px-4 py-3 text-left">ç¾åœ¨å€¤</th>
            <th scope="col" class="px-4 py-3 text-left">ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ</th>
            <th scope="col" class="px-4 py-3 text-left">æœ€çµ‚æ›´æ–°</th>
            <th scope="col" class="px-4 py-3 text-right">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100" data-raw-query="{{$table.RawQuery}}">
          {{range $row := $table.Items}}
            <tr
              class="{{$row.RowClass}}"
              data-selected="{{boolAttr $row.Selected}}"
              hx-get="{{buildURL $row.DrawerURL (setRawQuery $table.RawQuery "selected" $row.Name)}}"
              hx-target="#system-counter-drawer"
              hx-swap="outerHTML"
              hx-push-url="{{buildURL (joinBase $.BasePath "/system/counters") (setRawQuery $table.RawQuery "selected" $row.Name)}}"
            >
              <td class="px-4 py-4 align-top">
                <div class="space-y-1">
                  <p class="text-sm font-semibold text-slate-900">{{$row.Label}}</p>
                  <p class="text-xs text-slate-500">{{printf "%s Â· %s" $row.Name $row.NamespaceLabel}}</p>
                  {{if gt (len $row.Tags) 0}}
                    <div class="flex flex-wrap gap-1">
                      {{range $tag := $row.Tags}}
                        <span class="rounded-md bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{{$tag}}</span>
                      {{end}}
                    </div>
                  {{end}}
                </div>
              </td>
              <td class="px-4 py-4 align-top text-sm text-slate-600">{{$row.ScopeLabel}}</td>
              <td class="px-4 py-4 align-top text-sm font-semibold text-slate-900">{{$row.CurrentValue}}</td>
              <td class="px-4 py-4 align-top text-sm text-slate-700">{{$row.Increment}}</td>
              <td class="px-4 py-4 align-top text-sm text-slate-600">
                <span title="{{$row.LastUpdatedTooltip}}">{{$row.LastUpdated}}</span>
              </td>
              <td class="px-4 py-4 align-top text-right">
                <button type="button" class="{{buttonClass "ghost" "xs" false false}}" data-copy="{{$row.Name}}">
                  <span aria-hidden="true">ğŸ“‹</span>
                  <span class="sr-only">ã‚³ãƒ”ãƒ¼</span>
                </button>
              </td>
            </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  {{end}}
</div>
{{end}}

{{define "system/counters-drawer"}}
{{$drawer := .Drawer}}
{{$query := .Query}}
{{if $drawer.Error}}
  <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-6 text-sm text-rose-700 shadow-sm">{{$drawer.Error}}</div>
{{else if $drawer.Empty}}
  <div class="rounded-2xl border border-dashed border-slate-200 bg-white px-6 py-10 text-center text-sm text-slate-500 shadow-sm">
    ã‚«ã‚¦ãƒ³ã‚¿ã‚’é¸æŠã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
  </div>
{{else}}
  <div class="space-y-5 rounded-2xl border border-slate-200 bg-white px-6 py-6 shadow-sm">
    <div class="space-y-2">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">{{printf "%s Â· %s" $drawer.Counter.NamespaceLabel $drawer.Counter.Name}}</p>
      <h2 class="text-xl font-semibold text-slate-900">{{$drawer.Counter.Label}}</h2>
      {{if $drawer.Counter.Description}}
        <p class="text-sm text-slate-600">{{$drawer.Counter.Description}}</p>
      {{end}}
      {{if $drawer.Counter.Alert}}
        {{template "system/inline-alert" $drawer.Counter.Alert}}
      {{end}}
      <dl class="mt-3 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-lg bg-slate-50 px-3 py-2">
          <dt class="text-xs text-slate-500">ç¾åœ¨å€¤</dt>
          <dd class="text-lg font-semibold text-slate-900">{{$drawer.Counter.CurrentValue}}</dd>
        </div>
        <div class="rounded-lg bg-slate-50 px-3 py-2">
          <dt class="text-xs text-slate-500">ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ</dt>
          <dd class="text-lg font-semibold text-slate-900">{{$drawer.Counter.Increment}}</dd>
        </div>
        <div class="rounded-lg bg-slate-50 px-3 py-2">
          <dt class="text-xs text-slate-500">æœ€çµ‚æ›´æ–°</dt>
          <dd class="text-sm text-slate-700">{{$drawer.Counter.LastUpdated}}</dd>
        </div>
        {{if $drawer.Counter.Owner}}
          <div class="rounded-lg bg-slate-50 px-3 py-2">
            <dt class="text-xs text-slate-500">æ‹…å½“</dt>
            <dd class="text-sm text-slate-700">{{$drawer.Counter.Owner}}</dd>
          </div>
        {{end}}
      </dl>
      {{if $drawer.Counter.ScopeKeys}}
        <p class="text-xs text-slate-500">ã‚¹ã‚³ãƒ¼ãƒ—ã‚­ãƒ¼: {{$drawer.Counter.ScopeKeys}}</p>
      {{end}}
      {{if gt (len $drawer.Counter.Tags) 0}}
        <div class="flex flex-wrap gap-1">
          {{range $tag := $drawer.Counter.Tags}}
            <span class="rounded-md bg-brand-50 px-2 py-0.5 text-xs text-brand-600">{{$tag}}</span>
          {{end}}
        </div>
      {{end}}
    </div>

    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-slate-900">æ¬¡ç•ªå·ãƒ†ã‚¹ãƒˆ</h3>
        {{if $drawer.Result.Visible}}
          <span class="{{badgeClass $drawer.Result.Tone}}">{{$drawer.Result.Message}} ({{$drawer.Result.Value}})</span>
        {{end}}
      </div>
      <form
        class="space-y-4"
        method="post"
        action="{{$drawer.Form.Action}}"
        hx-post="{{$drawer.Form.Action}}"
        hx-target="#system-counter-drawer"
        hx-swap="outerHTML"
      >
        <input type="hidden" name="namespace" value="{{$drawer.Form.Namespace}}" />
        <input type="hidden" name="selected" value="{{$drawer.Form.Name}}" />
        <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="counter-scope">ã‚¹ã‚³ãƒ¼ãƒ— (JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)</label>
        <textarea
          id="counter-scope"
          name="scope"
          rows="3"
          placeholder="{{$drawer.Form.ScopePlaceholder}}"
          spellcheck="false"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm font-mono text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
        >{{$drawer.Form.ScopeValue}}</textarea>
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600" for="counter-amount">å›æ•°</label>
            <input
              id="counter-amount"
              name="amount"
              type="number"
              step="1"
              class="w-24 rounded-lg border border-slate-300 px-2 py-1 text-sm text-slate-700 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200"
              value="{{$drawer.Form.Amount}}"
            />
          </div>
          <button type="submit" class="{{buttonClass "primary" "sm" false false}}">æ¬¡ã®ç•ªå·ã‚’å–å¾—</button>
        </div>
      </form>
    </section>

    <section class="space-y-2">
      <h3 class="text-sm font-semibold text-slate-900">æœ€è¿‘ã®æ“ä½œ</h3>
      {{if eq (len $drawer.History) 0}}
        <p class="text-xs text-slate-500">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      {{else}}
        <ul class="space-y-3">
          {{range $item := $drawer.History}}
            <li class="rounded-lg border border-slate-200 px-3 py-3 shadow-sm">
              <div class="flex items-center justify-between text-xs text-slate-500">
                <span>{{$item.Relative}}</span>
                <span>{{$item.Timestamp}}</span>
              </div>
              <p class="mt-1 text-sm font-semibold text-slate-900">{{$item.Message}}</p>
              <p class="text-xs text-slate-500">{{printf "Î”%s â†’ %s" $item.Delta $item.Value}}</p>
              {{if and $item.ScopeLabel (ne $item.ScopeLabel "-")}}
                <p class="text-xs text-slate-500">ã‚¹ã‚³ãƒ¼ãƒ—: {{$item.ScopeLabel}}</p>
              {{end}}
              <p class="text-xs text-slate-400">{{printf "%s Â· %s" $item.Actor $item.Source}}</p>
            </li>
          {{end}}
        </ul>
      {{end}}
    </section>

    <section class="space-y-2">
      <h3 class="text-sm font-semibold text-slate-900">é–¢é€£ã‚¸ãƒ§ãƒ–</h3>
      {{if eq (len $drawer.Jobs) 0}}
        <p class="text-xs text-slate-500">é–¢é€£ã‚¸ãƒ§ãƒ–ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {{else}}
        <ul class="space-y-2 text-sm">
          {{range $job := $drawer.Jobs}}
            <li class="rounded-lg border border-slate-200 px-3 py-3 shadow-sm">
              <div class="flex items-center justify-between">
                <a href="{{$job.URL}}" class="font-semibold text-brand-600 hover:text-brand-500">{{$job.Name}}</a>
                <span class="{{badgeClass $job.StatusTone}}">{{$job.StatusLabel}}</span>
              </div>
              {{if $job.Description}}
                <p class="mt-1 text-xs text-slate-500">{{$job.Description}}</p>
              {{end}}
              <p class="mt-1 text-xs text-slate-400">æœ€çµ‚å®Ÿè¡Œ {{$job.LastRun}}</p>
            </li>
          {{end}}
        </ul>
      {{end}}
    </section>

    {{if gt (len $drawer.Notes) 0}}
      <section class="space-y-2">
        <h3 class="text-sm font-semibold text-slate-900">é‹ç”¨ãƒ¡ãƒ¢</h3>
        <ul class="space-y-1 text-xs text-slate-500">
          {{range $note := $drawer.Notes}}
            <li class="rounded-lg bg-slate-50 px-3 py-2">{{$note}}</li>
          {{end}}
        </ul>
      </section>
    {{end}}
  </div>
{{end}}
{{end}}
